<!doctype html>
<html lang="en">

<head>
  <meta charset="utf-8" />
  <title>Learning Assistant Feedback</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root {
      --unl-red: #d0002d;
      --ink: #222;
      --muted: #555;
      --ring: #e4e4e7;
      --card: #fff;
      --bg: #f6f7fb;
      --ok: #16a34a;
      --bad: #b91c1c;
      --chip: #f1f5f9;
      --yellow: #fbbf24;
    }

    * {
      box-sizing: border-box
    }

    body {
      margin: 0;
      font-family: ui-sans-serif, system-ui, Segoe UI, Roboto, Helvetica, Arial;
      color: var(--ink);
      background: var(--bg)
    }

    .topbar {
      position: sticky;
      top: 0;
      z-index: 40;
      background: linear-gradient(135deg, var(--unl-red), #9d001f);
      color: #fff;
      padding: 14px 0
    }

    .shell {
      max-width: 1100px;
      margin: 0 auto;
      padding: 0 16px
    }

    .brand {
      font-weight: 800;
      letter-spacing: .3px
    }

    .sub {
      opacity: .85;
      font-size: .95rem
    }

    .nav {
      display: flex;
      gap: 10px;
      margin: 14px 0
    }

    .btn {
      background: var(--unl-red);
      color: #fff;
      border: none;
      border-radius: 10px;
      padding: 10px 14px;
      cursor: pointer
    }

    .btn:disabled {
      opacity: .5;
      cursor: not-allowed
    }

    .btn-ghost {
      background: #e5e7eb;
      color: #111
    }

    .btn-ghost.active {
      background: #fff;
      color: var(--unl-red);
      border: 1px solid var(--unl-red)
    }

    .wrap {
      background: var(--card);
      border: 1px solid var(--ring);
      border-radius: 14px;
      padding: 18px;
      margin-top: 16px;
      box-shadow: 0 6px 20px rgba(0, 0, 0, .06)
    }

    .grid {
      display: grid;
      gap: 14px
    }

    .g-2 {
      grid-template-columns: repeat(2, minmax(0, 1fr))
    }

    label {
      font-weight: 600;
      margin-bottom: 6px;
      display: block
    }

    input,
    select,
    textarea {
      width: 100%;
      padding: 10px;
      border: 1px solid var(--ring);
      border-radius: 10px;
      background: #fff;
      font-size: 16px
    }

    .alert {
      padding: 12px 14px;
      border-radius: 10px;
      margin: 12px 0;
      font-weight: 600
    }

    .alert-ok {
      background: #ecfdf5;
      color: #065f46;
      border: 1px solid #a7f3d0
    }

    .alert-bad {
      background: #fef2f2;
      color: #991b1b;
      border: 1px solid #fecaca
    }

    .hidden {
      display: none !important
    }

    .chips {
      display: flex;
      gap: 10px;
      flex-wrap: wrap
    }

    .chip {
      border: 1px solid #e5e7eb;
      background: #fff;
      padding: 8px 14px;
      border-radius: 999px;
      cursor: pointer
    }

    .chip.active {
      background: var(--unl-red);
      color: #fff;
      border-color: #fff
    }

    table {
      width: 100%;
      border-collapse: collapse
    }

    th,
    td {
      padding: 10px;
      border-bottom: 1px solid var(--ring);
      text-align: left
    }

    .badge {
      display: inline-block;
      background: var(--chip);
      padding: 4px 8px;
      border-radius: 999px;
      font-size: .85rem
    }

    .starbox {
      display: flex;
      gap: 10px;
      font-size: 24px;
      cursor: pointer
    }

    .star {
      color: #ddd
    }

    .star.on {
      color: var(--yellow)
    }

    .toolbar {
      display: flex;
      gap: 10px;
      align-items: center;
      justify-content: space-between;
      margin: 10px 0
    }

    .right {
      display: flex;
      gap: 10px;
      align-items: center
    }
  </style>
</head>

<body>

  <div class="topbar">
    <div class="shell">
      <div class="brand">Learning Assistant Feedback</div>
      <div class="sub">Computer Science & Engineering – University of Nebraska–Lincoln</div>
      <div class="nav">
        <button class="btn-ghost active" id="tabFeedback">Feedback</button>
        <button class="btn-ghost" id="tabHours">Office Hours</button>
        <button class="btn-ghost" id="tabLogin">Login</button>
        <span id="userBadge" class="badge hidden"></span>
        <button class="btn hidden" id="logoutBtn">Log out</button>
      </div>
    </div>
  </div>

  <main class="shell">

    <!-- Feedback -->
    <section id="panelFeedback" class="wrap">
      <h2>Submit Feedback</h2>
      <p>Share course or LA feedback. Submissions are stored in Supabase.</p>

      <div id="fbMsg" class="alert hidden"></div>

      <div class="grid g-2">
        <div>
          <label>Course</label>
          <select id="fbCourse">
            <option value="">(None)</option>
            <option>CSCE 101</option>
            <option>CSCE 155A</option>
            <option>CSCE 155E</option>
            <option>CSCE 155H</option>
            <option>CSCE 156</option>
          </select>
        </div>
        <div>
          <label>Type</label>
          <select id="fbType">
            <option>Website</option>
            <option>Staff</option>
            <option>Class</option>
            <option>Office Hours</option>
            <option>Random</option>
            <option>Other</option>
          </select>
        </div>
      </div>

      <div style="margin-top:10px">
        <label>Rating</label>
        <div class="starbox" id="fbStars" aria-label="Rating from 1 to 5">
          <span class="star" data-v="1">★</span>
          <span class="star" data-v="2">★</span>
          <span class="star" data-v="3">★</span>
          <span class="star" data-v="4">★</span>
          <span class="star" data-v="5">★</span>
        </div>
      </div>

      <div style="margin-top:10px">
        <label>Feedback</label>
        <textarea id="fbText" rows="4" placeholder="Write your feedback here..."></textarea>
      </div>

      <div class="grid g-2" style="margin-top:10px">
        <div>
          <label>Your name (optional)</label>
          <input id="fbSubmitter" placeholder="Jane Husker" />
        </div>
        <div>
          <label>Year (optional)</label>
          <select id="fbYear">
            <option value="">(None)</option>
            <option>Freshman</option>
            <option>Sophomore</option>
            <option>Junior</option>
            <option>Senior</option>
            <option>Graduate</option>
          </select>
        </div>
      </div>

      <div class="toolbar">
        <button class="btn" id="fbSend">Submit Feedback</button>
      </div>
    </section>

    <!-- Office Hours (public) + schedule CRUD for staff -->
    <section id="panelHours" class="wrap hidden">
      <h2>Office Hours</h2>
      <p>Browse office hours (from staff schedules). Staff can add, edit, and delete their own entries.</p>

      <div class="chips" id="courseChips">
        <span class="chip active" data-course="">All</span>
        <span class="chip" data-course="CSCE 101">CSCE 101</span>
        <span class="chip" data-course="CSCE 155A">CSCE 155A</span>
        <span class="chip" data-course="CSCE 155E">CSCE 155E</span>
        <span class="chip" data-course="CSCE 155H">CSCE 155H</span>
        <span class="chip" data-course="CSCE 156">CSCE 156</span>
      </div>

      <div class="wrap" style="margin-top:14px">
        <table id="hoursTable">
          <thead>
            <tr>
              <th>Staff</th>
              <th>Course</th>
              <th>Type</th>
              <th>Day</th>
              <th>Start</th>
              <th>End</th>
              <th>Location</th>
              <th></th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>

      <!-- My schedule editor (visible to logged-in staff) -->
      <div id="mySchedWrap" class="wrap hidden">
        <div class="toolbar">
          <h3 style="margin:0">My Schedule</h3>
          <button class="btn" id="btnNewSched">Add entry</button>
        </div>
        <table id="mySchedTable">
          <thead>
            <tr>
              <th>Course</th>
              <th>Type</th>
              <th>Day</th>
              <th>Start</th>
              <th>End</th>
              <th>Location</th>
              <th></th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>

        <div id="schedForm" class="wrap hidden" style="margin-top:10px">
          <h4 id="schedTitle">New entry</h4>
          <div class="grid g-2">
            <div>
              <label>Course</label>
              <select id="sfCourse">
                <option>CSCE 101</option>
                <option>CSCE 155A</option>
                <option>CSCE 155E</option>
                <option>CSCE 155H</option>
                <option>CSCE 156</option>
              </select>
            </div>
            <div>
              <label>Type</label>
              <select id="sfType">
                <option value="office_hour">Office Hour</option>
                <option value="lab_time">Lab Time</option>
              </select>
            </div>
            <div>
              <label>Day</label>
              <select id="sfDay">
                <option>Mon</option>
                <option>Tue</option>
                <option>Wed</option>
                <option>Thu</option>
                <option>Fri</option>
                <option>Sat</option>
                <option>Sun</option>
              </select>
            </div>
            <div>
              <label>Start</label>
              <input id="sfStart" placeholder="HH:MM" />
            </div>
            <div>
              <label>End</label>
              <input id="sfEnd" placeholder="HH:MM" />
            </div>
            <div>
              <label>Location</label>
              <input id="sfLoc" placeholder="Avery Hall 12 or Zoom" />
            </div>
          </div>
          <div class="toolbar">
            <div class="right">
              <button class="btn" id="sfSave">Save</button>
              <button class="btn-ghost" id="sfCancel">Cancel</button>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- Login & admin -->
    <section id="panelLogin" class="wrap hidden">
      <div id="loginMsg" class="alert hidden"></div>

      <h2>Sign in</h2>
      <div class="grid g-2">
        <div>
          <label>NUID or Email</label>
          <input id="loginLogin" placeholder="12345678 or user@huskers.unl.edu" />
        </div>
        <div>
          <label>Password</label>
          <input id="loginPassword" type="password" placeholder="Your password" />
        </div>
      </div>
      <div class="toolbar">
        <button class="btn" id="btnSignIn">Sign in</button>
        <button class="btn-ghost hidden" id="btnChangePw">Change password</button>
      </div>

      <details style="margin-top:8px">
        <summary>New student? Create an account</summary>
        <div class="wrap" style="margin-top:8px">
          <div id="stuMsg" class="alert hidden"></div>
          <div class="grid g-2">
            <div><label>Name</label><input id="stName" /></div>
            <div><label>Email (@huskers.unl.edu)</label><input id="stEmail" /></div>
            <div><label>Year</label>
              <select id="stYear">
                <option>Freshman</option>
                <option>Sophomore</option>
                <option>Junior</option>
                <option>Senior</option>
                <option>Graduate</option>
              </select>
            </div>
            <div><label>Class</label>
              <select id="stClass">
                <option>CSCE 101</option>
                <option>CSCE 155A</option>
                <option>CSCE 155E</option>
                <option>CSCE 155H</option>
                <option>CSCE 156</option>
              </select>
            </div>
            <div><label>Password</label><input id="stPw" type="password" /></div>
          </div>
          <div class="toolbar"><button class="btn" id="btnStuCreate">Request account</button></div>
        </div>
      </details>

      <!-- Staff-only tools -->
      <div id="staffPanel" class="hidden">
        <h2>Staff tools</h2>
        <p class="badge">Visible when logged in as staff</p>
        <button class="btn" id="btnLoadMine">Load my schedule</button>
      </div>

      <!-- SL-only tools -->
      <div id="slPanel" class="hidden">
        <h2>SL Admin</h2>

        <div class="wrap">
          <h3>Add staff</h3>
          <div id="slMsg" class="alert hidden"></div>
          <div class="grid g-2">
            <div><label>NUID</label><input id="slNUID" placeholder="12345678" /></div>
            <div><label>Name</label><input id="slName" /></div>
            <div><label>Email</label><input id="slEmail" placeholder="user@huskers.unl.edu (optional)" /></div>
            <div><label>Role</label>
              <select id="slRole">
                <option>LA</option>
                <option>CL</option>
                <option>SL</option>
              </select>
            </div>
            <div><label>Temp password</label><input id="slTemp" placeholder="ChangeMe!2025" /></div>
          </div>
          <div class="toolbar"><button class="btn" id="btnAddStaff">Add staff</button></div>
        </div>

        <div class="wrap">
          <h3>All staff</h3>
          <table id="slStaffTable">
            <thead>
              <tr>
                <th>NUID</th>
                <th>Name</th>
                <th>Email</th>
                <th>Role</th>
                <th></th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>

        <div class="wrap">
          <h3>Pending students</h3>
          <table id="slStudents">
            <thead>
              <tr>
                <th>Name</th>
                <th>Email</th>
                <th>Year</th>
                <th>Class</th>
                <th>Requested</th>
                <th></th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
    </section>
  </main>

  <!-- Scripts -->
  <script type="module" src="/routes/auth.js"></script>
  <script type="module" src="/routes/staff.js"></script>
  <script type="module" src="/routes/office-hours.js"></script>
  <script type="module" src="/feedback/feedback.js"></script>
  <script type="module">
    import { signIn, signOut, isLoggedIn, changePassword } from '/routes/auth.js';
    import { fetchOfficeHours, listMySchedule, upsertSchedule, deleteSchedule } from '/routes/office-hours.js';
    import { getMyProfile, addStaff, fetchCourses } from '/routes/staff.js';

    // ----- Tabs -----
    const panels = {
      Feedback: document.querySelector('#panelFeedback'),
      Hours: document.querySelector('#panelHours'),
      Login: document.querySelector('#panelLogin'),
    };
    const tabs = {
      Feedback: document.querySelector('#tabFeedback'),
      Hours: document.querySelector('#tabHours'),
      Login: document.querySelector('#tabLogin'),
    };
    function show(which) {
      for (const k of Object.keys(panels)) panels[k].classList.toggle('hidden', k !== which);
      for (const k of Object.keys(tabs)) tabs[k].classList.toggle('active', k === which);
    }
    tabs.Feedback.addEventListener('click', () => show('Feedback'));
    tabs.Hours.addEventListener('click', () => { show('Hours'); loadHours(); });
    tabs.Login.addEventListener('click', () => show('Login'));
    show('Feedback'); // default

    // ----- Login / auth UI -----
    const badge = document.querySelector('#userBadge');
    const logoutBtn = document.querySelector('#logoutBtn');
    const staffPanel = document.querySelector('#staffPanel');
    const slPanel = document.querySelector('#slPanel');
    const btnSignIn = document.querySelector('#btnSignIn');
    const loginInput = document.querySelector('#loginLogin');
    const pwInput = document.querySelector('#loginPassword');
    const btnChangePw = document.querySelector('#btnChangePw');
    const loginMsg = document.querySelector('#loginMsg');

    function setAuthUI(on, user) {
      badge.classList.toggle('hidden', !on);
      logoutBtn.classList.toggle('hidden', !on);
      btnChangePw.classList.toggle('hidden', !on);
      staffPanel.classList.toggle('hidden', !(on && ['SL', 'CL', 'LA'].includes(user?.role)));
      slPanel.classList.toggle('hidden', !(on && user?.role === 'SL'));
      badge.textContent = on ? `${user.name} (${user.role})` : '';
    }
    setAuthUI(false);

    btnSignIn.addEventListener('click', async () => {
      loginMsg.className = 'alert hidden';
      try {
        const user = await signIn(loginInput.value.trim(), pwInput.value);
        setAuthUI(true, user);
      } catch (e) {
        loginMsg.textContent = e.message || 'Login failed';
        loginMsg.className = 'alert alert-bad';
      }
    });

    logoutBtn.addEventListener('click', () => { signOut(); setAuthUI(false); });

    btnChangePw.addEventListener('click', async () => {
      const a = prompt('Current password?'); if (!a) return;
      const b = prompt('New password?'); if (!b) return;
      try { await changePassword(a, b); alert('Password changed.'); }
      catch (e) { alert(e.message || 'Failed to change password'); }
    });

    // ----- Feedback wiring (star rating & submit lives in /feedback/feedback.js) -----

    // ----- Office hours & schedule -----
    const chips = [...document.querySelectorAll('#courseChips .chip')];
    const hoursTbody = document.querySelector('#hoursTable tbody');

    chips.forEach(c => c.addEventListener('click', () => {
      chips.forEach(x => x.classList.remove('active'));
      c.classList.add('active');
      loadHours();
    }));

    async function loadHours() {
      const course = chips.find(x => x.classList.contains('active')).dataset.course || '';
      hoursTbody.innerHTML = '<tr><td colspan="8">Loading…</td></tr>';
      try {
        const rows = await fetchOfficeHours(course || null);
        if (!rows.length) {
          hoursTbody.innerHTML = '<tr><td colspan="8">No entries.</td></tr>';
        } else {
          hoursTbody.innerHTML = rows.map(r =>
            `<tr>
              <td>${r.staff_name}</td><td>${r.course_code || ''}</td>
              <td>${r.type === 'office_hour' ? 'Office Hour' : 'Lab Time'}</td>
              <td>${r.day}</td><td>${r.start_time}</td><td>${r.end_time}</td>
              <td>${r.location || ''}</td><td></td>
            </tr>`).join('');
        }
      } catch (e) {
        hoursTbody.innerHTML = `<tr><td colspan="8">Error: ${e.message}</td></tr>`;
      }
    }

    // My schedule editor
    const myWrap = document.querySelector('#mySchedWrap');
    const myBody = document.querySelector('#mySchedTable tbody');
    const btnLoadMine = document.querySelector('#btnLoadMine');
    const btnNew = document.querySelector('#btnNewSched');
    const form = document.querySelector('#schedForm');
    const title = document.querySelector('#schedTitle');
    const sfCourse = document.querySelector('#sfCourse');
    const sfType = document.querySelector('#sfType');
    const sfDay = document.querySelector('#sfDay');
    const sfStart = document.querySelector('#sfStart');
    const sfEnd = document.querySelector('#sfEnd');
    const sfLoc = document.querySelector('#sfLoc');
    const sfSave = document.querySelector('#sfSave');
    const sfCancel = document.querySelector('#sfCancel');

    let editing = null;

    btnLoadMine.addEventListener('click', async () => {
      myWrap.classList.remove('hidden');
      await renderMine();
    });
    btnNew.addEventListener('click', () => {
      editing = null;
      title.textContent = 'New entry';
      form.classList.remove('hidden');
      sfCourse.value = 'CSCE 101'; sfType.value = 'office_hour'; sfDay.value = 'Mon';
      sfStart.value = ''; sfEnd.value = ''; sfLoc.value = '';
    });
    sfCancel.addEventListener('click', () => form.classList.add('hidden'));

    sfSave.addEventListener('click', async () => {
      const payload = {
        id: editing?.id || undefined,
        course_code: sfCourse.value,
        type: sfType.value,
        day: sfDay.value,
        start_time: sfStart.value.trim(),
        end_time: sfEnd.value.trim(),
        location: sfLoc.value.trim() || null,
      };
      try {
        await upsertSchedule(payload);
        form.classList.add('hidden');
        await renderMine();
        await loadHours(); // refresh public list too
      } catch (e) {
        alert(e.message || 'Failed to save');
      }
    });

    async function renderMine() {
      const rows = await listMySchedule();
      if (!rows.length) {
        myBody.innerHTML = '<tr><td colspan="7">No entries yet.</td></tr>';
        return;
      }
      myBody.innerHTML = rows.map(r =>
        `<tr data-id="${r.id}">
          <td>${r.course_code}</td>
          <td>${r.type === 'office_hour' ? 'Office Hour' : 'Lab Time'}</td>
          <td>${r.day}</td>
          <td>${r.start_time}</td>
          <td>${r.end_time}</td>
          <td>${r.location || ''}</td>
          <td>
            <button class="btn-ghost btn-edit">Edit</button>
            <button class="btn-ghost btn-del">Delete</button>
          </td>
        </tr>`).join('');

      myBody.querySelectorAll('.btn-edit').forEach(b => b.addEventListener('click', () => {
        const tr = b.closest('tr');
        const id = Number(tr.dataset.id);
        const entry = rows.find(x => x.id === id);
        editing = entry;
        title.textContent = 'Edit entry';
        sfCourse.value = entry.course_code;
        sfType.value = entry.type;
        sfDay.value = entry.day;
        sfStart.value = entry.start_time;
        sfEnd.value = entry.end_time;
        sfLoc.value = entry.location || '';
        form.classList.remove('hidden');
      }));
      myBody.querySelectorAll('.btn-del').forEach(b => b.addEventListener('click', async () => {
        const tr = b.closest('tr');
        const id = Number(tr.dataset.id);
        if (!confirm('Delete this entry?')) return;
        try { await deleteSchedule(id); await renderMine(); await loadHours(); }
        catch (e) { alert(e.message || 'Delete failed'); }
      }));
    }

    // ----- SL admin lists -----
    const slStaffTable = document.querySelector('#slStaffTable tbody');
    const slStudents = document.querySelector('#slStudents tbody');
    const slNUID = document.querySelector('#slNUID');
    const slName = document.querySelector('#slName');
    const slEmail = document.querySelector('#slEmail');
    const slRole = document.querySelector('#slRole');
    const slTemp = document.querySelector('#slTemp');
    const btnAddStaff = document.querySelector('#btnAddStaff');
    const slMsg = document.querySelector('#slMsg');

    btnAddStaff.addEventListener('click', async () => {
      slMsg.className = 'alert hidden';
      try {
        await fetch('/api/staff', {
          method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({
            nuid: slNUID.value.trim(), name: slName.value.trim(), email: slEmail.value.trim() || null,
            role: slRole.value, tempPassword: slTemp.value.trim() || 'ChangeMe!2025'
          }), credentials: 'same-origin', headers: { ...{ 'Content-Type': 'application/json' }, ...authHeader() }
        });
        slMsg.textContent = 'Added staff.'; slMsg.className = 'alert alert-ok';
        await loadStaff();
      } catch (e) { slMsg.textContent = e.message || 'Failed'; slMsg.className = 'alert alert-bad'; }
    });

    function authHeader() {
      const t = localStorage.getItem('lap_jwt');
      return t ? { Authorization: `Bearer ${t}` } : {};
    }

    async function loadStaff() {
      if (slPanel.classList.contains('hidden')) return;
      const res = await fetch('/api/staff', { headers: authHeader() });
      if (!res.ok) { slStaffTable.innerHTML = '<tr><td colspan="5">Failed to load staff</td></tr>'; return; }
      const rows = await res.json();
      slStaffTable.innerHTML = rows.map(r => `<tr data-nuid="${r.nuid}">
        <td>${r.nuid}</td><td>${r.name}</td><td>${r.email || ''}</td><td>${r.role}</td>
        <td><button class="btn-ghost btn-rm">Remove</button></td>
      </tr>`).join('');
      slStaffTable.querySelectorAll('.btn-rm').forEach(b => b.addEventListener('click', async () => {
        const nuid = b.closest('tr').dataset.nuid;
        if (!confirm('Remove staff member?')) return;
        const r = await fetch(`/api/staff/${nuid}`, { method: 'DELETE', headers: authHeader() });
        if (r.ok) loadStaff(); else alert('Failed');
      }));
    }

    async function loadPending() {
      if (slPanel.classList.contains('hidden')) return;
      const r = await fetch('/api/students/pending', { headers: authHeader() });
      if (!r.ok) { slStudents.innerHTML = '<tr><td colspan="6">Failed</td></tr>'; return; }
      const rows = await r.json();
      if (!rows.length) { slStudents.innerHTML = '<tr><td colspan="6">None</td></tr>'; return; }
      slStudents.innerHTML = rows.map(s => `<tr data-id="${s.id}">
        <td>${s.name}</td><td>${s.email}</td><td>${s.year || ''}</td><td>${s.class_code || ''}</td><td>${new Date(s.created_at).toLocaleString()}</td>
        <td>
          <button class="btn-ghost btn-ap">Approve</button>
          <button class="btn-ghost btn-rm">Delete</button>
        </td>
      </tr>`).join('');
      slStudents.querySelectorAll('.btn-ap').forEach(b => b.addEventListener('click', async () => {
        const id = b.closest('tr').dataset.id;
        const r = await fetch(`/api/students/${id}/approve`, { method: 'POST', headers: authHeader() });
        if (r.ok) loadPending(); else alert('Failed');
      }));
      slStudents.querySelectorAll('.btn-rm').forEach(b => b.addEventListener('click', async () => {
        const id = b.closest('tr').dataset.id;
        if (!confirm('Delete request?')) return;
        const r = await fetch(`/api/students/${id}`, { method: 'DELETE', headers: authHeader() });
        if (r.ok) loadPending(); else alert('Failed');
      }));
    }

    // Student signup
    const stName = document.querySelector('#stName');
    const stEmail = document.querySelector('#stEmail');
    const stYear = document.querySelector('#stYear');
    const stClass = document.querySelector('#stClass');
    const stPw = document.querySelector('#stPw');
    const btnStuCreate = document.querySelector('#btnStuCreate');
    const stuMsg = document.querySelector('#stuMsg');

    btnStuCreate.addEventListener('click', async () => {
      stuMsg.className = 'alert hidden';
      try {
        const r = await fetch('/api/auth/register-student', {
          method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({
            name: stName.value.trim(), email: stEmail.value.trim(), year: stYear.value, class_code: stClass.value, password: stPw.value
          })
        });
        if (!r.ok) throw new Error((await r.json()).message || 'Failed');
        stuMsg.textContent = 'Submitted! SL will review & approve.'; stuMsg.className = 'alert alert-ok';
      } catch (e) { stuMsg.textContent = e.message || 'Failed'; stuMsg.className = 'alert alert-bad'; }
    });

    // load SL lists whenever SL panel becomes visible (e.g., after login)
    const observer = new MutationObserver(() => { if (!slPanel.classList.contains('hidden')) { loadStaff(); loadPending(); } });
    observer.observe(slPanel, { attributes: true, attributeFilter: ['class'] });
  </script>
</body>

</html>