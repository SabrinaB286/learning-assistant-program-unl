<!doctype html>
<html lang="en">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Learning Assistant Feedback • UNL</title>
  <style>
    :root {
      --unl-red: #c8102e;
      --unl-red-dark: #a00d25;
      --ink: #111827;
      --muted: #6b7280;
      --bg: #f5f6fa;
      --card: #fff;
      --ring: #e5e7eb;
      --shadow: 0 8px 24px rgba(17, 24, 39, .06);
      --star: #f59e0b
    }

    * {
      box-sizing: border-box
    }

    html,
    body {
      margin: 0;
      padding: 0
    }

    body {
      font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial;
      color: var(--ink);
      background: var(--bg)
    }

    .topbar {
      background: linear-gradient(135deg, var(--unl-red), var(--unl-red-dark));
      color: #fff;
      padding: 18px 0
    }

    .shell {
      max-width: 1100px;
      margin: 0 auto;
      padding: 0 16px
    }

    .brand {
      font-weight: 800;
      font-size: 1.25rem
    }

    .sub {
      opacity: .9
    }

    .navrow {
      display: flex;
      gap: 10px;
      align-items: center;
      justify-content: space-between;
      margin-top: 10px
    }

    .nav {
      display: flex;
      gap: 10px;
      align-items: center;
      flex-wrap: wrap
    }

    .btn {
      background: transparent;
      color: #fff;
      border: 1px solid rgba(255, 255, 255, .75);
      padding: 8px 14px;
      border-radius: 999px;
      cursor: pointer;
      font-weight: 600
    }

    .btn:hover,
    .btn.active {
      background: #fff;
      color: var(--unl-red)
    }

    #page-actions {
      margin-top: 8px;
      display: flex;
      gap: 10px
    }

    .chip {
      background: rgba(255, 255, 255, .14);
      padding: 6px 10px;
      border-radius: 999px
    }

    main {
      padding: 22px 0 40px
    }

    .card {
      background: var(--card);
      border: 1px solid var(--ring);
      border-radius: 16px;
      box-shadow: var(--shadow);
      padding: 20px;
      margin-top: 18px
    }

    h1,
    h2 {
      margin: 8px 0 12px
    }

    .lead {
      color: var(--muted)
    }

    .hidden {
      display: none !important
    }

    label {
      font-weight: 600
    }

    .grid {
      display: grid;
      gap: 14px
    }

    .g-2 {
      grid-template-columns: repeat(2, minmax(0, 1fr))
    }

    .g-3 {
      grid-template-columns: repeat(3, minmax(0, 1fr))
    }

    @media(max-width:860px) {

      .g-2,
      .g-3 {
        grid-template-columns: 1fr
      }
    }

    input,
    select,
    textarea {
      width: 100%;
      min-height: 44px;
      border: 1px solid var(--ring);
      border-radius: 10px;
      padding: 10px 12px
    }

    textarea {
      min-height: 120px
    }

    .actions {
      display: flex;
      gap: 10px;
      flex-wrap: wrap
    }

    .btn-primary {
      background: var(--unl-red);
      color: #fff;
      border: 1px solid var(--unl-red);
      padding: 10px 16px;
      border-radius: 10px;
      font-weight: 700;
      cursor: pointer
    }

    .btn-primary:hover {
      background: var(--unl-red-dark)
    }

    .btn-muted {
      background: #fff;
      color: #000;
      border: 1px solid var(--ring);
      padding: 10px 16px;
      border-radius: 10px;
      font-weight: 600
    }

    .pills {
      display: flex;
      gap: 8px;
      flex-wrap: wrap
    }

    .pill {
      background: #fff;
      border: 1px solid var(--ring);
      padding: 8px 14px;
      border-radius: 999px;
      cursor: pointer
    }

    .pill.active {
      background: var(--unl-red);
      color: #fff;
      border-color: var(--unl-red)
    }

    .stars {
      display: flex;
      gap: 6px
    }

    .star {
      font-size: 28px;
      cursor: pointer;
      color: #d3d6de
    }

    .star.active {
      color: var(--star)
    }

    .alert {
      padding: 12px;
      border-radius: 10px;
      font-weight: 600;
      margin: 8px 0
    }

    .alert-error {
      background: #fff1f2;
      color: #9f1239;
      border: 1px solid #fecdd3
    }

    .alert-success {
      background: #ecfdf5;
      color: #065f46;
      border: 1px solid #a7f3d0
    }

    .table {
      width: 100%;
      border-collapse: collapse
    }

    .table th,
    .table td {
      border-bottom: 1px solid var(--ring);
      padding: 10px 8px;
      text-align: left
    }

    .table th {
      color: var(--muted)
    }

    .link {
      color: var(--unl-red);
      cursor: pointer;
      font-weight: 700
    }

    .rowh {
      display: flex;
      gap: 10px;
      align-items: center;
      justify-content: space-between
    }
  </style>
</head>

<body>
  <header class="topbar">
    <div class="shell">
      <div class="rowh">
        <div>
          <div class="brand">Learning Assistant Feedback</div>
          <div class="sub">Computer Science &amp; Engineering — University of Nebraska–Lincoln</div>
        </div>
        <nav class="nav" style="justify-content:flex-start">
          <button class="btn active" data-nav="feedback">Feedback</button>
          <button class="btn" data-nav="office">Office Hours</button>
          <button id="dashboard-tab" class="btn hidden" data-nav="dashboard">Dashboard</button>
          <button id="login-tab" class="btn" data-nav="login">Login</button>
          <span id="user-chip" class="chip hidden"></span>
          <button id="logout-btn" class="btn hidden" style="margin-left:auto">Log out</button>
        </nav>
      </div>
    </div>
  </header>

  <main class="shell">
    <!-- FEEDBACK -->
    <section id="section-feedback" class="card">
      <h2>Submit Feedback</h2>
      <p class="lead">Share course or LA feedback. Submissions are stored in your API (or Supabase fallback).</p>

      <form id="feedback-form" class="grid" novalidate>
        <div class="grid g-2">
          <div>
            <label for="course">Course</label>
            <select id="course" name="course" required>
              <option value="">Select a course…</option>
              <option>CSCE 101</option>
              <option>CSCE 155A</option>
              <option>CSCE 155E</option>
              <option>CSCE 155H</option>
              <option>CSCE 156</option>
            </select>
          </div>
          <div>
            <label for="type">Type</label>
            <select id="type" name="type" required>
              <option value="">Select type…</option>
              <option>Website</option>
              <option>Staff</option>
              <option>Class</option>
              <option>Office Hours</option>
              <option>Random</option>
              <option>Other</option>
            </select>
          </div>
        </div>

        <div>
          <label>Rating</label>
          <div id="stars" class="stars">
            <span class="star" data-v="1">★</span><span class="star" data-v="2">★</span><span class="star"
              data-v="3">★</span><span class="star" data-v="4">★</span><span class="star" data-v="5">★</span>
          </div>
          <input type="hidden" id="rating" name="rating" value="0" />
        </div>

        <div><label for="text">Your feedback</label><textarea id="text" name="text"
            placeholder="Share details…"></textarea></div>

        <div id="fb-alert" class="alert hidden"></div>
        <div class="actions"><button id="fb-submit" type="submit" class="btn-primary">Submit feedback</button></div>
      </form>
    </section>

    <!-- OFFICE HOURS -->
    <section id="section-office" class="card hidden">
      <h2>Office Hours</h2>
      <p class="lead">Times, locations, and staff for each course.</p>

      <div class="pills" id="course-filter">
        <button class="pill active" type="button" data-course="ALL">All</button>
        <button class="pill" type="button" data-course="CSCE 101">CSCE 101</button>
        <button class="pill" type="button" data-course="CSCE 155A">CSCE 155A</button>
        <button class="pill" type="button" data-course="CSCE 155E">CSCE 155E</button>
        <button class="pill" type="button" data-course="CSCE 155H">CSCE 155H</button>
        <button class="pill" type="button" data-course="CSCE 156">CSCE 156</button>
      </div>

      <div id="office-alert" class="alert hidden"></div>
      <div id="office-list" class="grid"></div>
    </section>

    <!-- LOGIN -->
    <section id="section-login" class="card hidden">
      <h2>Sign in</h2>
      <p class="lead">Staff and students sign in with NUID (or @huskers.unl.edu) and password.</p>

      <div id="login-alert" class="alert hidden"></div>
      <form id="login-form" class="grid g-2" novalidate>
        <div><label for="login-input">NUID or Email</label><input id="login-input" name="login" type="text"
            placeholder="12345678 or user@huskers.unl.edu" autocomplete="username" required></div>
        <div><label for="password-input">Password</label><input id="password-input" name="password" type="password"
            autocomplete="current-password" required></div>
        <div class="actions"><button id="login-btn" type="submit" class="btn-primary">Sign in</button><button
            id="change-pass-btn" type="button" class="btn-muted">Change password</button></div>
      </form>
    </section>

    <!-- STAFF DASHBOARD -->
    <section id="section-dashboard" class="hidden">
      <div class="card">
        <h2>My Schedule</h2>
        <p class="lead">Add, edit, or remove your office hours.</p>
        <div id="sched-alert" class="alert hidden"></div>

        <form id="sched-form" class="grid g-3" novalidate>
          <div><label for="sched-course">Course</label>
            <select id="sched-course" required>
              <option value="">Select…</option>
              <option>CSCE 101</option>
              <option>CSCE 155A</option>
              <option>CSCE 155E</option>
              <option>CSCE 155H</option>
              <option>CSCE 156</option>
            </select>
          </div>
          <div><label for="sched-day">Day</label>
            <select id="sched-day" required>
              <option value="">Select…</option>
              <option>Mon</option>
              <option>Tue</option>
              <option>Wed</option>
              <option>Thu</option>
              <option>Fri</option>
            </select>
          </div>
          <div><label for="sched-location">Location</label><input id="sched-location" placeholder="Avery 12 / Zoom…">
          </div>
          <div><label for="sched-start">Start</label><input id="sched-start" type="time" required></div>
          <div><label for="sched-end">End</label><input id="sched-end" type="time" required></div>
          <div class="actions"><button id="sched-save" type="submit" class="btn-primary">Add to schedule</button></div>
        </form>

        <table class="table" id="sched-table" style="margin-top:10px">
          <thead>
            <tr>
              <th>Course</th>
              <th>Day</th>
              <th>Start</th>
              <th>End</th>
              <th>Location</th>
              <th></th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>

      <div id="my-feedback" class="card hidden">
        <h2>My Feedback</h2>
        <p class="lead">Feedback items for your assigned course(s).</p>
        <div id="myfb-alert" class="alert hidden"></div>
        <ul id="myfb-list"></ul>
      </div>

      <!-- SL Admin -->
      <div id="admin-block" class="card hidden">
        <h2>SL Admin</h2>
        <p class="lead">Manage staff and approve students.</p>

        <h3>Add staff</h3>
        <div id="staff-alert" class="alert hidden"></div>
        <form id="staff-form" class="grid g-3" novalidate>
          <div><label>NUID</label><input id="staff-nuid" placeholder="12345678" required></div>
          <div><label>Name</label><input id="staff-name" placeholder="First Last" required></div>
          <div><label>Email (@huskers.unl.edu)</label><input id="staff-email" placeholder="user@huskers.unl.edu"></div>
          <div><label>Role</label><select id="staff-role" required>
              <option value="">Select…</option>
              <option>SL</option>
              <option>CL</option>
              <option>LA</option>
            </select></div>
          <div class="actions"><button id="staff-add" class="btn-primary" type="submit">Add staff</button></div>
        </form>

        <h3 style="margin-top:16px">Staff list</h3>
        <div id="staff-empty" class="alert hidden"></div>
        <table class="table" id="staff-table">
          <thead>
            <tr>
              <th>NUID</th>
              <th>Name</th>
              <th>Email</th>
              <th>Role</th>
              <th>Course(s)</th>
              <th></th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>

        <h3 style="margin-top:16px">Pending students</h3>
        <div id="pending-alert" class="alert hidden"></div>
        <table class="table" id="pending-table">
          <thead>
            <tr>
              <th>Name</th>
              <th>NUID</th>
              <th>Email</th>
              <th>Course</th>
              <th></th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </section>
  </main>

  <!-- Supabase REST config & helpers -->
  <script>
    window.SUPABASE_URL = 'https://wmeijbsvlnjvnhptudfh.supabase.co';
    window.SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6IndtZWlqYnN2bG5qdm5ocHR1ZGZoIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTU4MDQ5NzksImV4cCI6MjA3MTM4MDk3OX0.YT_435s_FFsqNJs6M_yW9iIGzxeCu1BHpPVH1cwJlX8';
    function __sb() {
      const url = (window.SUPABASE_URL || '').replace(/\/+$/, '');
      const key = window.SUPABASE_ANON_KEY;
      if (!url || !key) throw new Error('Missing Supabase env');
      const headers = { apikey: key, Authorization: `Bearer ${key}`, Accept: 'application/json' };
      return { url, key, headers };
    }
    async function sbFetch(path, opts = {}) {
      const { url, headers } = __sb();
      const h = { ...headers, ...(opts.headers || {}) };
      return fetch(url + path, { ...opts, headers: h });
    }
  </script>

  <script>
    /* ---------- tiny helpers ---------- */
    const $ = (s, r = document) => r.querySelector(s), $$ = (s, r = document) => Array.from(r.querySelectorAll(s));
    const show = id => {
      ['feedback', 'office', 'login', 'dashboard'].forEach(k => $('#section-' + k).classList.toggle('hidden', k !== id));
      $$('[data-nav]').forEach(b => b.classList.toggle('active', b.dataset.nav === id));
      history.replaceState(null, '', '#' + id);
    };
    // left nav
    $$('[data-nav]').forEach(b => b.addEventListener('click', () => show(b.dataset.nav)));
    // ALWAYS start on Feedback
    show('feedback');

    // Fetch wrapper that tries API and non-API path; returns last 404 rather than throwing
    const tryFetch = async (method, paths, body) => {
      let lastRes = null, lastJson = null;
      for (const p of paths) {
        try {
          const res = await fetch(p, {
            method, credentials: 'include',
            headers: body ? { 'Content-Type': 'application/json' } :
              undefined,
            body: body ? JSON.stringify(body) : undefined
          });
          lastRes = res;
          try { lastJson = await res.clone().json() } catch { lastJson = null }
          if (res.ok) return { res, json: lastJson };
        } catch (e) { lastRes = null; lastJson = null; }
      }
      return { res: lastRes, json: lastJson };
    };

    /* ---------- state ---------- */
    const state = { user: null, role: null };

    /* ---------- Office Hours (API first) ---------- */
    (function () {
      const list = $('#office-list'); if (!list) return;
      const alert = $('#office-alert'); let ALL = [];
      const render = rows => {
        list.innerHTML = '';
        if (!rows.length) { alert.className = 'alert alert-error'; alert.textContent = 'No office hours to show.'; alert.classList.remove('hidden'); return; }
        alert.classList.add('hidden');
        rows.forEach(r => {
          const div = document.createElement('div'); div.className = 'card';
          const canJoin = state.user && state.role === 'student' && (state.user.course === r.course || (state.user?.course && state.user.course === r.course));
          div.innerHTML = `<div class="grid g-2" style="align-items:center">
            <div>
              <div style="font-weight:700">${r.course} • ${r.day} ${r.start}–${r.end}</div>
              <div class="sub">Location: ${r.location || 'TBA'} &nbsp; <span class="tag">${r.staff_name || 'Staff'}</span></div>
            </div>
          </div>`;
          list.appendChild(div);
        });
      };
      const load = async () => { const { json } = await tryFetch('GET', ['/api/office-hours', '/office-hours']); ALL = Array.isArray(json) ? json : []; render(ALL); };
      load();
      $$('#course-filter .pill').forEach(p => p.addEventListener('click', () => {
        $$('#course-filter .pill').forEach(x => x.classList.toggle('active', x === p));
        const c = p.dataset.course; render(c === 'ALL' ? ALL : ALL.filter(x => x.course === c));
      }));
    })();

    /* ---------- Login / Logout ---------- */
    (function () {
      const form = $('#login-form'); if (!form) return;
      const alert = $('#login-alert'), userChip = $('#user-chip'), logoutBtn = $('#logout-btn'), loginTab = $('#login-tab'), dashTab = $('#dashboard-tab');

      const ok = m => { alert.className = 'alert alert-success'; alert.textContent = m; alert.classList.remove('hidden') };
      const bad = m => { alert.className = 'alert alert-error'; alert.textContent = m; alert.classList.remove('hidden') };

      // Enter submits (native), button wired via submit handler
      form.addEventListener('submit', async e => {
        e.preventDefault(); alert.classList.add('hidden'); alert.textContent = '';
        const login = $('#login-input').value.trim(), password = $('#password-input').value;
        if (!login || !password) return bad('Missing login or password');

        const { res, json } = await tryFetch('POST', ['/api/auth/login', '/auth/login'], { login, password });
        if (!res) return bad('Login request failed. Check your API route.');
        if (!res.ok) return bad(json?.message || 'Invalid credentials');

        // expect JSON with {name,email,role,course,...}
        state.user = json || {}; state.role = (json?.role || '').toLowerCase();
        const who = json?.name || json?.email || login; userChip.textContent = who + (json?.role ? ` (${json.role})` : '');
        userChip.classList.remove('hidden'); logoutBtn.classList.remove('hidden'); loginTab.classList.add('hidden');

        const isStaff = ['sl', 'cl', 'la'].includes(state.role);
        dashTab.classList.toggle('hidden', !isStaff);

        if (isStaff) { show('dashboard'); loadSchedule(); if (state.role === 'sl') loadAdmin(); }
        else { show('feedback'); }
      });

      logoutBtn.addEventListener('click', async () => {
        try { await fetch('/api/auth/logout', { method: 'POST', credentials: 'include' }) } catch { }
        userChip.classList.add('hidden'); logoutBtn.classList.add('hidden'); loginTab.classList.remove('hidden');
        state.user = null; state.role = null; show('feedback');
      });

      // password change (optional endpoint)
      $('#change-pass-btn')?.addEventListener('click', async () => {
        const login = $('#login-input').value.trim(); if (!login) return bad('Enter your NUID or email first.');
        const { res, json } = await tryFetch('POST', ['/api/auth/change-password', '/auth/change-password'], { login });
        if (res?.ok) ok(json?.message || 'If your account exists, a change password link has been sent.');
        else bad(json?.message || 'Could not start password change.');
      });
    })();

    /* ---------- Feedback submit (API first, Supabase fallback) ---------- */
    (function () {
      const form = $('#feedback-form'); if (!form) return;
      const alert = $('#fb-alert');
      const ok = m => { alert.className = 'alert alert-success'; alert.textContent = m; alert.classList.remove('hidden') };
      const bad = m => { alert.className = 'alert alert-error'; alert.textContent = m; alert.classList.remove('hidden') };

      // rating stars
      (function () {
        const stars = $$('#stars .star'), hidden = $('#rating'); if (!hidden) return;
        const paint = n => stars.forEach(s => s.classList.toggle('active', Number(s.dataset.v) <= n));
        stars.forEach(s => {
          s.addEventListener('mouseenter', () => paint(Number(s.dataset.v)));
          s.addEventListener('mouseleave', () => paint(Number(hidden.value || 0)));
          s.addEventListener('click', () => { hidden.value = s.dataset.v; paint(Number(hidden.value)) });
        });
      })();

      form.addEventListener('submit', async e => {
        e.preventDefault(); alert.classList.add('hidden'); alert.textContent = '';
        const payload = {
          course: $('#course').value, type: $('#type').value,
          rating: Number($('#rating').value || 0) || null,
          text: $('#text').value || null
        };
        if (!payload.course || !payload.type) return bad('Please choose course and type.');

        // 1) API
        try {
          const { res } = await tryFetch('POST', ['/api/feedback', '/feedback'], payload);
          if (res?.ok) { form.reset(); $('#rating').value = '0'; return ok('Thanks for your feedback!'); }
        } catch { }

        // 2) Supabase fallback: insert into feedback
        try {
          const r = await sbFetch('/rest/v1/feedback', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'Prefer': 'return=representation' },
            body: JSON.stringify([payload])
          });
          if (!r.ok) {
            let j = null; try { j = await r.json() } catch { }
            throw new Error(j?.message || 'insert failed');
          }
          form.reset(); $('#rating').value = '0'; ok('Thanks for your feedback!');
        } catch (e) { bad(`Could not submit: ${e?.message || 'unknown error'}`) }
      });
    })();

    /* ---------- Schedule table loader (API first) ---------- */
    async function loadSchedule() {
      const tableBody = $('#sched-table tbody'); if (!tableBody) return; tableBody.innerHTML = '';
      const alert = $('#sched-alert');
      const ok = m => { alert.className = 'alert alert-success'; alert.textContent = m; alert.classList.remove('hidden') };
      const bad = m => { alert.className = 'alert alert-error'; alert.textContent = m; alert.classList.remove('hidden') };

      // API
      let rows = [];
      try {
        const { res, json } = await tryFetch('GET', ['/api/staff/schedule', '/api/schedule/mine', '/api/schedule']);
        if (res?.ok) rows = Array.isArray(json) ? json : (Array.isArray(json?.items) ? json.items : []);
      } catch { rows = [] }

      if (!rows || !rows.length) {
        ok('You have no office hours yet. Use the form above to add your first block.');
      } else {
        alert.classList.add('hidden');
      }

      rows.forEach(row => {
        row = {
          id: row.id,
          course: row.course || row.course_code || '',
          day: row.day || row.day_of_week || '',
          start: row.start || row.start_time || '',
          end: row.end || row.end_time || '',
          location: row.location || ''
        };
        const tr = document.createElement('tr');
        tr.innerHTML = `<td>${row.course}</td><td>${row.day}</td><td>${row.start}</td><td>${row.end}</td><td>${row.location}</td>
          <td class="row-actions">
            <span class="link" data-edit="${row.id}">Edit</span>
            <span class="link" data-del="${row.id}">Delete</span>
          </td>`;
        tableBody.appendChild(tr);
      });
      // delete
      $$('[data-del]').forEach(a => a.addEventListener('click', async () => {
        const id = a.getAttribute('data-del'); a.textContent = 'Deleting…'; a.style.pointerEvents = 'none';
        const { res } = await tryFetch('DELETE', [`/api/staff/schedule/${id}`]); if (res?.ok) { loadSchedule() } else { a.textContent = 'Delete'; a.style.pointerEvents = 'auto'; }
      }));
      // edit (simple: prefill form and upon save PUT)
      $$('[data-edit]').forEach(a => a.addEventListener('click', () => {
        const tr = a.closest('tr'); $('#sched-course').value = tr.children[0].textContent;
        $('#sched-day').value = tr.children[1].textContent; $('#sched-start').value = tr.children[2].textContent;
        $('#sched-end').value = tr.children[3].textContent; $('#sched-location').value = tr.children[4].textContent;
        $('#sched-save').dataset.editId = a.getAttribute('data-edit'); $('#sched-save').textContent = 'Save changes';
        window.scrollTo({ top: $('#section-dashboard').offsetTop - 10, behavior: 'smooth' });
      }));
    }
    (function () {
      const form = $('#sched-form'); if (!form) return; const btn = $('#sched-save'); const alert = $('#sched-alert');
      const ok = m => { alert.className = 'alert alert-success'; alert.textContent = m; alert.classList.remove('hidden') };
      const bad = m => { alert.className = 'alert alert-error'; alert.textContent = m; alert.classList.remove('hidden') };

      form.addEventListener('submit', async e => {
        e.preventDefault(); alert.classList.add('hidden');
        const payload = {
          course: $('#sched-course').value, day: $('#sched-day').value,
          start: $('#sched-start').value, end: $('#sched-end').value,
          location: $('#sched-location').value || ''
        };
        if (!payload.course || !payload.day || !payload.start || !payload.end) return bad('Please complete all required fields.');
        const editId = btn.dataset.editId || null;

        const url = editId ? `/api/staff/schedule/${encodeURIComponent(editId)}` : `/api/staff/schedule`;
        const method = editId ? 'PUT' : 'POST';
        const { res, json } = await tryFetch(method, [url], payload);
        if (res?.ok) {
          btn.textContent = 'Add to schedule'; delete btn.dataset.editId; form.reset(); loadSchedule();
          return ok(editId ? 'Schedule updated.' : 'Block added.');
        } else {
          bad(json?.message || 'Could not save using the API.');
        }
      });
    })();

    /* ---------- Admin (API only; Supabase fallback added separately) ---------- */
    function loadAdmin() {
      $('#admin-block').classList.remove('hidden');
      // staff list
      (async () => {
        const body = $('#staff-table tbody'); body.innerHTML = '';
        const { res, json } = await tryFetch('GET', ['/api/admin/staff']);
        (json || []).forEach(s => {
          const tr = document.createElement('tr');
          tr.innerHTML = `<td>${s.nuid}</td><td>${s.name || ''}</td><td>${s.email || ''}</td><td>${s.role || ''}</td><td>${s.course || ''}</td>
            <td><span class="link" data-rm="${s.nuid}">Remove</span></td>`;
          body.appendChild(tr);
        });
        $$('[data-rm]').forEach(a => a.addEventListener('click', async () => {
          const nuid = a.getAttribute('data-rm'); a.textContent = 'Removing…'; a.style.pointerEvents = 'none';
          const { res } = await tryFetch('DELETE', [`/api/admin/staff/${nuid}`]); if (res?.ok) loadAdmin();
        }));
      })();
      // pending students
      (async () => {
        const body = $('#pending-table tbody'); body.innerHTML = '';
        const { res, json } = await tryFetch('GET', ['/api/admin/students/pending']);
        (json || []).forEach(s => {
          const tr = document.createElement('tr');
          tr.innerHTML = `<td>${s.name || ''}</td><td>${s.nuid || ''}</td><td>${s.email || ''}</td><td>${s.course || ''}</td>
            <td class="row-actions">
              <span class="link" data-approve="${s.id}">Approve</span>
              <span class="link" data-reject="${s.id}">Reject</span>
            </td>`;
          body.appendChild(tr);
        });
        $$('[data-approve]').forEach(a => a.addEventListener('click', async () => {
          const id = a.getAttribute('data-approve'); a.textContent = 'Approving…'; a.style.pointerEvents = 'none';
          const { res } = await tryFetch('POST', [`/api/admin/students/${id}/approve`], {}); if (res?.ok) loadAdmin();
        }));
        $$('[data-reject]').forEach(a => a.addEventListener('click', async () => {
          const id = a.getAttribute('data-reject'); a.textContent = 'Rejecting…'; a.style.pointerEvents = 'none';
          const { res } = await tryFetch('POST', [`/api/admin/students/${id}/reject`], {}); if (res?.ok) loadAdmin();
        }));
      })();

      // add staff form
      (function () {
        const form = $('#staff-form'), alert = $('#staff-alert'); if (!form) return;
        const ok = m => { alert.className = 'alert alert-success'; alert.textContent = m; alert.classList.remove('hidden') };
        const bad = m => { alert.className = 'alert alert-error'; alert.textContent = m; alert.classList.remove('hidden') };
        form.addEventListener('submit', async e => {
          e.preventDefault(); alert.classList.add('hidden');
          const payload = {
            nuid: $('#staff-nuid').value.trim(), name: $('#staff-name').value.trim(),
            email: $('#staff-email').value.trim(), role: $('#staff-role').value
          };
          if (!payload.nuid || !payload.name || !payload.role) return bad('NUID, name, and role are required.');
          const { res, json } = await tryFetch('POST', ['/api/admin/staff'], payload);
          if (res?.ok) { form.reset(); loadAdmin(); ok('Staff added.'); }
          else bad(json?.message || 'Could not add staff');
        });
      })();
    }
  </script>

  <!-- Supabase fallbacks (non-invasive) -->
  <script>
    // Office hours fallback if API returned nothing
    (function () {
      const list = document.querySelector('#office-list');
      const alert = document.querySelector('#office-alert');
      if (!list) return;
      // Run shortly after initial loader
      setTimeout(async () => {
        const hasItems = list.children && list.children.length > 0;
        if (hasItems) return; // API already filled
        try {
          // Try RPC first
          let rows = [];
          try {
            const r = await sbFetch('/rest/v1/rpc/office_hours_public_list', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: '{}' });
            if (r.ok) rows = await r.json();
          } catch { }
          if (!rows || !rows.length) {
            // fallback to staff_schedules + staff names
            try {
              const r1 = await sbFetch('/rest/v1/staff_schedules?select=id,nuid,course_code,day,start_time,end_time,location&order=day.asc');
              const sched = r1.ok ? await r1.json() : [];
              const nuids = [...new Set(sched.map(s => s.nuid).filter(Boolean))];
              let nameMap = {};
              if (nuids.length) {
                const or = nuids.map(n => `nuid.eq.${encodeURIComponent(n)}`).join(',');
                const r2 = await sbFetch(`/rest/v1/staff?select=nuid,name&or=(${or})`);
                const staff = r2.ok ? await r2.json() : [];
                nameMap = Object.fromEntries(staff.map(s => [String(s.nuid), s.name]));
              }
              rows = sched.map(s => ({ course: s.course_code, day: s.day, start: s.start_time, end: s.end_time, location: s.location, staff_name: nameMap[String(s.nuid)] || '' }));
            } catch { }
          }
          if (rows && rows.length) {
            alert && alert.classList.add('hidden');
            list.innerHTML = '';
            rows.forEach(r => {
              const div = document.createElement('div'); div.className = 'card';
              div.innerHTML = `<div class="grid g-2" style="align-items:center">
              <div>
                <div style="font-weight:700">${r.course || ''} • ${r.day || ''} ${r.start || ''}–${r.end || ''}</div>
                <div class="sub">Location: ${r.location || 'TBA'} &nbsp; <span class="tag">${r.staff_name || 'Staff'}</span></div>
              </div>
            </div>`;
              list.appendChild(div);
            });
          }
        } catch (e) { console.warn('Supabase office hours fallback failed', e); }
      }, 400);
    })();
  </script>

  <!-- Admin staff fallback wrapper -->
  <script>
    (function () {
      const origLoad = window.loadAdmin;
      window.loadAdmin = function () {
        try { if (typeof origLoad === 'function') origLoad(); } catch (e) { }
        // supplement via Supabase if table is empty after API
        setTimeout(async () => {
          const body = document.querySelector('#staff-table tbody');
          if (!body || body.children.length) return;
          try {
            // fetch staff via Supabase (RPC -> view -> table)
            let rows = [];
            try { let r = await sbFetch('/rest/v1/rpc/staff_public_list', { method: 'POST' }); if (r.ok) rows = await r.json(); } catch { }
            if (!rows || !rows.length) {
              try { let r = await sbFetch('/rest/v1/staff_public?select=nuid,name,email,role,courses,is_active&order=name.asc'); if (r.ok) rows = await r.json(); } catch { }
            }
            if (!rows || !rows.length) {
              try { let r = await sbFetch('/rest/v1/staff?select=nuid,name,email,role,courses,is_active&is_active=is.true&order=name.asc'); if (r.ok) rows = await r.json(); } catch { }
            }
            if (rows && rows.length) {
              body.innerHTML = '';
              rows.forEach(s => {
                const courses = Array.isArray(s.courses) ? s.courses.join(', ') : (s.course || '');
                const tr = document.createElement('tr');
                tr.innerHTML = `<td>${s.nuid || ''}</td><td>${s.name || ''}</td><td>${s.email || ''}</td><td>${(s.role || '').toString().toUpperCase()}</td><td>${courses}</td>`;
                body.appendChild(tr);
              });
            }
          } catch (e) { console.warn('Supabase staff fallback failed', e); }
        }, 400);
      };
    })();
  </script>
</body>

</html>