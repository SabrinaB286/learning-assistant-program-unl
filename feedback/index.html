<!doctype html>
<html lang="en">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Learning Assistant Feedback • UNL</title>
  <style>
    :root {
      --unl-red: #c8102e;
      --unl-red-dark: #a00d25;
      --ink: #111827;
      --muted: #6b7280;
      --bg: #f5f6fa;
      --card: #fff;
      --ring: #e5e7eb;
      --shadow: 0 8px 24px rgba(17, 24, 39, .06);
      --star: #f59e0b
    }

    * {
      box-sizing: border-box
    }

    html,
    body {
      margin: 0;
      padding: 0
    }

    body {
      font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
      color: var(--ink);
      background: var(--bg)
    }

    .topbar {
      background: linear-gradient(135deg, var(--unl-red), var(--unl-red-dark));
      color: #fff;
      padding: 18px 0;
      border-bottom: 1px solid rgba(255, 255, 255, .15)
    }

    .shell {
      max-width: 1100px;
      margin: 0 auto;
      padding: 0 16px
    }

    .brand {
      font-weight: 800;
      font-size: 1.25rem
    }

    .sub {
      opacity: .9
    }

    .navrow {
      display: flex;
      gap: 10px;
      align-items: center;
      justify-content: space-between;
      margin-top: 10px
    }

    .nav {
      display: flex;
      gap: 10px;
      align-items: center;
      flex-wrap: wrap
    }

    .btn {
      background: transparent;
      color: #fff;
      border: 1px solid rgba(255, 255, 255, .75);
      padding: 8px 14px;
      border-radius: 999px;
      cursor: pointer;
      font-weight: 600
    }

    .btn:hover,
    .btn.active {
      background: #fff;
      color: var(--unl-red)
    }

    #page-actions {
      margin-top: 8px;
      display: flex;
      gap: 10px;
      align-items: center;
      flex-wrap: wrap
    }

    .chip {
      background: rgba(255, 255, 255, .14);
      padding: 6px 10px;
      border-radius: 999px
    }

    main {
      padding: 22px 0 40px
    }

    .card {
      background: var(--card);
      border: 1px solid var(--ring);
      border-radius: 16px;
      box-shadow: var(--shadow);
      padding: 20px;
      margin-top: 18px
    }

    h1,
    h2 {
      margin: 8px 0 12px
    }

    .lead {
      color: var(--muted);
      margin-top: 0
    }

    .hidden {
      display: none !important
    }

    label {
      font-weight: 600
    }

    .grid {
      display: grid;
      gap: 14px
    }

    .g-2 {
      grid-template-columns: repeat(2, minmax(0, 1fr))
    }

    .g-3 {
      grid-template-columns: repeat(3, minmax(0, 1fr))
    }

    @media(max-width:980px) {
      .g-3 {
        grid-template-columns: 1fr
      }
    }

    @media(max-width:860px) {
      .g-2 {
        grid-template-columns: 1fr
      }
    }

    input,
    select,
    textarea {
      width: 100%;
      min-height: 44px;
      border: 1px solid var(--ring);
      border-radius: 10px;
      padding: 10px 12px;
      background: #fff;
      color: var(--ink)
    }

    input::placeholder,
    textarea::placeholder {
      color: #9ca3af
    }

    textarea {
      min-height: 120px
    }

    .actions {
      display: flex;
      gap: 10px;
      align-items: center;
      flex-wrap: wrap
    }

    .btn-primary {
      background: var(--unl-red);
      color: #fff;
      border: 1px solid var(--unl-red);
      padding: 10px 16px;
      border-radius: 10px;
      font-weight: 700;
      cursor: pointer
    }

    .btn-primary:hover {
      background: var(--unl-red-dark)
    }

    .btn-muted {
      background: #fff;
      color: #000;
      border: 1px solid var(--ring);
      padding: 10px 16px;
      border-radius: 10px;
      font-weight: 600;
      cursor: pointer
    }

    .pills {
      display: flex;
      gap: 8px;
      flex-wrap: wrap
    }

    .pill {
      background: #fff;
      border: 1px solid var(--ring);
      color: var(--ink);
      padding: 8px 14px;
      border-radius: 999px;
      cursor: pointer;
      font-weight: 600
    }

    .pill.active {
      background: var(--unl-red);
      color: #fff;
      border-color: var(--unl-red)
    }

    .stars {
      display: flex;
      gap: 6px;
      align-items: center
    }

    .star {
      font-size: 28px;
      cursor: pointer;
      color: #d3d6de;
      line-height: 1
    }

    .star.active {
      color: var(--star)
    }

    .alert {
      padding: 12px 14px;
      border-radius: 10px;
      font-weight: 600;
      margin: 8px 0
    }

    .alert-error {
      background: #fff1f2;
      color: #9f1239;
      border: 1px solid #fecdd3
    }

    .alert-success {
      background: #ecfdf5;
      color: #065f46;
      border: 1px solid #a7f3d0
    }

    .tag {
      display: inline-block;
      background: #eef2ff;
      color: #3730a3;
      padding: 2px 8px;
      border-radius: 999px;
      font-size: .825rem
    }

    .table {
      width: 100%;
      border-collapse: collapse
    }

    .table th,
    .table td {
      border-bottom: 1px solid var(--ring);
      padding: 10px 8px;
      text-align: left
    }

    .table th {
      color: var(--muted);
      font-weight: 700
    }

    .row-actions {
      display: flex;
      gap: 8px
    }

    .link {
      color: var(--unl-red);
      cursor: pointer;
      font-weight: 700
    }
  </style>

  <script>
    (function () {
      const PAGES = ['feedback', 'office', 'login', 'dashboard'];
      const $ = (s, r = document) => r.querySelector(s), $$ = (s, r = document) => Array.from(r.querySelectorAll(s));
      function show(id) { try { if (!PAGES.includes(id)) id = 'feedback'; PAGES.forEach(k => { const el = $('#section-' + k); if (el) el.classList.toggle('hidden', k !== id) }); $$('[data-nav]').forEach(b => b.classList.toggle('active', b?.dataset?.nav === id)); if (location.hash !== '#' + id) history.replaceState(null, '', '#' + id); } catch (e) { console.error('show failed', e) } }
      window.__lap_show = show;
      function bind() { $$('[data-nav]').forEach(b => { if (b.__bound) return; b.__bound = true; b.addEventListener('click', () => show(b.dataset.nav), { passive: true }) }) }
      window.addEventListener('DOMContentLoaded', () => { bind(); const initial = (location.hash || '').replace('#', ''); show(PAGES.includes(initial) ? initial : 'feedback') });
      window.addEventListener('hashchange', () => { const h = (location.hash || '').replace('#', ''); show(h) });
    })();
  </script>
</head>

<body>
  <header class="topbar">
    <div class="shell">
      <div>
        <div class="brand">Learning Assistant Feedback</div>
        <div class="sub">Computer Science &amp; Engineering — University of Nebraska–Lincoln</div>
        <div id="page-actions"><span id="lap-user-greeting" class="chip hidden" aria-live="polite"></span></div>
        <div class="navrow">
          <nav class="nav">
            <button class="btn" type="button" data-nav="feedback" onclick="__lap_show('feedback')">Feedback</button>
            <button class="btn" type="button" data-nav="office" onclick="__lap_show('office')">Office Hours</button>
            <button id="dashboard-tab" class="btn hidden" type="button" data-nav="dashboard"
              onclick="__lap_show('dashboard')">Dashboard</button>
            <button id="login-tab" class="btn" type="button" data-nav="login"
              onclick="__lap_show('login')">Login</button>
          </nav>
          <button id="logout-btn" class="btn hidden" type="button">Log out</button>
        </div>
      </div>
    </div>
  </header>

  <main class="shell">
    <!-- FEEDBACK -->
    <section id="section-feedback" class="card">
      <h2>Submit Feedback</h2>
      <p class="lead">Share course / LA feedback. Stored in Supabase.</p>

      <form id="feedback-form" class="grid" novalidate>
        <div class="grid g-2">
          <div>
            <label for="course">Course</label>
            <select id="course" name="course" required>
              <option value="">Select a course…</option>
              <option>CSCE 101</option>
              <option>CSCE 155A</option>
              <option>CSCE 155E</option>
              <option>CSCE 155H</option>
              <option>CSCE 156</option>
            </select>
          </div>
          <div>
            <label for="type">Type</label>
            <select id="type" name="type" required>
              <option value="">Select type…</option>
              <option>Website</option>
              <option>Staff</option>
              <option>Class</option>
              <option>Office Hours</option>
              <option>Random</option>
              <option>Other</option>
            </select>
          </div>
        </div>

        <div>
          <label>Rating</label>
          <div id="stars" class="stars">
            <span class="star" data-v="1">★</span><span class="star" data-v="2">★</span><span class="star"
              data-v="3">★</span><span class="star" data-v="4">★</span><span class="star" data-v="5">★</span>
          </div>
          <input type="hidden" id="rating" name="rating" value="0" />
        </div>

        <div>
          <label for="text">Your feedback</label>
          <textarea id="text" name="text" placeholder="Share details…"></textarea>
        </div>

        <div class="grid g-2">
          <div>
            <label for="submitter">Your name (optional)</label>
            <input id="submitter" name="submitter" placeholder="First Last" />
          </div>
          <div>
            <label for="year">Year (optional)</label>
            <select id="year" name="year">
              <option value="">Prefer not to say</option>
              <option>Freshman</option>
              <option>Sophomore</option>
              <option>Junior</option>
              <option>Senior</option>
              <option>Graduate</option>
            </select>
          </div>
        </div>

        <div id="fb-alert" class="alert hidden"></div>
        <div class="actions"><button id="fb-submit" type="submit" class="btn-primary">Submit feedback</button></div>
      </form>
    </section>

    <!-- OFFICE HOURS -->
    <section id="section-office" class="card hidden">
      <h2>Office Hours</h2>
      <p class="lead">Browse office hours by course.</p>

      <div class="pills" id="course-filter">
        <button class="pill active" type="button" data-course="ALL">All</button>
        <button class="pill" type="button" data-course="CSCE 101">CSCE 101</button>
        <button class="pill" type="button" data-course="CSCE 155A">CSCE 155A</button>
        <button class="pill" type="button" data-course="CSCE 155E">CSCE 155E</button>
        <button class="pill" type="button" data-course="CSCE 155H">CSCE 155H</button>
        <button class="pill" type="button" data-course="CSCE 156">CSCE 156</button>
      </div>

      <div id="office-alert" class="alert hidden"></div>
      <div id="office-list" class="grid"></div>
    </section>

    <!-- LOGIN -->
    <section id="section-login" class="card hidden">
      <h2>Sign in</h2>
      <p class="lead">Staff and students sign in with NUID (or @huskers.unl.edu) and password.</p>

      <div id="login-alert" class="alert hidden"></div>
      <form id="login-form" class="grid g-2" novalidate>
        <div>
          <label for="login-input">NUID or Email</label>
          <input id="login-input" name="login" type="text" placeholder="12345678 or user@huskers.unl.edu"
            autocomplete="username" required>
        </div>
        <div>
          <label for="password-input">Password</label>
          <input id="password-input" name="password" type="password" autocomplete="current-password" required>
        </div>
        <div class="actions">
          <button id="login-btn" type="submit" class="btn-primary">Sign in</button>
          <button id="change-pass-btn" type="button" class="btn-muted">Change password</button>
        </div>
      </form>

      <!-- >>> FIX: Change Password lives on the login page -->
      <div id="change-pass-panel" class="card hidden" style="margin-top:14px">
        <h3>Change Password</h3>
        <p class="lead">Update your password. You may need to be signed in; otherwise your server may reject the
          request.</p>
        <div id="pw-alert" class="alert hidden"></div>
        <form id="pw-form" class="grid g-3" novalidate>
          <div><label>Current password</label><input id="pw-current" type="password" autocomplete="current-password"
              required></div>
          <div><label>New password</label><input id="pw-new" type="password" autocomplete="new-password" required></div>
          <div><label>Confirm new password</label><input id="pw-confirm" type="password" autocomplete="new-password"
              required></div>
          <div class="actions"><button id="pw-save" class="btn-primary" type="submit">Change password</button><button
              id="pw-cancel" class="btn-muted" type="button">Cancel</button></div>
        </form>
      </div>
    </section>

    <!-- DASHBOARD -->
    <section id="section-dashboard" class="hidden">
      <div class="card">
        <h2>My Schedule</h2>
        <p class="lead">Add, edit, or remove your office hours.</p>
        <div id="sched-alert" class="alert hidden"></div>

        <form id="sched-form" class="grid g-3" novalidate>
          <div>
            <label for="sched-course">Course</label>
            <select id="sched-course" required>
              <option value="">Select…</option>
              <option>CSCE 101</option>
              <option>CSCE 155A</option>
              <option>CSCE 155E</option>
              <option>CSCE 155H</option>
              <option>CSCE 156</option>
            </select>
          </div>
          <div>
            <label for="sched-day">Day</label>
            <select id="sched-day" required>
              <option value="">Select…</option>
              <option>Mon</option>
              <option>Tue</option>
              <option>Wed</option>
              <option>Thu</option>
              <option>Fri</option>
            </select>
          </div>
          <div><label for="sched-location">Location</label><input id="sched-location" placeholder="Avery 12 / Zoom…">
          </div>
          <div><label for="sched-start">Start</label><input id="sched-start" type="time" required></div>
          <div><label for="sched-end">End</label><input id="sched-end" type="time" required></div>
          <div class="actions"><button id="sched-save" type="submit" class="btn-primary">Add to schedule</button></div>
        </form>

        <table class="table" id="sched-table" style="margin-top:10px">
          <thead>
            <tr>
              <th>Course</th>
              <th>Day</th>
              <th>Start</th>
              <th>End</th>
              <th>Location</th>
              <th></th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>

      <div id="my-feedback" class="card hidden">
        <h2>My Feedback</h2>
        <p class="lead">Feedback items for your assigned course(s).</p>
        <div id="myfb-alert" class="alert hidden"></div>
        <ul id="myfb-list"></ul>
      </div>

      <div id="admin-block" class="card hidden">
        <h2>SL Admin</h2>
        <p class="lead">Manage staff and approve students.</p>

        <h3>Add / Edit staff</h3>
        <div id="staff-alert" class="alert hidden"></div>
        <form id="staff-form" class="grid g-3" novalidate>
          <input type="hidden" id="staff-edit-id" value="" />
          <div><label>NUID</label><input id="staff-nuid" placeholder="12345678" required></div>
          <div><label>Name</label><input id="staff-name" placeholder="First Last" required></div>
          <div><label>Email (@huskers.unl.edu)</label><input id="staff-email" placeholder="user@huskers.unl.edu"></div>
          <div>
            <label>Role</label>
            <select id="staff-role" required>
              <option value="">Select…</option>
              <option>SL</option>
              <option>CL</option>
              <option>LA</option>
            </select>
          </div>

          <!-- >>> FIX: Multi-course picker -->
          <div>
            <label>Courses (multi-select)</label>
            <select id="staff-courses" multiple size="6">
              <option value="CSCE 101">CSCE 101</option>
              <option value="CSCE 155A">CSCE 155A</option>
              <option value="CSCE 155E">CSCE 155E</option>
              <option value="CSCE 155H">CSCE 155H</option>
              <option value="CSCE 156">CSCE 156</option>
            </select>
            <div class="sub" style="color:var(--muted);margin-top:6px">Hold Ctrl/⌘ to select multiple</div>
          </div>

          <div class="actions">
            <button id="staff-add" class="btn-primary" type="submit">Save staff</button>
            <button id="staff-cancel" class="btn-muted" type="button">Cancel</button>
          </div>
        </form>

        <h3 style="margin-top:16px">Staff list</h3>
        <div id="staff-empty" class="alert hidden"></div>
        <table class="table" id="staff-table">
          <thead>
            <tr>
              <th>NUID</th>
              <th>Name</th>
              <th>Email</th>
              <th>Role</th>
              <th>Course(s)</th>
              <th></th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>

        <h3 style="margin-top:16px">Pending students</h3>
        <div id="pending-alert" class="alert hidden"></div>
        <table class="table" id="pending-table">
          <thead>
            <tr>
              <th>Name</th>
              <th>NUID</th>
              <th>Email</th>
              <th>Course</th>
              <th></th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </section>
  </main>

  <!-- Supabase REST config -->
  <script>
    window.SUPABASE_URL = window.SUPABASE_URL || 'https://wmeijbsvlnjvnhptudfh.supabase.co';
    window.SUPABASE_ANON_KEY = window.SUPABASE_ANON_KEY || 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6IndtZWlqYnN2bG5qdm5ocHR1ZGZoIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTU4MDQ5NzksImV4cCI6MjA3MTM4MDk3OX0.YT_435s_FFsqNJs6M_yW9iIGzxeCu1BHpPVH1cwJlX8';
  </script>

  <!-- App logic (based on your working version; augmented for courses + password change + full delete) -->
  <script>
    (function () {
      const $ = (s, r = document) => r.querySelector(s), $$ = (s, r = document) => Array.from(r.querySelectorAll(s));
      const getSession = () => { for (const k of ['lap_auth_v1', 'lap_auth']) { try { const raw = localStorage.getItem(k); if (raw) return JSON.parse(raw) } catch { } } return {} };
      const getToken = () => getSession().token || null;
      const getUser = () => getSession().user || null;
      const getUserName = () => { const u = getUser(); return (u && (u.name || u.email || u.full_name)) || null };
      const roleIs = r => String(getUser()?.role || '').toUpperCase() === r;
      const isStaff = () => ['SL', 'CL', 'LA'].includes(String(getUser()?.role || '').toUpperCase());
      const safe = fn => { try { fn() } catch (e) { console.error(e) } };

      // header state
      safe(() => {
        const greet = $('#lap-user-greeting'), loginTab = $('#login-tab'), logoutBtn = $('#logout-btn'), dashTab = $('#dashboard-tab');
        function paint() {
          const authed = !!getToken(); const name = getUserName();
          if (greet) { if (authed && name) { greet.textContent = `Signed in as ${name}`; greet.classList.remove('hidden') } else { greet.textContent = ''; greet.classList.add('hidden') } }
          if (loginTab) loginTab.classList.toggle('hidden', authed);
          if (logoutBtn) logoutBtn.classList.toggle('hidden', !authed);
          if (dashTab) dashTab.classList.toggle('hidden', !(authed && isStaff()));
          $('#my-feedback')?.classList.toggle('hidden', !(authed && isStaff()));
          // show admin for authed users; flip to SL-only by changing the next line:
          $('#admin-block')?.classList.toggle('hidden', !authed); // set to !(authed && roleIs('SL')) to SL-only
        }
        window.addEventListener('hashchange', paint);
        document.addEventListener('DOMContentLoaded', paint);
      });

      // feedback stars
      safe(() => {
        const stars = $$('#stars .star'), hidden = $('#rating'); if (!hidden) return;
        const paint = n => stars.forEach(s => s.classList.toggle('active', Number(s.dataset.v) <= n));
        stars.forEach(s => {
          s.addEventListener('mouseenter', () => paint(Number(s.dataset.v)));
          s.addEventListener('mouseleave', () => paint(Number(hidden.value || 0)));
          s.addEventListener('click', () => { hidden.value = s.dataset.v; paint(Number(hidden.value)) });
        });
      });

      // ---- Supabase helpers
      function getSupabaseEnv() { const URL = (window.SUPABASE_URL || '').replace(/\/+$/, ''); const KEY = window.SUPABASE_ANON_KEY || ''; return { URL, KEY } }
      async function fetchJSON(url, headers = {}) { const res = await fetch(url, { headers }); let body = null; try { body = await res.clone().json() } catch { } return { res, body } }
      const supabaseHeaders = key => ({ apikey: key, Authorization: `Bearer ${key}`, Accept: 'application/json', 'Content-Type': 'application/json' });
      const ensureArray = x => Array.isArray(x) ? x : (x ? [x] : []);

      // ---------- OFFICE HOURS (server + Supabase union) ----------
      safe(() => {
        const list = $('#office-list'); if (!list) return; const alert = $('#office-alert');
        const mapRow = r => ({ course: r.course ?? r.course_code ?? r.course_id ?? '', day: r.day ?? r.weekday ?? r.day_of_week ?? '', start: r.start ?? r.start_time ?? r.begin ?? '', end: r.end ?? r.end_time ?? r.finish ?? '', location: r.location ?? r.room ?? r.place ?? '', staff_name: (Array.isArray(r?.staff) ? ((r?.staff.find && (r.staff.find(s => String(s?.nuid || s?.id || s?.NUID || '') === String(r?.nuid || r?.staff_nuid || r?.user_nuid || ''))) || r.staff[0] || {}).name || (Array.isArray(r.staff) && (typeof r.staff[0] === 'string' ? r.staff[0] : r.staff[0]?.name)) : (r.staff_name ?? r.name ?? r.instructor ?? r.staff ?? '')) });
        const dedupe = (arr) => { const seen = new Set(); return arr.filter(x => { const k = [x.course, x.day, x.start, x.end, x.location, x.staff_name].join('|'); if (seen.has(k)) return false; seen.add(k); return true }) };
        const render = rows => {
          list.innerHTML = '';
          if (!rows.length) { alert.className = 'alert alert-error'; alert.textContent = 'No office hours to show.'; alert.classList.remove('hidden'); return }
          alert.classList.add('hidden');
          rows.forEach(r => {
            const div = document.createElement('div'); div.className = 'card';
            div.innerHTML = `<div class="grid g-2" style="align-items:center">
              <div>
                <div style="font-weight:700">${r.course} • ${r.day} ${r.start}–${r.end}</div>
                <div class="sub">Location: ${r.location || 'TBA'} &nbsp; <span class="tag">${r.staff_name || 'Staff'}</span></div>
              </div>
            </div>`;
            list.appendChild(div)
          })
        };
        (async () => {
          let rows = [];
          for (const p of ['/api/office-hours', '/office-hours']) {
            try { const r = await fetch(p, { credentials: 'include' }); const j = await r.clone().json().catch(() => null); if (r.ok) rows = rows.concat(((Array.isArray(j?.items) ? j.items : (Array.isArray(j) ? j : [])) || []).filter(x => String(x?.type || x?.kind || x?.entry_type || '').toLowerCase() !== 'lab_time')) } catch { }
          }
          try {
            const { URL, KEY } = getSupabaseEnv(); if (URL && KEY) {
              const a = await fetchJSON(`${URL}/rest/v1/office_hours_public?select=*&type=neq.lab_time`, supabaseHeaders(KEY));
              if (a.res.ok && Array.isArray(a.body)) rows = rows.concat(a.body.map(mapRow));
              const b = await fetchJSON(`${URL}/rest/v1/office_hours?select=*&type=neq.lab_time`, supabaseHeaders(KEY));
              if (b.res.ok && Array.isArray(b.body)) rows = rows.concat(b.body.map(mapRow));
            }
          } catch { }
          render(dedupe(rows));
        })();
        $$('#course-filter .pill').forEach(p => p.addEventListener('click', () => {
          $$('#course-filter .pill').forEach(x => x.classList.toggle('active', x === p));
          const c = p.dataset.course;
          Array.from(list.children).forEach(card => { const on = (c === 'ALL') || (card.textContent || '').includes(c); card.style.display = on ? '' : 'none'; });
        }));
      });

      // ---------- LOGIN/LOGOUT (server only) + Change Password toggle ----------
      safe(() => {
        const form = $('#login-form'); if (!form) return;
        const alert = $('#login-alert'), logoutBtn = $('#logout-btn'), loginTab = $('#login-tab'), dashTab = $('#dashboard-tab');
        const bad = m => { alert.className = 'alert alert-error'; alert.textContent = m; alert.classList.remove('hidden') };
        form.addEventListener('submit', async e => {
          e.preventDefault(); alert.classList.add('hidden'); alert.textContent = '';
          const login = $('#login-input').value.trim(), password = $('#password-input').value;
          if (!login || !password) return bad('Missing login or password');
          let res, json;
          try { res = await fetch('/api/auth/login', { method: 'POST', credentials: 'include', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ login, password }) }); try { json = await res.clone().json() } catch { } } catch { }
          if (!res || res.status === 404) {
            try { const r = await fetch('/auth/login', { method: 'POST', credentials: 'include', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ login, password }) }); res = r; try { json = await r.clone().json() } catch { } } catch { }
          }
          if (!res) return bad('Login request failed.');
          if (!res.ok) return bad(json?.message || 'Invalid credentials');

          try { if (json?.token && json?.user) { localStorage.setItem('lap_auth_v1', JSON.stringify({ token: json.token, user: json.user })); } } catch { }
          logoutBtn.classList.remove('hidden'); loginTab.classList.add('hidden');
          const staff = ['sl', 'cl', 'la'].includes(String(json?.user?.role || json?.role || '').toLowerCase());
          dashTab.classList.toggle('hidden', !staff);
          if (staff) { __lap_show('dashboard'); loadSchedule(); loadMyFeedback(); if (String(json?.user?.role || '').toUpperCase() === 'SL') loadAdmin(); }
          else { __lap_show('feedback'); }
          window.dispatchEvent(new Event('hashchange'));
        });
        $('#logout-btn').addEventListener('click', async () => {
          try { await fetch('/api/auth/logout', { method: 'POST', credentials: 'include' }) } catch { }
          localStorage.removeItem('lap_auth'); localStorage.removeItem('lap_auth_v1');
          $('#dashboard-tab').classList.add('hidden'); $('#logout-btn').classList.add('hidden'); $('#login-tab').classList.remove('hidden');
          __lap_show('feedback'); window.dispatchEvent(new Event('hashchange'));
        });

        // >>> FIX: Change Password handlers (on Login page)
        const cpBtn = $('#change-pass-btn'), panel = $('#change-pass-panel'), pwForm = $('#pw-form'), pwAlert = $('#pw-alert');
        const pwShow = (ok, msg) => { pwAlert.className = 'alert ' + (ok ? 'alert-success' : 'alert-error'); pwAlert.textContent = msg; pwAlert.classList.remove('hidden'); };
        cpBtn?.addEventListener('click', () => { panel?.classList.toggle('hidden'); pwAlert?.classList.add('hidden'); });
        $('#pw-cancel')?.addEventListener('click', () => { panel?.classList.add('hidden'); pwForm?.reset(); pwAlert?.classList.add('hidden'); });
        pwForm?.addEventListener('submit', async e => {
          e.preventDefault(); pwAlert.classList.add('hidden');
          const cur = $('#pw-current').value, nw = $('#pw-new').value, cf = $('#pw-confirm').value;
          if (!cur || !nw || !cf) return pwShow(false, 'All fields are required.');
          if (nw !== cf) return pwShow(false, 'New password and confirmation do not match.');
          try {
            const r = await fetch('/api/auth/change-password', { method: 'POST', credentials: 'include', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ current_password: cur, new_password: nw }) });
            let j = null; try { j = await r.clone().json() } catch { }
            if (!r.ok) throw new Error(j?.message || `${r.status}`);
            pwShow(true, 'Password changed. You may need to sign in again.');
            pwForm.reset();
          } catch (err) { pwShow(false, String(err?.message || err)); }
        });
      });

      // ---------- SCHEDULE: load + save (server first, Supabase fallback) ----------
      window.loadSchedule = function () {
        const $ = (s, r = document) => r.querySelector(s), $$ = (s, r = document) => Array.from(r.querySelectorAll(s));
        const safe = fn => { try { fn() } catch (e) { console.error(e) } };
        const getUser = () => { for (const k of ['lap_auth_v1', 'lap_auth']) { try { const raw = localStorage.getItem(k); if (raw) return JSON.parse(raw).user } catch { } } return null };

        safe(async () => {
          const tbody = $('#sched-table tbody'), alert = $('#sched-alert'); if (!tbody) return; tbody.innerHTML = '';
          const mapRow = r => ({ id: r.id || r.row_id || r.uuid || '', course: r.course || r.course_code || '', day: r.day || r.day_of_week || '', start: r.start || r.start_time || '', end: r.end || r.end_time || '', location: r.location || '', staff_email: r.staff_email || r.email || '', staff_name: r.staff_name || r.name || '' });

          let data = null, lastRes = null, lastJson = null;
          for (const url of ['/api/staff/schedule', '/api/schedule/mine', '/api/schedule']) {
            try {
              const res = await fetch(url, { credentials: 'include' }); lastRes = res;
              try { lastJson = await res.clone().json() } catch { lastJson = null }
              if (res.ok && Array.isArray(lastJson)) { data = lastJson; break }
              if (res.ok && lastJson?.items && Array.isArray(lastJson.items)) { data = lastJson.items; break }
            } catch { }
          }
          if (!data) {
            try {
              const URL = (window.SUPABASE_URL || '').replace(/\/+$/, ''), KEY = window.SUPABASE_ANON_KEY || '';
              if (URL && KEY) {
                const me = getUser();
                const params = me?.email ? `?select=*&staff_email=eq.${encodeURIComponent(me.email)}` : `?select=*`;
                const r = await fetch(`${URL}/rest/v1/office_hours${params}&type=neq.lab_time`, { headers: { apikey: KEY, Authorization: `Bearer ${KEY}`, Accept: 'application/json' } });
                if (r.ok) { const j = await r.json().catch(() => []); data = Array.isArray(j) ? j : [] }
              }
            } catch { }
          }
          data = Array.isArray(data) ? data.map(mapRow) : [];
          if (!data.length) { alert.className = 'alert alert-success'; alert.textContent = 'You have no office hours yet. Use the form above to add your first block.'; alert.classList.remove('hidden'); return; }
          alert.classList.add('hidden');
          data.forEach(row => {
            const tr = document.createElement('tr');
            tr.innerHTML = `<td>${row.course}</td><td>${row.day}</td><td>${row.start}</td><td>${row.end}</td><td>${row.location}</td>
              <td class="row-actions"><span class="link" data-edit="${row.id}">Edit</span><span class="link" data-del="${row.id}">Delete</span></td>`;
            tbody.appendChild(tr)
          });
          $$('[data-del]').forEach(a => a.addEventListener('click', async () => {
            const id = a.getAttribute('data-del'); a.textContent = 'Deleting…'; a.style.pointerEvents = 'none';
            let ok = false;
            for (const t of [`/api/staff/schedule/${id}`, `/api/schedule/${id}`]) {
              try { const r = await fetch(t, { method: 'DELETE', credentials: 'include' }); if (r.ok) { ok = true; break } } catch { }
            }
            if (!ok) {
              try {
                const URL = (window.SUPABASE_URL || '').replace(/\/+$/, ''), KEY = window.SUPABASE_ANON_KEY || '';
                if (URL && KEY) { const r = await fetch(`${URL}/rest/v1/office_hours?id=eq.${encodeURIComponent(id)}`, { method: 'DELETE', headers: supabaseHeaders(KEY) }); ok = r.ok }
              } catch { }
            }
            if (ok) loadSchedule(); else { a.textContent = 'Delete'; a.style.pointerEvents = 'auto' }
          }));
          $$('[data-edit]').forEach(a => a.addEventListener('click', () => {
            const tr = a.closest('tr'); $('#sched-course').value = tr.children[0].textContent; $('#sched-day').value = tr.children[1].textContent;
            $('#sched-start').value = tr.children[2].textContent; $('#sched-end').value = tr.children[3].textContent; $('#sched-location').value = tr.children[4].textContent;
            const btn = $('#sched-save'); btn.dataset.editId = a.getAttribute('data-edit'); btn.textContent = 'Save changes';
            window.scrollTo({ top: $('#section-dashboard').offsetTop - 10, behavior: 'smooth' });
          }));
        })
      };

      // schedule form submit (server first; basic Supabase fallback)
      (function () {
        const $ = (s, r = document) => r.querySelector(s);
        const form = $('#sched-form'); if (!form) return; const alert = $('#sched-alert'); const btn = $('#sched-save');
        function supaHeaders(KEY) { return { apikey: KEY, Authorization: `Bearer ${KEY}`, Accept: 'application/json', 'Content-Type': 'application/json' } }
        form.addEventListener('submit', async e => {
          e.preventDefault(); alert.classList.add('hidden'); const payload = { course: $('#sched-course').value.trim(), day: $('#sched-day').value.trim(), start: $('#sched-start').value.trim(), end: $('#sched-end').value.trim(), location: $('#sched-location').value.trim() };
          if (!payload.course || !payload.day || !payload.start || !payload.end) { alert.className = 'alert alert-error'; alert.textContent = 'Course, day, start and end are required.'; alert.classList.remove('hidden'); return; }
          let ok = false; const id = btn.dataset.editId || '';
          try {
            const r = await fetch(id ? `/api/staff/schedule/${id}` : '/api/staff/schedule', {
              method: id ? 'PUT' : 'POST', credentials: 'include', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload)
            });
            ok = r.ok;
          } catch { }
          if (!ok) {
            try {
              const URL = (window.SUPABASE_URL || '').replace(/\/+$/, ''), KEY = window.SUPABASE_ANON_KEY || '';
              if (URL && KEY) {
                const sess = (function () { for (const k of ['lap_auth_v1', 'lap_auth']) { try { const raw = localStorage.getItem(k); if (raw) return JSON.parse(raw) } catch { } } return {} })();
                const base = {
                  course: payload.course, day: payload.day, start: payload.start, end: payload.end, location: payload.location,
                  staff_email: sess?.user?.email || null, staff_name: sess?.user?.name || sess?.user?.full_name || sess?.user?.email || null
                };
                const simple = await fetch(`${URL}/rest/v1/office_hours${id ? `?id=eq.${encodeURIComponent(id)}` : ''}`, {
                  method: id ? 'PATCH' : 'POST', headers: supaHeaders(KEY),
                  body: JSON.stringify(id ? base : { ...base })
                });
                ok = simple.ok;
              }
            } catch { }
          }
          if (!ok) { alert.className = 'alert alert-error'; alert.textContent = 'Could not save office hour.'; alert.classList.remove('hidden'); return; }
          btn.textContent = 'Add to schedule'; delete btn.dataset.editId; form.reset(); loadSchedule();
        });
      })();

      // ---------- FEEDBACK for staff (server first, Supabase course-scoped fallback) ----------
      window.loadMyFeedback = function () {
        const $ = (s, r = document) => r.querySelector(s), $$ = (s, r = document) => Array.from(r.querySelectorAll(s));
        const safe = fn => { try { fn() } catch (e) { console.error(e) } };
        const getUser = () => { for (const k of ['lap_auth_v1', 'lap_auth']) { try { const raw = localStorage.getItem(k); if (raw) return JSON.parse(raw).user } catch { } } return null };

        safe(async () => {
          const wrap = $('#my-feedback'); if (!wrap) return;
          const list = $('#myfb-list'); const alert = $('#myfb-alert'); list.innerHTML = '';
          const u = getUser() || {}; let courses = [];
          if (Array.isArray(u.courses) && u.courses.length) courses = u.courses; else if (u.course) courses = [u.course];

          async function fetchStaffSelf() { for (const p of ['/api/admin/staff/me', '/api/staff/me']) { try { const r = await fetch(p, { credentials: 'include' }); if (r.ok) return await r.json(); } catch { } } return null; }
          if (!courses.length) { const me = await fetchStaffSelf(); if (me?.courses && Array.isArray(me.courses)) courses = me.courses; else if (me?.course) courses = [me.course]; }
          courses = (courses || []).map(c => String(c || '').trim()).filter(Boolean);

          async function fetchByCourseServer(cs) {
            const q = cs.map(c => `course=${encodeURIComponent(c)}`).join('&');
            for (const path of [`/api/feedback?${q}&scope=course`, `/feedback?${q}`]) {
              try { const r = await fetch(path, { credentials: 'include' }); if (r.ok) { const j = await r.json().catch(() => []); return Array.isArray(j?.items) ? j.items : (Array.isArray(j) ? j : []) } } catch { }
            }
            return null;
          }

          let items = await fetchByCourseServer(courses);

          if (!items || !items.length) {
            try {
              const { URL, KEY } = (function () { const U = (window.SUPABASE_URL || '').replace(/\/+$/, ''); const K = window.SUPABASE_ANON_KEY || ''; return { URL: U, KEY: K }; })();
              if (URL && KEY && courses.length) {
                const inList = '(' + courses.map(c => '"' + String(c).replace(/\"/g, '\\"') + '"').join(',') + ')';
                const url = `${URL}/rest/v1/feedback?select=course,course_code,text,message,rating,created_at&course=in.${encodeURIComponent(inList)}&order=created_at.desc.nullslast`;
                const r = await fetch(url, { headers: { apikey: KEY, Authorization: `Bearer ${KEY}`, Accept: 'application/json' } });
                if (r.ok) { const j = await r.json().catch(() => []); items = Array.isArray(j) ? j : []; }
              }
            } catch { }
          }

          if (!items || !items.length) {
            alert.className = 'alert alert-success'; alert.textContent = 'No feedback yet for your course(s).'; alert.classList.remove('hidden'); return;
          }
          alert.classList.add('hidden');

          items.slice(0, 100).forEach(f => {
            const li = document.createElement('li');
            const when = f.created_at ? new Date(f.created_at).toLocaleString([], { dateStyle: 'medium', timeStyle: 'short' }) : '';
            const rating = f.rating ? ` • ★${f.rating}` : '';
            const course = (f.course || f.course_code) ? ` • ${(f.course || f.course_code)}` : '';
            li.textContent = `${when}${course}${rating} — ${f.text || f.message || ''}`;
            list.appendChild(li);
          });
        })
      };

      // ---------- SL ADMIN (server first, Supabase write fallbacks) ----------
      window.loadAdmin = function () {
        const $ = (s, r = document) => r.querySelector(s), $$ = (s, r = document) => Array.from(r.querySelectorAll(s));
        const safe = fn => { try { fn() } catch (e) { console.error(e) } };
        const Hsup = key => ({ apikey: key, Authorization: `Bearer ${key}`, Accept: 'application/json', 'Content-Type': 'application/json' });

        // >>> FIX helpers for many-to-many staff_courses
        async function detectCourseCol() {
          const { URL, KEY } = getSupabaseEnv(); const headers = Hsup(KEY);
          const tryCol = async c => { try { const r = await fetch(`${URL}/rest/v1/staff_courses?select=${c}&limit=0`, { headers }); return r.ok; } catch { return false; } };
          if (await tryCol('course_code')) return 'course_code';
          if (await tryCol('course')) return 'course';
          if (await tryCol('course_name')) return 'course_name';
          return 'course';
        }
        async function replaceStaffCourses(nuid, courses) {
          const { URL, KEY } = getSupabaseEnv(); if (!URL || !KEY) return;
          const headers = Hsup(KEY); const col = await detectCourseCol();
          await fetch(`${URL}/rest/v1/staff_courses?staff_nuid=eq.${encodeURIComponent(nuid)}`, { method: 'DELETE', headers });
          if (Array.isArray(courses) && courses.length) {
            const rows = courses.map(c => ({ staff_nuid: nuid, [col]: String(c) }));
            await fetch(`${URL}/rest/v1/staff_courses`, { method: 'POST', headers, body: JSON.stringify(rows) });
          }
        }

        function getCoursesFromUI() {
          return Array.from($('#staff-courses')?.selectedOptions || []).map(o => o.value).filter(Boolean);
        }
        function setCoursesUI(arr = []) {
          const sel = $('#staff-courses'); if (!sel) return;
          Array.from(sel.options).forEach(o => { o.selected = (arr || []).includes(o.value); });
        }

        safe(async () => {
          const body = $('#staff-table tbody'); const empty = $('#staff-empty'); if (!body) return; body.innerHTML = '';

          function paintStaff(rows) {
            body.innerHTML = '';
            if (!rows.length) { empty.className = 'alert alert-success'; empty.textContent = 'No staff found yet. Use “Add staff” to create the first entry.'; empty.classList.remove('hidden'); return }
            if (empty) empty.classList.add('hidden');
            rows.forEach(s => {
              const tr = document.createElement('tr');
              tr.innerHTML = `
                <td>${s.nuid || ''}</td>
                <td>${s.name || ''}</td>
                <td>${s.email || ''}</td>
                <td>${(s.role || '')}</td>
                <td>${Array.isArray(s.courses) ? s.courses.join(', ') : (s.course || '')}</td>
                <td>
                  <span class="link" data-edit="${s.nuid || s.id || ''}" data-courses='${JSON.stringify(s.courses || [])}'>Edit</span>
                  <span class="link" data-rm="${s.nuid || s.id || ''}" data-email="${s.email || ''}">Remove</span>
                </td>`;
              body.appendChild(tr);
            });
            bindRowActions();
          }

          function bindRowActions() {
            $$('#staff-table [data-edit]').forEach(a => a.addEventListener('click', () => {
              const tr = a.closest('tr'); $('#staff-edit-id').value = a.getAttribute('data-edit');
              $('#staff-nuid').value = tr.children[0].textContent.trim();
              $('#staff-name').value = tr.children[1].textContent.trim();
              $('#staff-email').value = tr.children[2].textContent.trim();
              $('#staff-role').value = tr.children[3].textContent.trim();
              try { setCoursesUI(JSON.parse(a.getAttribute('data-courses') || '[]')); } catch { setCoursesUI([]); }
              window.scrollTo({ top: document.getElementById('staff-form').offsetTop - 10, behavior: 'smooth' });
            }));

            // >>> FIX: Full delete (server → supabase fallback: staff_courses then staff by nuid/email)
            $$('#staff-table [data-rm]').forEach(a => a.addEventListener('click', async () => {
              const id = a.getAttribute('data-rm'); const email = a.getAttribute('data-email') || ''; a.textContent = 'Removing…'; a.style.pointerEvents = 'none';
              let ok = false;
              for (const t of [`/api/admin/staff/${id}`, `/admin/staff/${id}`]) {
                try { const r = await fetch(t, { method: 'DELETE', credentials: 'include' }); if (r.ok) { ok = true; break } } catch { }
              }
              if (!ok) {
                try {
                  const { URL, KEY } = getSupabaseEnv(); if (URL && KEY) {
                    const headers = Hsup(KEY);
                    await fetch(`${URL}/rest/v1/staff_courses?staff_nuid=eq.${encodeURIComponent(id)}`, { method: 'DELETE', headers });
                    let rr = await fetch(`${URL}/rest/v1/staff?nuid=eq.${encodeURIComponent(id)}`, { method: 'DELETE', headers });
                    if (!rr.ok && email) rr = await fetch(`${URL}/rest/v1/staff?email=eq.${encodeURIComponent(email)}`, { method: 'DELETE', headers });
                    ok = rr.ok;
                  }
                } catch { }
              }
              if (ok) loadAdmin(); else { a.textContent = 'Remove'; a.style.pointerEvents = 'auto' }
            }));
          }

          // 1) Try server endpoints
          let rows = [], ok = false;
          for (const path of ['/api/admin/staff', '/admin/staff', '/api/staff', '/api/staff/list']) {
            try {
              const res = await fetch(path, { credentials: 'include' });
              const j = await res.clone().json().catch(() => null);
              if (res.ok) { rows = Array.isArray(j) ? j : (Array.isArray(j?.items) ? j.items : []); ok = true; break }
            } catch { }
          }

          // 2) Merge courses from Supabase if server list missing them
          try {
            const { URL, KEY } = getSupabaseEnv(); if (URL && KEY) {
              const headers = Hsup(KEY);
              const sp = await fetch(`${URL}/rest/v1/staff_public?select=nuid,name,email,role,courses,is_active&order=name.asc`, { headers });
              const sc = await fetch(`${URL}/rest/v1/staff_courses?select=staff_nuid,course,course_code,course_name`, { headers });
              const staff = sp.ok ? await sp.json().catch(() => []) : [];
              const crs = sc.ok ? await sc.json().catch(() => []) : [];
              const map = {};
              crs.forEach(r => {
                const code = r.course_code ?? r.course ?? r.course_name ?? '';
                if (!code) return;
                if (!map[r.staff_nuid]) map[r.staff_nuid] = [];
                if (!map[r.staff_nuid].includes(code)) map[r.staff_nuid].push(String(code));
              });
              // if server returned nothing, use staff_public; else enrich with courses
              if (!rows.length) rows = staff.map(s => ({ ...s, courses: (map[s.nuid]?.slice().sort()) || s.courses || [] }));
              else rows = rows.map(s => ({ ...s, courses: (s.courses && s.courses.length) ? s.courses : (map[s.nuid]?.slice().sort() || []) }));
            }
          } catch { }

          paintStaff(rows);

          // Add/Edit staff (server first; ALWAYS replace staff_courses after success)
          (function () {
            const form = $('#staff-form'), alert = $('#staff-alert');
            const ok = m => { alert.className = 'alert alert-success'; alert.textContent = m; alert.classList.remove('hidden') };
            const bad = m => { alert.className = 'alert alert-error'; alert.textContent = m; alert.classList.remove('hidden') };
            $('#staff-cancel').addEventListener('click', () => { form.reset(); $('#staff-edit-id').value = ''; setCoursesUI([]); });

            form.addEventListener('submit', async e => {
              e.preventDefault(); alert.classList.add('hidden');
              const id = $('#staff-edit-id').value.trim();
              const payload = {
                nuid: $('#staff-nuid').value.trim(),
                name: $('#staff-name').value.trim(),
                email: $('#staff-email').value.trim(),
                role: $('#staff-role').value,
                is_active: true
              };
              const courses = getCoursesFromUI();
              if (!payload.nuid || !payload.name || !payload.role) return bad('NUID, name, and role are required.');

              let good = false;
              try {
                const r = await fetch(id ? `/api/admin/staff/${encodeURIComponent(id)}` : '/api/admin/staff', {
                  method: id ? 'PUT' : 'POST', credentials: 'include', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ ...payload, courses })
                });
                good = r.ok;
                if (good) { try { await replaceStaffCourses(payload.nuid, courses); } catch { } } // ensure many-to-many persisted
              } catch { }

              if (!good) {
                try {
                  const { URL, KEY } = getSupabaseEnv(); if (URL && KEY) {
                    const headers = Hsup(KEY);
                    if (id) {
                      const r = await fetch(`${URL}/rest/v1/staff?nuid=eq.${encodeURIComponent(id)}`, { method: 'PATCH', headers, body: JSON.stringify(payload) });
                      good = r.ok;
                    } else {
                      const r = await fetch(`${URL}/rest/v1/staff`, { method: 'POST', headers, body: JSON.stringify(payload) });
                      good = r.ok;
                    }
                    if (good) await replaceStaffCourses(payload.nuid, courses);
                  }
                } catch { }
              }

              if (!good) return bad('Could not save staff.');
              ok('Saved.'); form.reset(); $('#staff-edit-id').value = ''; setCoursesUI([]); loadAdmin();
            });
          })();
        })
      };
    })();
  </script>

  <!-- ===== FIXES that only run if your existing handlers fail (do NOT remove) ===== -->
  <script id="lap-overrides-v3">
    (() => {
      const $ = (s, r = document) => r.querySelector(s);
      const sess = () => { for (const k of ['lap_auth_v1', 'lap_auth']) { try { const raw = localStorage.getItem(k); if (raw) return JSON.parse(raw) } catch { } } return {} };
      const env = () => ({ URL: (window.SUPABASE_URL || '').replace(/\/+$/, ''), KEY: window.SUPABASE_ANON_KEY || '' });
      const H = () => { const { KEY } = env(); return { apikey: KEY, Authorization: `Bearer ${KEY}`, Accept: 'application/json', 'Content-Type': 'application/json', Prefer: 'return=representation' } };
      const fmtTime = t => (!t ? '' : (/^\d{1,2}:\d{2}$/.test(t) ? t + ':00' : t));

      // ---------- FEEDBACK SUBMIT: server first, then Supabase fallback (keeps your working behavior) ----------
      (function hookFeedback() {
        const form = $('#feedback-form'), alert = $('#fb-alert'); if (!form) return;
        form.addEventListener('submit', async (e) => {
          await new Promise(r => setTimeout(r, 250));
          if (alert && alert.classList.contains('alert-success')) return;

          const payload = {
            course: ($('#course') || {}).value?.trim(),
            type: ($('#type') || {}).value?.trim(),
            rating: parseInt((($('#rating') || {}).value || '0'), 10) || null,
            text: ($('#text') || {}).value?.trim() || '',
            submitter: ($('#submitter') || {}).value?.trim() || null,
            year: ($('#year') || {}).value?.trim() || null
          };
          if (!payload.course || !payload.type || !payload.text) {
            if (alert) { alert.className = 'alert alert-error'; alert.textContent = 'Course, type, and feedback text are required.'; alert.classList.remove('hidden'); }
            return;
          }
          let ok = false;
          for (const path of ['/api/feedback', '/feedback']) {
            try {
              const r = await fetch(path, { method: 'POST', credentials: 'include', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
              if (r.ok) { ok = true; break; }
            } catch { }
          }
          if (!ok) {
            try {
              const { URL, KEY } = env(); if (URL && KEY) {
                const variants = [
                  { course: payload.course, type: payload.type, rating: payload.rating, text: payload.text, submitter: payload.submitter, year: payload.year },
                  { course_code: payload.course, type: payload.type, rating: payload.rating, message: payload.text, submitter: payload.submitter, year: payload.year },
                ];
                for (const body of variants) {
                  const r = await fetch(`${URL}/rest/v1/feedback`, { method: 'POST', headers: H(), body: JSON.stringify(body) });
                  if (r.ok) { ok = true; break; }
                }
              }
            } catch { }
          }
          if (ok) {
            if (alert) { alert.className = 'alert alert-success'; alert.textContent = 'Thanks! Your feedback was submitted.'; alert.classList.remove('hidden'); }
            form.reset?.();
            if (typeof window.loadMyFeedback === 'function') window.loadMyFeedback();
          } else {
            if (alert) { alert.className = 'alert alert-error'; alert.textContent = 'Could not submit feedback.'; alert.classList.remove('hidden'); }
          }
        }, true);
      })();

      // ---------- OFFICE HOUR SAVE: multi-variant Supabase writer if server fails ----------
      (function hookScheduleSubmit() {
        const form = $('#sched-form'), alert = $('#sched-alert'), btn = $('#sched-save'); if (!form || !btn) return;

        async function writeOH({ id, base }) {
          const { URL, KEY } = env(); if (!URL || !KEY) return false;
          const variants = id ? [
            { qs: `id=eq.${encodeURIComponent(id)}`, body: { course: base.course, day: base.day, start: fmtTime(base.start), end: fmtTime(base.end), location: base.location, staff_email: base.staff_email, staff_name: base.staff_name } },
            { qs: `id=eq.${encodeURIComponent(id)}`, body: { course_code: base.course, day_of_week: base.day, start_time: fmtTime(base.start), end_time: fmtTime(base.end), location: base.location, staff_email: base.staff_email, staff_name: base.staff_name } },
            { qs: `id=eq.${encodeURIComponent(id)}`, body: { course_id: base.course, weekday: base.day, begin: fmtTime(base.start), finish: fmtTime(base.end), room: base.location, staff: base.staff_name || base.staff_email } },
          ] : [
            { body: { course: base.course, day: base.day, start: fmtTime(base.start), end: fmtTime(base.end), location: base.location, staff_email: base.staff_email, staff_name: base.staff_name } },
            { body: { course_code: base.course, day_of_week: base.day, start_time: fmtTime(base.start), end_time: fmtTime(base.end), location: base.location, staff_email: base.staff_email, staff_name: base.staff_name } },
            { body: { course_id: base.course, weekday: base.day, begin: fmtTime(base.start), finish: fmtTime(base.end), room: base.location, staff: base.staff_name || base.staff_email } },
          ];
          for (const v of variants) {
            try {
              const r = await fetch(`${URL}/rest/v1/office_hours${v.qs ? `?${v.qs}` : ''}`, { method: id ? 'PATCH' : 'POST', headers: H(), body: JSON.stringify(v.body) });
              if (r.ok) return true;
            } catch { }
          }
          return false;
        }

        form.addEventListener('submit', async (e) => {
          await new Promise(r => setTimeout(r, 300)); // let original handler run first
          const tbody = document.querySelector('#sched-table tbody');
          if (tbody && tbody.children.length) return; // original succeeded
          const s = sess();
          const base = {
            course: ($('#sched-course') || {}).value?.trim(),
            day: ($('#sched-day') || {}).value?.trim(),
            start: ($('#sched-start') || {}).value?.trim(),
            end: ($('#sched-end') || {}).value?.trim(),
            location: ($('#sched-location') || {}).value?.trim(),
            staff_email: s?.user?.email || null,
            staff_name: s?.user?.name || s?.user?.full_name || s?.user?.email || null
          };
          const id = btn.dataset.editId || '';
          const ok = await writeOH({ id, base });
          if (ok) {
            if (alert) { alert.className = 'alert alert-success'; alert.textContent = 'Saved (via Supabase).'; alert.classList.remove('hidden'); }
            btn.textContent = 'Add to schedule'; delete btn.dataset.editId; form.reset?.();
            if (typeof window.loadSchedule === 'function') window.loadSchedule();
          } else {
            if (alert) { alert.className = 'alert alert-error'; alert.textContent = 'Could not save office hour.'; alert.classList.remove('hidden'); }
          }
        }, true);
      })();
    })();
  </script>
</body>

</html>