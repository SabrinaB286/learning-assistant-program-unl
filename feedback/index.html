<!doctype html>
<html lang="en">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Learning Assistant Feedback • UNL</title>
  <meta name="color-scheme" content="light dark" />

  <style>
    :root {
      --unl-red: #d00000;
      --unl-red-dark: #b00000;
      --ink: #222;
      --muted: #666;
      --bg: #f6f7fb;
      --card: #fff;
      --ring: #e6e7ee;
      --ok: #18a34a;
      --bad: #c1121f;
      --chip: #f1f5f9;
      --star: #fbbf24;
    }

    * {
      box-sizing: border-box
    }

    body {
      margin: 0;
      font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial, "Apple Color Emoji", "Segoe UI Emoji";
      color: var(--ink);
      background: var(--bg);
    }

    .shell {
      max-width: 1100px;
      margin: 24px auto;
      padding: 0 16px
    }

    .topbar {
      background: linear-gradient(135deg, var(--unl-red), var(--unl-red-dark));
      color: #fff;
      padding: 14px 0;
      position: sticky;
      top: 0;
      z-index: 10;
      border-bottom: 1px solid rgba(255, 255, 255, .1);
    }

    .brand {
      font-weight: 800;
      letter-spacing: .3px
    }

    .sub {
      opacity: .9;
      font-size: .95rem
    }

    .nav {
      display: flex;
      gap: 10px;
      margin: 14px 0
    }

    .btn {
      background: transparent;
      color: #fff;
      border: 1px solid rgba(255, 255, 255, .7);
      padding: 8px 14px;
      border-radius: 999px;
      cursor: pointer
    }

    .btn:hover {
      filter: brightness(.95)
    }

    .btn-ghost {
      background: #fff;
      color: var(--unl-red);
      border: 1px solid #fff
    }

    .wrap {
      background: var(--bg)
    }

    .card {
      background: var(--card);
      border: 1px solid var(--ring);
      border-radius: 14px;
      padding: 18px;
      margin-top: 16px;
      box-shadow: 0 6px 20px rgba(0, 0, 0, .06)
    }

    .row {
      display: grid;
      gap: 10px;
      margin-bottom: 12px
    }

    label {
      font-weight: 600
    }

    input,
    select,
    textarea {
      width: 100%;
      padding: 10px;
      border: 1px solid var(--ring);
      border-radius: 10px;
      background: #fff;
      min-height: 44px
    }

    textarea {
      min-height: 110px
    }

    h1,
    h2,
    h3 {
      margin: 14px 0
    }

    .hidden {
      display: none !important
    }

    .chip {
      background: var(--chip);
      padding: 4px 8px;
      border-radius: 999px;
      font-size: .85rem
    }

    .alert {
      padding: 12px 14px;
      border-radius: 10px;
      margin: 12px 0;
      font-weight: 600
    }

    .alert-success {
      background: #ecfdf5;
      color: #065f46;
      border: 1px solid #a7f3d0
    }

    .alert-error {
      background: #fff1f2;
      color: #9f1239;
      border: 1px solid #fecdd3
    }

    .btn-primary {
      background: var(--unl-red);
      color: #fff;
      border: 1px solid var(--unl-red);
      border-radius: 10px;
      padding: 10px 16px;
      font-weight: 600
    }

    .btn-primary:hover {
      background: var(--unl-red-dark)
    }

    .btn-muted {
      background: #fff;
      border: 1px solid var(--ring);
      color: var(--ink);
      border-radius: 10px;
      padding: 10px 16px;
      font-weight: 600
    }

    /* stars */
    .stars {
      display: flex;
      gap: 6px;
      align-items: center
    }

    .star {
      font-size: 28px;
      cursor: pointer;
      color: #d3d6de;
      transition: color .15s;
      line-height: 1
    }

    .star.active {
      color: var(--star)
    }

    .pillbar {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      margin: 10px 0
    }

    .pill {
      border: 1px solid var(--ring);
      padding: 8px 14px;
      border-radius: 999px;
      cursor: pointer;
      background: #fff
    }

    .pill.active {
      background: var(--unl-red);
      color: #fff;
      border-color: var(--unl-red)
    }

    .grid {
      display: grid;
      gap: 14px
    }

    @media (min-width:840px) {
      .g-2 {
        grid-template-columns: repeat(2, minmax(0, 1fr));
      }
    }
  </style>
</head>

<body>
  <!-- ======= TOP BAR ======= -->
  <header class="topbar">
    <div class="shell">
      <div class="grid g-2" style="align-items:center">
        <div>
          <div class="brand">Learning Assistant Feedback</div>
          <div class="sub">Computer Science &amp; Engineering — University of Nebraska–Lincoln</div>
        </div>
        <nav class="nav" style="justify-content:flex-end">
          <button class="btn" data-nav="feedback">Feedback</button>
          <button class="btn" data-nav="office">Office Hours</button>
          <button id="login-nav" class="btn-ghost" data-nav="login">Login</button>
          <span id="user-chip" class="chip hidden"></span>
          <button id="logout-btn" class="btn hidden">Log out</button>
        </nav>
      </div>
    </div>
  </header>

  <main class="shell wrap">
    <!-- ======= FEEDBACK ======= -->
    <section id="section-feedback" class="card">
      <h2>Submit Feedback</h2>
      <p>Share course or LA feedback. Submissions are stored in Supabase.</p>

      <form id="feedback-form" class="grid">
        <div class="g-2">
          <div class="row">
            <label for="course">Course</label>
            <select id="course" name="course" required>
              <option value="">Select a course…</option>
              <option>CSCE 101</option>
              <option>CSCE 155A</option>
              <option>CSCE 155E</option>
              <option>CSCE 155H</option>
              <option>CSCE 156</option>
            </select>
          </div>

          <div class="row">
            <label for="type">Type</label>
            <select id="type" name="type" required>
              <option value="">Select type…</option>
              <option>Website</option>
              <option>Staff</option>
              <option>Class</option>
              <option>Office Hours</option>
              <option>Random</option>
              <option>Other</option>
            </select>
          </div>
        </div>

        <div class="row">
          <label>Rating</label>
          <div class="stars" id="stars">
            <span class="star" data-v="1">★</span>
            <span class="star" data-v="2">★</span>
            <span class="star" data-v="3">★</span>
            <span class="star" data-v="4">★</span>
            <span class="star" data-v="5">★</span>
            <input type="hidden" id="rating" name="rating" value="0" />
          </div>
        </div>

        <div class="row">
          <label for="text">Your feedback</label>
          <textarea id="text" name="text" placeholder="Share details…"></textarea>
        </div>

        <div class="g-2">
          <div class="row">
            <label for="submitter">Your name (optional)</label>
            <input id="submitter" name="submitter" placeholder="First Last" />
          </div>

          <div class="row">
            <label for="year">Year (optional)</label>
            <select id="year" name="year">
              <option value="">Prefer not to say</option>
              <option>Freshman</option>
              <option>Sophomore</option>
              <option>Junior</option>
              <option>Senior</option>
              <option>Graduate</option>
            </select>
          </div>
        </div>

        <div id="feedback-alert" class="alert hidden" role="alert" aria-live="polite"></div>

        <div class="row">
          <button class="btn-primary" type="submit" id="feedback-submit">Submit feedback</button>
        </div>
      </form>
    </section>

    <!-- ======= OFFICE HOURS ======= -->
    <section id="section-office" class="card hidden">
      <h2>Office Hours</h2>
      <p>Browse office hours by course. Data comes from staff schedules.</p>

      <div class="pillbar" id="course-filter">
        <button class="pill active" data-course="ALL">All</button>
        <button class="pill" data-course="CSCE 101">CSCE 101</button>
        <button class="pill" data-course="CSCE 155A">CSCE 155A</button>
        <button class="pill" data-course="CSCE 155E">CSCE 155E</button>
        <button class="pill" data-course="CSCE 155H">CSCE 155H</button>
        <button class="pill" data-course="CSCE 156">CSCE 156</button>
      </div>

      <div id="office-list" class="grid"></div>
      <div id="office-alert" class="alert hidden"></div>
    </section>

    <!-- ======= LOGIN ======= -->
    <section id="section-login" class="card hidden">
      <h2>Sign in</h2>
      <div id="login-alert" class="alert hidden" role="alert" aria-live="polite"></div>

      <form id="login-form" novalidate>
        <div class="g-2">
          <div class="row">
            <label for="login-input">NUID or Email</label>
            <input id="login-input" name="login" type="text" inputmode="text" autocomplete="username"
              placeholder="12345678 or user@huskers.unl.edu" required>
          </div>
          <div class="row">
            <label for="password-input">Password</label>
            <input id="password-input" name="password" type="password" autocomplete="current-password" required>
          </div>
        </div>

        <div class="row" style="margin-top:12px;">
          <button id="login-btn" type="submit" class="btn-primary">Sign in</button>
          <button id="change-pass-btn" type="button" class="btn-muted">Change password</button>
        </div>
      </form>
    </section>
  </main>

  <!-- ========= PAGE SCRIPTS ========= -->

  <!-- Login handler (press Enter or click works) -->
  <script type="module" src="/public/login.js"></script>

  <!-- Minimal page wiring (tabs, stars, simple feedback POST).
       If you already have feedback.js for submission, you can remove the feedback-post logic below. -->
  <script>
    // ----- section tabs -----
    const sections = {
      feedback: document.getElementById('section-feedback'),
      office: document.getElementById('section-office'),
      login: document.getElementById('section-login')
    };
    const navButtons = Array.from(document.querySelectorAll('[data-nav]'));
    function show(which) {
      Object.entries(sections).forEach(([k, el]) => el.classList.toggle('hidden', k !== which));
      navButtons.forEach(b => b.classList.toggle('btn-ghost', b.dataset.nav === which));
      // remember choice in hash
      history.replaceState(null, '', `#${which}`);
    }
    navButtons.forEach(b => b.addEventListener('click', () => show(b.dataset.nav)));
    window.addEventListener('hashchange', () => {
      const tab = (location.hash || '#feedback').replace('#', '');
      show(sections[tab] ? tab : 'feedback');
    });
    show((location.hash || '#feedback').replace('#', ''));

    // ----- stars -----
    const starWrap = document.getElementById('stars');
    if (starWrap) {
      const stars = Array.from(starWrap.querySelectorAll('.star'));
      const hidden = document.getElementById('rating');
      function paint(n) {
        stars.forEach(s => s.classList.toggle('active', Number(s.dataset.v) <= n));
      }
      stars.forEach(s => {
        s.addEventListener('mouseenter', () => paint(Number(s.dataset.v)));
        s.addEventListener('mouseleave', () => paint(Number(hidden.value || 0)));
        s.addEventListener('click', () => { hidden.value = s.dataset.v; paint(Number(hidden.value)); });
      });
    }

    // ----- simple feedback submit (POST /api/feedback) -----
    const feedbackForm = document.getElementById('feedback-form');
    const feedbackBtn = document.getElementById('feedback-submit');
    const fbAlert = document.getElementById('feedback-alert');

    function fbShow(msg, ok = false) {
      fbAlert.classList.remove('hidden', 'alert-success', 'alert-error');
      fbAlert.classList.add(ok ? 'alert-success' : 'alert-error');
      fbAlert.textContent = msg;
    }
    function fbHide() { fbAlert.classList.add('hidden'); fbAlert.textContent = ''; }

    if (feedbackForm) {
      feedbackForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        fbHide();

        const form = new FormData(feedbackForm);
        const payload = {
          course: form.get('course') || '',
          type: form.get('type') || '',
          rating: Number(document.getElementById('rating').value || 0) || null,
          text: form.get('text') || '',
          submitter: form.get('submitter') || '',
          year: form.get('year') || ''
        };

        if (!payload.course || !payload.type) {
          fbShow('Please choose a course and type.');
          return;
        }

        feedbackBtn.disabled = true; feedbackBtn.textContent = 'Submitting…';
        try {
          const res = await fetch('/api/feedback', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
          });
          let data = {};
          try { data = await res.json(); } catch { }
          if (!res.ok) throw new Error(data?.message || 'Submit failed');

          fbShow('Thanks! Your feedback was submitted.', true);
          feedbackForm.reset();
          document.getElementById('rating').value = 0;
          const stars = document.querySelectorAll('#stars .star'); stars.forEach(s => s.classList.remove('active'));
        } catch (err) {
          fbShow(err?.message || 'Could not submit feedback.');
        } finally {
          feedbackBtn.disabled = false; feedbackBtn.textContent = 'Submit feedback';
        }
      });
    }

    // ----- office hours (lightweight fetch & filter list) -----
    const officeList = document.getElementById('office-list');
    const officeAlert = document.getElementById('office-alert');
    const pills = Array.from(document.querySelectorAll('#course-filter .pill'));
    let officeData = [];

    function renderOffice(course = 'ALL') {
      if (!officeList) return;
      officeList.innerHTML = '';
      const rows = officeData.filter(r => course === 'ALL' || r.course === course);
      if (!rows.length) {
        officeAlert.classList.remove('hidden', 'alert-success'); officeAlert.classList.add('alert-error');
        officeAlert.textContent = 'No office hours to show.';
        return;
      }
      officeAlert.classList.add('hidden'); officeAlert.textContent = '';
      rows.forEach(r => {
        const div = document.createElement('div');
        div.className = 'card';
        div.innerHTML = `
          <div class="grid g-2" style="align-items:center">
            <div>
              <div style="font-weight:700">${r.course} • ${r.day} ${r.start}–${r.end}</div>
              <div class="sub">Location: ${r.location || 'TBA'}</div>
            </div>
            <div style="text-align:right">
              <span class="chip">${r.staff_name || r.nuid}</span>
            </div>
          </div>`;
        officeList.appendChild(div);
      });
    }
    async function loadOffice() {
      try {
        const res = await fetch('/api/office-hours');
        officeData = await res.json();
        if (!Array.isArray(officeData)) officeData = [];
      } catch { officeData = []; }
      renderOffice('ALL');
    }
    if (officeList) { loadOffice(); }
    pills.forEach(p => p.addEventListener('click', () => {
      pills.forEach(x => x.classList.toggle('active', x === p));
      renderOffice(p.dataset.course);
    }));

    // ----- logout button (if your API provides /api/auth/logout) -----
    document.getElementById('logout-btn')?.addEventListener('click', async () => {
      try { await fetch('/api/auth/logout', { method: 'POST', credentials: 'include' }); } catch { }
      localStorage.removeItem('lap_auth_token');
      document.getElementById('user-chip')?.classList.add('hidden');
      document.getElementById('logout-btn')?.classList.add('hidden');
      document.getElementById('login-nav')?.classList.remove('hidden');
      show('feedback');
    });
  </script>
</body>

</html>