<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>UNL Learning Assistant Feedback</title>
  <style>
    :root {
      --unl-red: #d00000;
      --unl-red-dark: #9b0000;
      --ink: #1f2937;
      --muted: #6b7280;
      --bg: #f6f7fb;
      --card: #ffffff;
      --ring: #e5e7eb;
    }

    * {
      box-sizing: border-box
    }

    body {
      margin: 0;
      font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, 'Helvetica Neue', 'Noto Sans', Arial;
      color: var(--ink);
      background: var(--bg)
    }

    a {
      color: var(--unl-red);
      text-decoration: none
    }

    .shell {
      max-width: 1100px;
      margin: 24px auto;
      padding: 0 16px
    }

    .topbar {
      position: sticky;
      top: 0;
      z-index: 40;
      background: linear-gradient(135deg, var(--unl-red), var(--unl-red-dark));
      color: #fff;
      padding: 14px
    }

    .brand {
      font-weight: 800;
      letter-spacing: .3px
    }

    .sub {
      opacity: .85;
      font-size: .95rem
    }

    .nav {
      display: flex;
      gap: 10px;
      margin: 14px 0 0;
      flex-wrap: wrap
    }

    .chip {
      border: 1px solid rgba(255, 255, 255, .7);
      background: transparent;
      color: #fff;
      border-radius: 999px;
      padding: 8px 14px;
      cursor: pointer
    }

    .chip.active {
      background: #fff;
      color: var(--unl-red);
      border-color: #fff
    }

    .row {
      display: flex;
      gap: 10px;
      align-items: center
    }

    .push {
      margin-left: auto
    }

    .btn {
      background: var(--unl-red);
      color: #fff;
      border: none;
      border-radius: 10px;
      padding: 10px 14px;
      cursor: pointer
    }

    .btn:hover {
      filter: brightness(.95)
    }

    .btn-ghost {
      background: #fff;
      color: var(--unl-red);
      border: 1px solid var(--unl-red)
    }

    .wrap {
      background: var(--card);
      border: 1px solid var(--ring);
      border-radius: 14px;
      padding: 18px;
      margin-top: 16px;
      box-shadow: 0 6px 20px rgba(0, 0, 0, .06)
    }

    .grid {
      display: grid;
      gap: 14px
    }

    .g-3 {
      grid-template-columns: repeat(3, minmax(0, 1fr))
    }

    .stat {
      background: var(--card);
      border: 1px solid var(--ring);
      border-radius: 12px;
      padding: 16px
    }

    .stat .n {
      font-size: 2rem;
      font-weight: 800
    }

    label {
      font-weight: 600;
      margin-bottom: 6px;
      display: block
    }

    input,
    select,
    textarea {
      width: 100%;
      padding: 10px;
      border: 1px solid var(--ring);
      border-radius: 10px;
      background: #fff
    }

    textarea {
      min-height: 110px
    }

    table {
      width: 100%;
      border-collapse: collapse
    }

    th,
    td {
      padding: 10px;
      border-bottom: 1px solid var(--ring);
      text-align: left;
      font-size: .95rem
    }

    th {
      color: var(--muted);
      font-weight: 700
    }

    .muted {
      color: var(--muted)
    }

    .hidden {
      display: none !important
    }

    .alert {
      padding: 12px 14px;
      border-radius: 10px;
      margin: 12px 0;
      font-weight: 600
    }

    .alert-success {
      background: #ecfdf5;
      color: #065f46;
      border: 1px solid #a7f3d0
    }

    .alert-error {
      background: #fff1f2;
      color: #9f1239;
      border: 1px solid #fecdd3
    }

    .badge {
      display: inline-block;
      background: #fff;
      color: var(--unl-red);
      padding: 6px 10px;
      border-radius: 999px;
      border: 1px solid rgba(255, 255, 255, .7)
    }

    /* Office hours pill filter (dark-on-light UI inside content) */
    .pillbar {
      display: flex;
      gap: 8px;
      flex-wrap: wrap
    }

    .pill {
      border: 1px solid var(--ring);
      background: #fff;
      color: var(--ink);
      border-radius: 999px;
      padding: 6px 12px;
      cursor: pointer
    }

    .pill.active {
      background: var(--unl-red);
      color: #fff;
      border-color: var(--unl-red)
    }

    .oh-group {
      margin-top: 14px
    }

    .oh-title {
      font-weight: 800;
      margin: 0 0 6px 0
    }

    .oh-card {
      border: 1px solid var(--ring);
      border-radius: 12px;
      padding: 10px;
      margin: 6px 0;
      background: #fff
    }

    .oh-meta {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      color: var(--muted);
      font-size: .9rem
    }

    /* modal */
    .modal-veil {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, .35);
      display: none;
      align-items: center;
      justify-content: center;
      padding: 20px
    }

    .modal {
      max-width: 520px;
      width: 100%;
      background: #fff;
      border-radius: 14px;
      border: 1px solid var(--ring);
      box-shadow: 0 12px 40px rgba(0, 0, 0, .2);
      padding: 18px
    }
  </style>
</head>

<body>
  <div class="topbar">
    <div class="shell">
      <div class="row">
        <div>
          <div class="brand">Learning Assistant Feedback</div>
          <div class="sub">Computer Science &amp; Engineering – University of Nebraska–Lincoln</div>
        </div>
        <div class="push row" id="who-bar" style="gap:8px;display:none;">
          <span id="who-name" class="badge"></span>
          <button id="pwd-open" class="btn btn-ghost">Change password</button>
          <button id="logout-btn" class="btn btn-ghost">Log out</button>
        </div>
      </div>
      <div class="nav">
        <button id="nav-feedback" class="chip active" data-tab="feedback">Feedback</button>
        <button id="nav-hours" class="chip" data-tab="hours">Office Hours</button>
        <button id="nav-login" class="chip" data-tab="login">Login</button>
        <button id="nav-dashboard" class="chip" data-tab="dashboard" style="display:none;">Dashboard</button>
      </div>
    </div>
  </div>

  <div class="shell">
    <div id="alerts"></div>

    <!-- FEEDBACK -->
    <section id="tab-feedback" class="wrap">
      <h2 style="margin-top:0">Submit Feedback</h2>
      <div class="grid" style="grid-template-columns:repeat(2,minmax(0,1fr));">
        <div>
          <label for="course">Course</label>
          <select id="course">
            <option value="">Select Course</option>
            <option>CSCE 101</option>
            <option>CSCE 155A</option>
            <option>CSCE 155E</option>
            <option>CSCE 155H</option>
            <option>CSCE 156</option>
          </select>
        </div>
        <div>
          <label for="feedback-type">Type</label>
          <select id="feedback-type">
            <option>General</option>
            <option>Course</option>
            <option>TA</option>
          </select>
        </div>
      </div>

      <div style="margin-top:10px;">
        <label>Overall Rating</label>
        <div id="stars" style="display:flex;gap:6px;font-size:22px;cursor:pointer;">
          <span data-rating="1">★</span><span data-rating="2">★</span><span data-rating="3">★</span><span
            data-rating="4">★</span><span data-rating="5">★</span>
        </div>
        <input type="hidden" id="rating-value" value="0">
      </div>

      <div style="margin-top:12px;">
        <label for="feedback-text">Feedback Details</label>
        <textarea id="feedback-text" placeholder="Please provide detailed feedback…" required></textarea>
      </div>

      <div class="grid" style="grid-template-columns:repeat(2,minmax(0,1fr));margin-top:12px;">
        <div>
          <label for="student-name">Your Name (Optional)</label>
          <input id="student-name" type="text" placeholder="Leave blank to stay anonymous" />
        </div>
        <div>
          <label for="student-year">Academic Year (Optional)</label>
          <select id="student-year">
            <option value="">Select Year</option>
            <option>Freshman</option>
            <option>Sophomore</option>
            <option>Junior</option>
            <option>Senior</option>
            <option>Graduate</option>
          </select>
        </div>
      </div>

      <button id="btn-submit-feedback" class="btn" style="margin-top:14px;">Submit Feedback</button>
    </section>

    <!-- OFFICE HOURS -->
    <section id="tab-hours" class="wrap hidden">
      <h2 style="margin-top:0">Office Hours</h2>
      <p class="muted" style="margin-top:0">Browse office hours by course. Data comes from staff schedules.</p>
      <div class="pillbar" id="oh-filter">
        <button class="pill active" data-course="">All</button>
        <button class="pill" data-course="CSCE 101">CSCE 101</button>
        <button class="pill" data-course="CSCE 155A">CSCE 155A</button>
        <button class="pill" data-course="CSCE 155E">CSCE 155E</button>
        <button class="pill" data-course="CSCE 155H">CSCE 155H</button>
        <button class="pill" data-course="CSCE 156">CSCE 156</button>
      </div>
      <div id="hours-body" style="margin-top:12px;"></div>
    </section>

    <!-- LOGIN -->
    <section id="tab-login" class="wrap hidden">
      <h2 style="margin-top:0;text-align:center">Sign in</h2>
      <div style="max-width:460px;margin:0 auto;">
        <form id="login-form" onsubmit="return false">
          <label for="login-id">NUID or Email</label>
          <input id="login-id" type="text" placeholder="e.g., 12345678 or user@huskers.unl.edu" autocomplete="username">
          <div style="height:8px"></div>
          <label for="login-pw">Password</label>
          <input id="login-pw" type="password" placeholder="Your password" autocomplete="current-password">
          <button id="btn-login" class="btn" style="width:100%;margin-top:14px;" type="submit">Sign in</button>
        </form>

        <details style="margin-top:18px;">
          <summary><b>New student?</b> Create an account</summary>
          <div style="height:10px"></div>
          <label for="su-name">Full name</label>
          <input id="su-name" type="text" placeholder="First Last">
          <div style="height:8px"></div>
          <label for="su-email">Email (<code>@huskers.unl.edu</code>)</label>
          <input id="su-email" type="email" placeholder="you@huskers.unl.edu">
          <div style="height:8px"></div>
          <label for="su-nuid">NUID (optional)</label>
          <input id="su-nuid" type="text" placeholder="e.g., 12345678">
          <div style="height:8px"></div>
          <label for="su-pw">Password (min 8)</label>
          <input id="su-pw" type="password" placeholder="Create a password">
          <div style="height:8px"></div>
          <label for="su-year">Class year</label>
          <select id="su-year">
            <option value="">Select Year</option>
            <option>Freshman</option>
            <option>Sophomore</option>
            <option>Junior</option>
            <option>Senior</option>
            <option>Graduate</option>
          </select>
          <div style="height:8px"></div>
          <label for="su-courses">Courses (comma-separated)</label>
          <input id="su-courses" type="text" placeholder="CSCE 155A, CSCE 156">
          <button id="btn-student-signup" class="btn" style="width:100%;margin-top:12px;">Create account</button>
        </details>
      </div>
    </section>

    <!-- DASHBOARD -->
    <section id="tab-dashboard" class="wrap hidden">
      <h2 style="margin-top:0">Dashboard</h2>

      <div class="grid g-3">
        <div class="stat">
          <div class="n" id="total-feedback">0</div>
          <div class="muted">Total Feedback</div>
        </div>
        <div class="stat">
          <div class="n" id="avg-rating">0.0</div>
          <div class="muted">Average Rating</div>
        </div>
        <div class="stat">
          <div class="n" id="this-week">0</div>
          <div class="muted">This Week</div>
        </div>
      </div>

      <div class="wrap" style="margin-top:16px;">
        <label for="filter-course">Filter by Course</label>
        <select id="filter-course">
          <option value="">All Courses</option>
          <option>CSCE 101</option>
          <option>CSCE 155A</option>
          <option>CSCE 155E</option>
          <option>CSCE 155H</option>
          <option>CSCE 156</option>
        </select>
        <div id="feedback-list" style="margin-top:12px;"></div>
      </div>

      <!-- My Schedule -->
      <div class="wrap" id="schedule-panel" style="margin-top:16px;display:none;">
        <h3 style="margin:0">My Schedule</h3>
        <div class="grid" style="grid-template-columns: repeat(6,minmax(0,1fr)); gap:10px; margin-top:12px;">
          <div><label>Type</label><select id="sc-type">
              <option value="office_hour">Office Hour</option>
              <option value="lab_time">Lab Time</option>
            </select></div>
          <div><label>Day</label><select id="sc-day">
              <option>Mon</option>
              <option>Tue</option>
              <option>Wed</option>
              <option>Thu</option>
              <option>Fri</option>
              <option>Sat</option>
              <option>Sun</option>
            </select></div>
          <div><label>Start</label><input id="sc-start" type="time"></div>
          <div><label>End</label><input id="sc-end" type="time"></div>
          <div><label>Location</label><input id="sc-location" type="text" placeholder="Avery 19"></div>
          <div><label>Course</label><input id="sc-course" type="text" placeholder="CSCE 155A"></div>
        </div>
        <button id="sc-add" class="btn" style="margin-top:10px;">Add entry</button>
        <table style="margin-top:14px;">
          <thead>
            <tr>
              <th>Type</th>
              <th>Day</th>
              <th>Start</th>
              <th>End</th>
              <th>Location</th>
              <th>Course</th>
              <th></th>
            </tr>
          </thead>
          <tbody id="schedule-body"></tbody>
        </table>
      </div>

      <!-- SL-only: Pending + Add staff -->
      <div class="wrap" id="admin-pending" style="margin-top:16px;display:none;">
        <h3 style="margin:0">Pending student signups</h3>
        <div id="pending-rows" style="margin-top:10px;"></div>
      </div>

      <div class="wrap" id="admin-add-staff" style="margin-top:16px;display:none;">
        <h3 style="margin:0">Add staff</h3>
        <div class="grid" style="grid-template-columns: repeat(2,minmax(0,1fr)); margin-top:10px;">
          <div><label>NUID</label><input id="st-nuid" type="text" placeholder="e.g., 12345678"></div>
          <div><label>Name</label><input id="st-name" type="text" placeholder="Full name"></div>
          <div><label>Role</label><select id="st-role">
              <option>LA</option>
              <option>CL</option>
              <option>SL</option>
            </select></div>
          <div><label>Email (optional, @huskers.unl.edu)</label><input id="st-email" type="email"
              placeholder="user@huskers.unl.edu"></div>
          <div><label>Temp password (optional)</label><input id="st-pass" type="password"
              placeholder="If blank, default is used"></div>
          <div></div>
        </div>
        <div style="margin-top:10px;">
          <div class="row" style="justify-content:space-between;align-items:center">
            <label style="margin:0">Courses</label>
            <button id="st-add-course" class="btn" type="button" style="background:#e5e7eb;color:#111">+ Add
              course</button>
          </div>
          <div id="st-courses-wrap" class="grid"
            style="grid-template-columns:repeat(2,minmax(0,1fr)); gap:10px; margin-top:10px;"></div>
        </div>
        <button id="btn-add-staff" class="btn" style="margin-top:14px;">Add staff</button>
      </div>

      <!-- SL-only: Reset user password -->
      <div class="wrap" id="admin-reset" style="margin-top:16px;display:none;">
        <h3 style="margin:0">Reset a user's password</h3>
        <div class="grid" style="grid-template-columns:repeat(3,minmax(0,1fr));margin-top:10px;">
          <div><label>Target</label><select id="rp-target">
              <option value="staff">Staff (by NUID)</option>
              <option value="student">Student (by email)</option>
            </select></div>
          <div id="rp-nuid-wrap"><label>NUID</label><input id="rp-nuid" type="text" placeholder="e.g., 12345678"></div>
          <div id="rp-email-wrap" class="hidden"><label>Email (@huskers.unl.edu)</label><input id="rp-email"
              type="email" placeholder="user@huskers.unl.edu"></div>
        </div>
        <div style="margin-top:10px;"><label>New password</label><input id="rp-pass" type="password"
            placeholder="Min 8, letters and numbers"></div>
        <button id="rp-do" class="btn" style="margin-top:12px;">Set password</button>
      </div>
    </section>
  </div>

  <!-- Change password modal -->
  <div id="pwd-veil" class="modal-veil">
    <div class="modal">
      <h3 style="margin:0 0 10px 0;">Change your password</h3>
      <div><label>Current password</label><input id="pwd-current" type="password" autocomplete="current-password"></div>
      <div style="margin-top:8px;"><label>New password</label><input id="pwd-new" type="password"
          placeholder="Min 8, letters and numbers" autocomplete="new-password"></div>
      <div style="margin-top:8px;"><label>Confirm new password</label><input id="pwd-confirm" type="password"
          autocomplete="new-password"></div>
      <div class="row" style="justify-content:flex-end;margin-top:12px;">
        <button id="pwd-cancel" class="btn" style="background:#e5e7eb;color:#111">Cancel</button>
        <button id="pwd-save" class="btn">Save</button>
      </div>
    </div>
  </div>

  <script>
    let authToken = null, currentUser = null;

    const $ = s => document.querySelector(s);
    const $$ = s => Array.from(document.querySelectorAll(s));
    const HUSKERS_RE = /^[A-Za-z0-9._%+-]+@huskers\.unl\.edu$/i;
    const headers = () => authToken ? { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + authToken } : { 'Content-Type': 'application/json' };
    const isHuskers = e => HUSKERS_RE.test((e || '').trim());
    const courseOptions = () => `<option value="">Select a course</option><option>CSCE 101</option><option>CSCE 155A</option><option>CSCE 155E</option><option>CSCE 155H</option><option>CSCE 156</option>`;
    const OFFICE_URL = '/api/schedule/office-hours';

    function alertUI(msg, ok = true) { const box = document.createElement('div'); box.className = 'alert ' + (ok ? 'alert-success' : 'alert-error'); box.textContent = msg; $('#alerts').prepend(box); setTimeout(() => box.remove(), 4500); }
    function showTab(name) {
      ['feedback', 'hours', 'login', 'dashboard'].forEach(id => $('#tab-' + id)?.classList.toggle('hidden', id !== name));
      [['feedback', 'nav-feedback'], ['hours', 'nav-hours'], ['login', 'nav-login'], ['dashboard', 'nav-dashboard']]
        .forEach(([t, btnId]) => $('#' + btnId)?.classList.toggle('active', t === name));
      if (name === 'dashboard' && authToken && currentUser) {
        loadFeedback();
        if (currentUser.kind === 'staff') {
          loadSchedule();
          const isSL = currentUser.role === 'SL';
          showSL(isSL);
          if (isSL) { loadPending(); }
        }
      }
      if (name === 'hours') { loadOfficeHours(); }
      window.scrollTo({ top: 0, behavior: 'smooth' });
    }
    function refreshTopBar() {
      const logged = !!(authToken && currentUser);
      $('#who-bar').style.display = logged ? 'flex' : 'none';
      $('#nav-dashboard').style.display = logged ? 'inline-block' : 'none';
      if (logged) { $('#who-name').textContent = `${currentUser.name} (${currentUser.role || currentUser.kind})`; }
    }
    $('#nav-feedback')?.addEventListener('click', () => showTab('feedback'));
    $('#nav-hours')?.addEventListener('click', () => showTab('hours'));
    $('#nav-login')?.addEventListener('click', () => showTab('login'));
    $('#nav-dashboard')?.addEventListener('click', () => {
      if (!(authToken && currentUser)) { alertUI('Please sign in first.', false); showTab('login'); return; }
      showTab('dashboard');
    });

    // stars
    $('#stars')?.addEventListener('click', e => {
      const s = e.target.closest('[data-rating]'); if (!s) return;
      const v = Number(s.dataset.rating); $('#rating-value').value = String(v);
      $$('#stars [data-rating]').forEach(x => { x.style.color = Number(x.dataset.rating) <= v ? '#ffbf00' : '#999'; });
    });

    // submit feedback
    $('#btn-submit-feedback')?.addEventListener('click', async () => {
      const course = $('#course').value.trim() || null;
      const type = $('#feedback-type').value.trim() || 'General';
      const rating = Number($('#rating-value').value || 0) || null;
      const text = $('#feedback-text').value.trim();
      const submitter = $('#student-name').value.trim() || null;
      const year = $('#student-year').value.trim() || null;
      if (!text) return alertUI('Please enter feedback text.', false);
      try {
        const r = await fetch('/api/feedback', { method: 'POST', headers: headers(), body: JSON.stringify({ course, type, rating, text, submitter, year }) });
        const j = await r.json();
        if (!r.ok) throw new Error(j.error || 'Could not submit');
        alertUI('Thanks for your feedback!');
        $('#feedback-text').value = ''; $('#rating-value').value = '0'; $$('#stars [data-rating]').forEach(x => x.style.color = '#999');
      } catch (e) { alertUI(e.message, false); }
    });

    // ---------- LOGIN (Enter submits) ----------
    async function doLogin() {
      const login = $('#login-id').value.trim(), password = $('#login-pw').value;
      if (!login || !password) return alertUI('Enter login and password.', false);
      if (login.includes('@') && !isHuskers(login)) return alertUI('Use your @huskers.unl.edu email (or NUID).', false);
      try {
        const r = await fetch('/api/auth/login', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ login, password }) });
        const j = await r.json();
        if (!r.ok) throw new Error(j.error || 'Login failed');
        authToken = j.token; currentUser = j.user;
        localStorage.setItem('authToken', authToken);
        localStorage.setItem('user', JSON.stringify(currentUser));
        refreshTopBar(); alertUI(`Welcome, ${currentUser.name}!`);
        showTab('dashboard');
      } catch (e) { alertUI(e.message, false); }
    }
    $('#login-form')?.addEventListener('submit', (e) => { e.preventDefault(); doLogin(); });
    $('#btn-login')?.addEventListener('click', (e) => { e.preventDefault(); doLogin(); });

    $('#logout-btn')?.addEventListener('click', () => {
      localStorage.removeItem('authToken'); localStorage.removeItem('user');
      authToken = null; currentUser = null; refreshTopBar(); showTab('feedback'); alertUI('Signed out.');
    });

    // student signup
    $('#btn-student-signup')?.addEventListener('click', async () => {
      const name = $('#su-name').value.trim(),
        email = $('#su-email').value.trim().toLowerCase(),
        nuid = $('#su-nuid').value.trim(),
        password = $('#su-pw').value,
        class_year = $('#su-year').value.trim(),
        courses = ($('#su-courses').value || '').split(',').map(s => s.trim()).filter(Boolean);
      if (!name || !email || !password) return alertUI('Name, email, and password are required.', false);
      if (!isHuskers(email)) return alertUI('Email must be @huskers.unl.edu', false);
      try {
        const r = await fetch('/api/auth/student/signup', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ name, email, nuid, password, class_year, courses }) });
        const j = await r.json();
        if (!r.ok) throw new Error(j.error || 'Signup failed');
        alertUI('Submitted for SL approval. You can log in after approval.');
      } catch (e) { alertUI(e.message, false); }
    });

    // ---------- Dashboard: feedback list ----------
    let FEED = [];
    async function loadFeedback() {
      try { const r = await fetch('/api/feedback'); const data = await r.json(); if (!r.ok) throw new Error(data.error || 'Failed'); FEED = data || []; }
      catch { FEED = []; }
      renderFeedback();
    }
    function renderFeedback() {
      const total = FEED.length;
      const rated = FEED.filter(x => x.rating != null);
      const avg = rated.length ? (rated.reduce((a, b) => a + (b.rating || 0), 0) / rated.length) : 0;
      const wk = Date.now() - 7 * 24 * 3600 * 1000;
      const week = FEED.filter(x => new Date(x.created_at || Date.now()).getTime() >= wk).length;
      $('#total-feedback').textContent = total;
      $('#avg-rating').textContent = avg.toFixed(1);
      $('#this-week').textContent = week;

      const course = $('#filter-course').value || '';
      const list = $('#feedback-list'); list.innerHTML = '';
      const items = FEED.filter(x => !course || x.course === course);
      if (!items.length) { list.innerHTML = '<div class="muted">No feedback yet.</div>'; return; }
      items.forEach(it => {
        const card = document.createElement('div'); card.className = 'wrap';
        card.innerHTML = `<div class="row" style="justify-content:space-between;">
            <div class="muted">${(it.course || 'General')} • ${(it.type || 'General')}</div>
            <div>${it.rating ? `★ ${it.rating}/5` : ''}</div>
          </div>
          <div style="margin-top:6px;">${(it.text || '')}</div>
          <div class="muted" style="margin-top:6px;font-size:.85rem;">${it.created_at ? new Date(it.created_at).toLocaleString() : ''}</div>`;
        list.append(card);
      });
    }
    $('#filter-course')?.addEventListener('change', renderFeedback);

    // ---------- Dashboard: my schedule ----------
    async function loadSchedule() {
      if (!currentUser || currentUser.kind !== 'staff') return;
      $('#schedule-panel').style.display = 'block';
      const body = $('#schedule-body'); body.innerHTML = '<tr><td colspan="7" class="muted">Loading…</td></tr>';
      try {
        const r = await fetch(`/api/staff/${currentUser.nuid}/schedule`, { headers: headers() });
        const rows = await r.json(); if (!r.ok) throw new Error(rows.error || 'Failed');
        renderSchedule(rows || []);
      } catch (e) { $('#schedule-panel').style.display = 'none'; alertUI(e.message, false); }
    }
    function renderSchedule(rows) {
      const body = $('#schedule-body'); body.innerHTML = '';
      if (!rows.length) { body.innerHTML = '<tr><td colspan="7" class="muted">No entries</td></tr>'; return; }
      rows.forEach(r => {
        const tr = document.createElement('tr');
        tr.innerHTML = `<td>${r.type === 'office_hour' ? 'Office Hour' : 'Lab Time'}</td>
          <td>${r.day}</td><td>${r.start_time}</td><td>${r.end_time}</td>
          <td>${r.location || ''}</td><td>${r.course_code || r.course || ''}</td>
          <td><button class="btn" style="background:#e5e7eb;color:#111" data-del="${r.id}">Delete</button></td>`;
        body.append(tr);
      });
      body.querySelectorAll('button[data-del]').forEach(b => {
        b.onclick = async () => {
          const id = b.getAttribute('data-del'); if (!confirm('Delete this entry?')) return;
          try {
            const r = await fetch(`/api/staff/me/schedule/${id}`, { method: 'DELETE', headers: headers() });
            const j = await r.json(); if (!r.ok) throw new Error(j.error || 'Delete failed');
            await loadSchedule(); alertUI('Entry deleted.');
          } catch (e) { alertUI(e.message, false); }
        };
      });
    }
    $('#sc-add')?.addEventListener('click', async () => {
      const type = $('#sc-type').value, day = $('#sc-day').value, start = $('#sc-start').value,
        end = $('#sc-end').value, location = $('#sc-location').value.trim(), course = $('#sc-course').value.trim();
      if (!type || !day || !start || !end) return alertUI('Type, day, start and end are required.', false);
      try {
        const r = await fetch('/api/staff/me/schedule', { method: 'POST', headers: headers(), body: JSON.stringify({ type, day, start, end, location, course }) });
        const j = await r.json(); if (!r.ok) throw new Error(j.error || 'Add failed');
        ['#sc-start', '#sc-end', '#sc-location', '#sc-course'].forEach(sel => $(sel).value = '');
        await loadSchedule(); alertUI('Entry added.');
      } catch (e) { alertUI(e.message, false); }
    });

    // ---------- SL panels ----------
    function showSL(is) {
      $('#admin-pending').style.display = is ? 'block' : 'none';
      $('#admin-add-staff').style.display = is ? 'block' : 'none';
      $('#admin-reset').style.display = is ? 'block' : 'none';
    }
    async function loadPending() {
      try {
        const r = await fetch('/api/auth/students/pending', { headers: headers() });
        const rows = await r.json(); const box = $('#pending-rows');
        if (!r.ok) throw new Error(rows.error || 'Failed');
        if (!rows.length) { box.innerHTML = '<div class="muted">No pending students.</div>'; return; }
        box.innerHTML = rows.map(x => `
          <div class="row wrap" style="align-items:center;justify-content:space-between;">
            <div><b>${x.name}</b> — ${x.email} ${x.nuid ? `(${x.nuid})` : ''} ${x.class_year ? `• ${x.class_year}` : ''}</div>
            <div class="row" style="gap:8px;">
              <button class="btn" style="background:#e5e7eb;color:#111" data-a="reject" data-id="${x.id}">Reject</button>
              <button class="btn" data-a="approve" data-id="${x.id}">Approve</button>
            </div>
          </div>`).join('');
        box.querySelectorAll('button[data-a]').forEach(btn => {
          btn.onclick = async () => {
            const id = btn.getAttribute('data-id'), a = btn.getAttribute('data-a');
            const r2 = await fetch(`/api/auth/students/${id}/${a}`, { method: 'POST', headers: headers() });
            const j = await r2.json().catch(() => ({}));
            if (!r2.ok) return alertUI(j.error || 'Action failed', false);
            alertUI('Updated.'); loadPending();
          };
        });
      } catch (e) { alertUI(e.message, false); }
    }

    // Add staff (courses dynamic)
    function addCourseRow(defaultValue = '') {
      const row = document.createElement('div'); row.className = 'row'; row.style.gap = '8px';
      const sel = document.createElement('select'); sel.innerHTML = courseOptions(); if (defaultValue) sel.value = defaultValue; sel.style.flex = '1 1 auto';
      const rm = document.createElement('button'); rm.type = 'button'; rm.className = 'btn'; rm.style.background = '#e5e7eb'; rm.style.color = '#111'; rm.textContent = 'Remove';
      rm.onclick = () => row.parentElement.remove();
      const holder = document.createElement('div'); holder.style.gridColumn = 'span 2';
      row.append(sel, rm); holder.append(row); $('#st-courses-wrap').append(holder);
    }
    $('#st-add-course')?.addEventListener('click', () => addCourseRow());
    const seedObs = new MutationObserver(() => {
      const wrap = $('#st-courses-wrap'); const panel = $('#admin-add-staff');
      if (panel && wrap && panel.style.display !== 'none' && !wrap.dataset.seeded) {
        wrap.dataset.seeded = '1'; if (!wrap.children.length) addCourseRow();
      }
    });
    seedObs.observe(document.body, { childList: true, subtree: true });

    $('#btn-add-staff')?.addEventListener('click', async () => {
      if (!currentUser || currentUser.role !== 'SL') return alertUI('Only SL can add staff.', false);
      const nuid = $('#st-nuid').value.trim(), name = $('#st-name').value.trim(), role = $('#st-role').value.trim(),
        email = $('#st-email').value.trim(), temp_password = $('#st-pass').value;
      if (!nuid || !/^\d{7,9}$/.test(nuid)) return alertUI('Enter a valid NUID (7–9 digits).', false);
      if (!name) return alertUI('Name is required.', false);
      if (email && !HUSKERS_RE.test(email)) return alertUI('Email must be @huskers.unl.edu', false);
      const courses = Array.from(document.querySelectorAll('#st-courses-wrap select')).map(s => (s.value || '').trim()).filter(Boolean);
      if (!courses.length) return alertUI('Add at least one course.', false);

      const btn = $('#btn-add-staff'); const label = btn.textContent; btn.disabled = true; btn.textContent = 'Adding…';
      try {
        const r = await fetch('/api/staff', { method: 'POST', headers: headers(), body: JSON.stringify({ nuid, name, role, email: email || null, temp_password: temp_password || null, courses }) });
        const j = await r.json().catch(() => ({})); if (!r.ok) throw new Error(j.error || 'Failed to add staff');
        alertUI('Staff added successfully.');['#st-nuid', '#st-name', '#st-email', '#st-pass'].forEach(sel => $(sel).value = ''); $('#st-role').value = 'LA'; $('#st-courses-wrap').innerHTML = ''; addCourseRow();
      } catch (e) { alertUI(e.message, false); } finally { btn.disabled = false; btn.textContent = label; }
    });

    // Admin reset UI
    $('#rp-target')?.addEventListener('change', e => {
      const t = e.target.value;
      $('#rp-nuid-wrap').classList.toggle('hidden', t !== 'staff');
      $('#rp-email-wrap').classList.toggle('hidden', t !== 'student');
    });
    $('#rp-do')?.addEventListener('click', async () => {
      if (!currentUser || currentUser.role !== 'SL') return alertUI('SL only.', false);
      const target = $('#rp-target').value, nuid = $('#rp-nuid').value.trim(), email = $('#rp-email').value.trim(), pw = $('#rp-pass').value;
      if (!pw || pw.length < 8) return alertUI('Password must be at least 8 characters', false);
      if (target === 'staff' && !nuid) return alertUI('Enter NUID', false);
      if (target === 'student' && !HUSKERS_RE.test(email)) return alertUI('Enter @huskers.unl.edu email', false);
      try {
        const r = await fetch('/api/auth/admin/reset-password', { method: 'POST', headers: headers(), body: JSON.stringify({ target, nuid, email, new_password: pw }) });
        const j = await r.json(); if (!r.ok) throw new Error(j.error || 'Reset failed');
        alertUI('Password set.'); $('#rp-pass').value = '';
      } catch (e) { alertUI(e.message, false); }
    });

    // Change password modal
    function openPwd() { $('#pwd-veil').style.display = 'flex'; $('#pwd-current').value = ''; $('#pwd-new').value = ''; $('#pwd-confirm').value = ''; }
    function closePwd() { $('#pwd-veil').style.display = 'none'; }
    $('#pwd-open')?.addEventListener('click', () => { if (!(authToken && currentUser)) return alertUI('Sign in first.', false); openPwd(); });
    $('#pwd-cancel')?.addEventListener('click', closePwd);
    $('#pwd-save')?.addEventListener('click', async () => {
      const cur = $('#pwd-current').value, nw = $('#pwd-new').value, cf = $('#pwd-confirm').value;
      if (!cur || !nw || !cf) return alertUI('Fill all fields.', false);
      if (nw !== cf) return alertUI('Passwords do not match.', false);
      if (nw.length < 8 || !/[A-Za-z]/.test(nw) || !/\d/.test(nw)) return alertUI('Use at least 8 chars with letters and numbers.', false);
      try {
        const r = await fetch('/api/auth/change-password', { method: 'POST', headers: headers(), body: JSON.stringify({ current_password: cur, new_password: nw }) });
        const j = await r.json(); if (!r.ok) throw new Error(j.error || 'Change failed');
        alertUI('Password changed. Please sign in again.'); closePwd();
        localStorage.removeItem('authToken'); localStorage.removeItem('user');
        authToken = null; currentUser = null; refreshTopBar(); showTab('login');
      } catch (e) { alertUI(e.message, false); }
    });

    // ---------- Office Hours tab ----------
    let OFFICE_DATA = [];
    const DAY_ORDER = ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'];
    function dayIdx(d) { const i = DAY_ORDER.indexOf((d || '').slice(0, 3)); return i < 0 ? 99 : i; }
    async function loadOfficeHours() {
      const box = $('#hours-body'); box.innerHTML = '<div class="muted">Loading…</div>';
      try {
        const r = await fetch(OFFICE_URL); const rows = await r.json();
        if (!r.ok) throw new Error(rows.error || 'Failed to load office hours');
        OFFICE_DATA = (rows || []).filter(x => (x.type || '') === 'office_hour');  // keep only office hours
        renderOfficeHours(getCurrentCourseFilter());
      } catch (e) {
        box.innerHTML = ''; alertUI(e.message, false);
      }
    }
    function getCurrentCourseFilter() { const active = $$('#oh-filter .pill.active')[0]; return active?.dataset.course || ''; }
    function renderOfficeHours(filterCourse) {
      const body = $('#hours-body'); body.innerHTML = '';
      const rows = OFFICE_DATA.filter(r => !filterCourse || (r.course_code || r.course) === filterCourse);
      if (!rows.length) { body.innerHTML = '<div class="muted">No office hours found.</div>'; return; }

      // group by course, then sort by day/start_time
      const byCourse = new Map();
      rows.forEach(r => {
        const key = (r.course_code || r.course || 'Other').toUpperCase();
        if (!byCourse.has(key)) byCourse.set(key, []);
        byCourse.get(key).push(r);
      });

      [...byCourse.keys()].sort().forEach(course => {
        const group = document.createElement('div'); group.className = 'oh-group';
        const title = document.createElement('h3'); title.className = 'oh-title'; title.textContent = course; group.append(title);

        const list = byCourse.get(course).slice().sort((a, b) => {
          const da = dayIdx(a.day), db = dayIdx(b.day);
          if (da !== db) return da - db;
          return String(a.start_time).localeCompare(String(b.start_time));
        });

        list.forEach(r => {
          const card = document.createElement('div'); card.className = 'oh-card';
          const who = `${r.staff_name || 'Unknown'}${r.staff_role ? ` (${r.staff_role})` : ''}`;
          card.innerHTML = `
            <div><b>${who}</b></div>
            <div class="oh-meta">
              <span>${r.day || ''}</span>
              <span>${r.start_time || ''}–${r.end_time || ''}</span>
              <span>${r.location || ''}</span>
            </div>`;
          group.append(card);
        });

        body.append(group);
      });
    }
    $('#oh-filter')?.addEventListener('click', e => {
      const pill = e.target.closest('.pill'); if (!pill) return;
      $$('#oh-filter .pill').forEach(p => p.classList.remove('active'));
      pill.classList.add('active');
      renderOfficeHours(getCurrentCourseFilter());
    });

    // init: force logged-out start on Feedback tab
    window.addEventListener('DOMContentLoaded', () => {
      localStorage.removeItem('authToken'); localStorage.removeItem('user');
      authToken = null; currentUser = null; refreshTopBar(); showTab('feedback'); loadFeedback();
    });
  </script>
</body>

</html>