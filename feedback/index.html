<!doctype html>
<html lang="en">

<head>
  <meta charset="utf-8" />
  <title>Learning Assistant Feedback</title>
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <style>
    :root {
      --unl-red: #d00000;
      --unl-red-600: #b30000;
      --ink: #151515;
      --muted: #6a6f76;
      --bg: #f5f6f8;
      --ring: #e6e7eb;
      --chip: #f1f5f9;
      --card: #fff;
      --ok: #065f46;
      --ok-bg: #ecfdf5;
      --bad: #991b1b;
      --bad-bg: #fef2f2;
    }

    *,
    *::before,
    *::after {
      box-sizing: border-box
    }

    html,
    body {
      height: 100%
    }

    body {
      margin: 0;
      color: var(--ink);
      background: var(--bg);
      font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, 'Helvetica Neue', Arial, 'Noto Sans', sans-serif;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }

    a {
      color: var(--unl-red);
      text-decoration: none
    }

    a:hover {
      text-decoration: underline
    }

    .hidden {
      display: none !important
    }

    .shell {
      max-width: 1120px;
      margin: 0 auto;
      padding: 0 16px
    }

    /* Top bar */
    .topbar {
      position: sticky;
      top: 0;
      z-index: 50;
      color: #fff;
      background: linear-gradient(135deg, var(--unl-red), var(--unl-red-600));
      box-shadow: 0 1px 0 rgba(0, 0, 0, .08);
    }

    .brand {
      font-weight: 800;
      letter-spacing: .2px;
      padding-top: 16px
    }

    .sub {
      opacity: .95;
      padding-bottom: 12px
    }

    nav.nav {
      display: flex;
      gap: 10px;
      align-items: center;
      flex-wrap: wrap;
      padding: 10px 0 16px
    }

    .chip {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      cursor: pointer;
      user-select: none;
      color: #fff;
      background: transparent;
      border: 1px solid rgba(255, 255, 255, .6);
      border-radius: 999px;
      padding: 8px 14px;
      font-weight: 700;
      transition: .15s ease;
    }

    .chip:hover {
      background: rgba(255, 255, 255, .1)
    }

    .chip.active {
      background: #fff;
      color: var(--unl-red);
      border-color: #fff
    }

    .badge {
      margin-left: auto;
      display: inline-flex;
      align-items: center;
      gap: 8px;
      background: #fff;
      color: var(--unl-red);
      border: 1px solid rgba(255, 255, 255, .55);
      border-radius: 999px;
      padding: 8px 12px;
      font-weight: 700
    }

    main {
      padding: 18px 0 40px
    }

    .card {
      background: var(--card);
      border: 1px solid var(--ring);
      border-radius: 16px;
      padding: 18px;
      box-shadow: 0 10px 26px rgba(0, 0, 0, .04);
      margin: 18px 0;
    }

    h1,
    h2,
    h3 {
      margin: .25rem 0 .75rem
    }

    h2 {
      font-size: 1.55rem
    }

    .muted {
      color: var(--muted)
    }

    .grid {
      display: grid;
      gap: 14px
    }

    .g-2 {
      grid-template-columns: repeat(2, minmax(0, 1fr))
    }

    .g-3 {
      grid-template-columns: repeat(3, minmax(0, 1fr))
    }

    @media (max-width:900px) {
      .g-3 {
        grid-template-columns: repeat(2, minmax(0, 1fr))
      }
    }

    @media (max-width:640px) {

      .g-3,
      .g-2 {
        grid-template-columns: 1fr
      }
    }

    label {
      display: block;
      font-weight: 700;
      margin: 6px 0
    }

    input,
    select,
    textarea {
      width: 100%;
      padding: 12px 12px;
      border: 1px solid var(--ring);
      border-radius: 12px;
      background: #fff;
      color: var(--ink);
      outline: 0;
      font-size: 1rem;
    }

    input:focus,
    select:focus,
    textarea:focus {
      border-color: #c8cbd1;
      box-shadow: 0 0 0 3px rgba(208, 0, 0, .12);
    }

    .row {
      display: flex;
      gap: 12px;
      align-items: center;
      flex-wrap: wrap
    }

    .push {
      margin-left: auto
    }

    .btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      cursor: pointer;
      border-radius: 12px;
      padding: 10px 16px;
      font-weight: 700;
      border: 1px solid var(--unl-red);
      background: #fff;
      color: var(--unl-red);
      transition: .15s ease;
    }

    .btn:hover {
      filter: brightness(.98)
    }

    .btn-primary {
      background: var(--unl-red);
      color: #fff;
      border-color: var(--unl-red)
    }

    .btn-ghost {
      background: transparent;
      border: 1px solid var(--ring);
      color: #2d2d2d
    }

    /* Alerts */
    #alert {
      border-radius: 12px;
      background: var(--ok-bg);
      color: var(--ok);
      border: 1px solid #a7f3d0;
      padding: 12px 14px;
      font-weight: 700;
      margin-top: 6px
    }

    .alert-error {
      background: var(--bad-bg) !important;
      color: var(--bad) !important;
      border-color: #fecaca !important
    }

    /* Stars */
    .stars {
      display: flex;
      gap: 4px;
      align-items: center
    }

    .star {
      width: 34px;
      height: 34px;
      border-radius: 8px;
      border: 1px solid var(--ring);
      background: #fff;
      cursor: pointer;
      font-size: 18px;
      line-height: 32px;
      text-align: center;
      user-select: none;
    }

    .star.active {
      background: #ffe6e6;
      border-color: #ffbcbc
    }

    .star:hover {
      filter: brightness(.98)
    }

    table {
      width: 100%;
      border-collapse: collapse
    }

    th,
    td {
      padding: 10px;
      border-bottom: 1px solid var(--ring);
      text-align: left;
      font-size: .95rem
    }
  </style>
</head>

<body>
  <!-- Header -->
  <header class="topbar">
    <div class="shell">
      <div class="brand">Learning Assistant Feedback</div>
      <div class="sub">Computer Science &amp; Engineering – University of Nebraska–Lincoln</div>
      <nav class="nav" aria-label="Primary">
        <button class="chip active" data-route="feedback" id="nav-feedback">Feedback</button>
        <button class="chip" data-route="hours" id="nav-hours">Office Hours</button>
        <button class="chip hidden" data-route="dashboard" id="nav-dashboard">Dashboard</button>
        <button class="chip" data-route="login" id="nav-login">Login</button>
        <span id="user-badge" class="badge hidden"></span>
        <button id="btn-logout" class="chip hidden">Log out</button>
      </nav>
    </div>
  </header>

  <main class="shell">
    <div id="alert" class="card hidden" role="status" aria-live="polite"></div>

    <!-- FEEDBACK (inline, no iframe) -->
    <section id="view-feedback" class="card">
      <h2>Submit Feedback</h2>
      <p class="muted">Share course or LA feedback. Submissions are stored in Supabase.</p>

      <form id="feedback-form">
        <div class="grid g-2">
          <div>
            <label for="fb-course">Course</label>
            <select id="fb-course" required>
              <option value="" selected disabled>Select a course</option>
              <option>CSCE 101</option>
              <option>CSCE 155A</option>
              <option>CSCE 155E</option>
              <option>CSCE 155H</option>
              <option>CSCE 156</option>
            </select>
          </div>
          <div>
            <label for="fb-type">Type</label>
            <select id="fb-type" required>
              <option value="" selected disabled>Select a type</option>
              <option>Website</option>
              <option>Comments on Staff</option>
              <option>Comments on the Class</option>
              <option>Office Hours</option>
              <option>Random</option>
              <option>Other</option>
            </select>
          </div>
        </div>

        <div style="margin-top:10px">
          <label>Rating (optional)</label>
          <div class="stars" id="fb-stars" role="radiogroup" aria-label="Star rating 1 to 5">
            <button type="button" class="star" data-val="1" aria-label="1 star">★</button>
            <button type="button" class="star" data-val="2" aria-label="2 stars">★</button>
            <button type="button" class="star" data-val="3" aria-label="3 stars">★</button>
            <button type="button" class="star" data-val="4" aria-label="4 stars">★</button>
            <button type="button" class="star" data-val="5" aria-label="5 stars">★</button>
          </div>
          <input type="hidden" id="fb-rating" value="" />
        </div>

        <div style="margin-top:10px">
          <label for="fb-text">Your feedback</label>
          <textarea id="fb-text" rows="6" placeholder="Share details…" required></textarea>
        </div>

        <div class="grid g-2" style="margin-top:10px">
          <div>
            <label for="fb-name">Your name (optional)</label>
            <input id="fb-name" placeholder="e.g., Pat Student" />
          </div>
          <div>
            <label for="fb-year">Year (optional)</label>
            <select id="fb-year">
              <option value="">Prefer not to say</option>
              <option>Freshman</option>
              <option>Sophomore</option>
              <option>Junior</option>
              <option>Senior</option>
              <option>Graduate</option>
              <option>Other</option>
            </select>
          </div>
        </div>

        <div class="row" style="margin-top:12px">
          <button type="submit" class="btn btn-primary">Submit feedback</button>
          <span class="muted">Thank you for helping us improve!</span>
        </div>
      </form>
    </section>

    <!-- OFFICE HOURS -->
    <section id="view-hours" class="card hidden">
      <h2>Office Hours</h2>
      <p class="muted">Browse office hours by course. Data comes from staff schedules.</p>

      <div class="row" id="hours-filters" style="flex-wrap:wrap; gap:10px; margin-top:10px">
        <button class="chip" data-course="">All</button>
        <button class="chip" data-course="CSCE 101">CSCE 101</button>
        <button class="chip" data-course="CSCE 155A">CSCE 155A</button>
        <button class="chip" data-course="CSCE 155E">CSCE 155E</button>
        <button class="chip" data-course="CSCE 155H">CSCE 155H</button>
        <button class="chip" data-course="CSCE 156">CSCE 156</button>
      </div>

      <div id="hours-list" class="grid g-3" style="margin-top:12px"></div>
    </section>

    <!-- LOGIN -->
    <section id="view-login" class="card hidden" aria-labelledby="login-title">
      <h2 id="login-title">Sign in</h2>
      <form id="login-form" novalidate>
        <div class="grid g-2">
          <div>
            <label for="login-id">NUID or Email</label>
            <input id="login-id" placeholder="12345678 or user@huskers.unl.edu" autocomplete="username" />
          </div>
          <div>
            <label for="login-pass">Password</label>
            <input id="login-pass" type="password" placeholder="Your password" autocomplete="current-password" />
          </div>
        </div>
        <div class="row" style="margin-top:12px">
          <button id="btn-login" type="submit" class="btn btn-primary">Sign in</button>
          <span class="muted">New student? <a href="#" aria-disabled="true">Create an account</a></span>
          <span class="push"></span>
          <button id="btn-open-change-password" type="button" class="btn btn-ghost">Change password</button>
        </div>
      </form>
    </section>

    <!-- DASHBOARD (staff only) -->
    <section id="view-dashboard" class="card hidden">
      <h2>Dashboard</h2>
      <div class="grid g-3">
        <div class="card" style="border:1px solid #eef0f3">
          <h3>Total Feedback</h3>
          <div id="stat-total-feedback" style="font-size:2rem;font-weight:800">0</div>
        </div>
        <div class="card" style="border:1px solid #eef0f3">
          <h3>Average Rating</h3>
          <div id="stat-avg-rating" style="font-size:2rem;font-weight:800">0.0</div>
        </div>
        <div class="card" style="border:1px solid #eef0f3">
          <h3>This Week</h3>
          <div id="stat-this-week" style="font-size:2rem;font-weight:800">0</div>
        </div>
      </div>

      <div class="card" style="border:1px solid #eef0f3;margin-top:12px">
        <h3>My Schedule</h3>
        <table id="tbl-my-schedule" aria-label="My schedule">
          <thead>
            <tr>
              <th>Type</th>
              <th>Day</th>
              <th>Start</th>
              <th>End</th>
              <th>Location</th>
              <th>Course</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td colspan="6" class="muted">No entries.</td>
            </tr>
          </tbody>
        </table>
      </div>
    </section>
  </main>

  <!-- Change Password Modal (hooks are in routes/password.js if you have it) -->
  <div id="modal-change-password" class="hidden" aria-hidden="true"></div>

  <!-- Your existing files -->
  <script defer src="/public/config.js"></script>
  <script defer src="/lib/supabase.js"></script>
  <script defer src="/routes/office-hours.js"></script>
  <script defer src="/routes/auth.js"></script>
  <script defer src="/routes/password.js"></script>
  <script defer src="/routes/staff.js"></script>
  <script defer src="/feedback/feedback.js"></script>

  <!-- Page glue (routing + login wiring + stars UI) -->
  <script>
    (function () {
      const $ = (s, sc = document) => sc.querySelector(s);
      const $$ = (s, sc = document) => Array.from(sc.querySelectorAll(s));

      const sections = {
        feedback: $('#view-feedback'),
        hours: $('#view-hours'),
        login: $('#view-login'),
        dashboard: $('#view-dashboard')
      };
      const alertBox = $('#alert');
      const navDash = $('#nav-dashboard');
      const navLogin = $('#nav-login');
      const userBadge = $('#user-badge');
      const btnLogout = $('#btn-logout');
      const staffRoles = new Set(['SL', 'CL', 'LA']);

      function showAlert(msg, err = false) {
        alertBox.textContent = msg;
        alertBox.classList.toggle('alert-error', !!err);
        alertBox.classList.remove('hidden');
        setTimeout(() => alertBox.classList.add('hidden'), 5000);
      }

      function setRoute(route) {
        $$('.nav .chip').forEach(b => b.classList.toggle('active', b.dataset.route === route));
        Object.entries(sections).forEach(([k, el]) => el.classList.toggle('hidden', k !== route));
        try { sessionStorage.setItem('lap_route', route); } catch (e) { }
      }

      function saveToken(t) { try { localStorage.setItem('lap_jwt', t); } catch (e) { } }
      function getToken() { try { return localStorage.getItem('lap_jwt') } catch (e) { return null } }
      function clearToken() { try { localStorage.removeItem('lap_jwt'); } catch (e) { } }

      async function getMe() {
        const token = getToken();
        if (!token) return null;
        try {
          const res = await fetch('/api/auth/me', { headers: { Authorization: `Bearer ${token}`, 'Accept': 'application/json' } });
          const data = await res.json().catch(() => null);
          if (!res.ok || !data) throw 0;
          return data.user || null;
        } catch { clearToken(); return null; }
      }

      async function applyUserUIFromToken() {
        const user = await getMe();
        const isStaff = user && staffRoles.has(user.role);
        if (user) {
          userBadge.textContent = user.name + (isStaff ? ` (${user.role})` : '');
          userBadge.classList.remove('hidden');
          btnLogout.classList.remove('hidden');
          navLogin.classList.add('hidden');
        } else {
          userBadge.classList.add('hidden');
          btnLogout.classList.add('hidden');
          navLogin.classList.remove('hidden');
        }
        navDash.classList.toggle('hidden', !isStaff);
        const last = (() => { try { return sessionStorage.getItem('lap_route') || 'feedback' } catch (e) { return 'feedback' } })();
        if (last === 'dashboard' && !isStaff) setRoute('feedback');
      }

      // Start on Feedback
      setRoute('feedback');
      applyUserUIFromToken();

      // Nav
      $$('.nav .chip').forEach(btn => {
        btn.addEventListener('click', async () => {
          const route = btn.dataset.route;
          if (route === 'dashboard') {
            const u = await getMe();
            if (!u || !staffRoles.has(u.role)) { showAlert('Dashboard is for staff (SL/CL/LA) only.', true); return; }
          }
          setRoute(route);
        });
      });

      // Logout
      btnLogout.addEventListener('click', async () => {
        const token = getToken();
        try { if (token) await fetch('/api/auth/logout', { method: 'POST', headers: { Authorization: `Bearer ${token}` } }).catch(() => { }); }
        finally { clearToken(); applyUserUIFromToken(); setRoute('feedback'); showAlert('Signed out.'); }
      });

      // Login
      const form = $('#login-form');
      form.addEventListener('submit', (e) => { e.preventDefault(); $('#btn-login').click(); });
      $('#btn-login').addEventListener('click', async () => {
        const id = $('#login-id').value.trim();
        const pw = $('#login-pass').value;
        if (!id || !pw) { showAlert('Missing login or password', true); return; }

        // Prefer window.lapLogin if provided (see routes/auth.js below)
        if (typeof window.lapLogin === 'function') {
          try {
            const out = await window.lapLogin(id, pw); // must return { token, user }
            if (!out || !out.token) throw new Error('Login failed');
            saveToken(out.token);
            await applyUserUIFromToken();
            setRoute('feedback');
            showAlert(`Welcome, ${out.user?.name || 'user'}!`);
            return;
          } catch (err) { showAlert(err.message || 'Login failed', true); return; }
        }

        // Fallback: try multiple payload shapes
        const shapes = [
          { login: id, password: pw },
          { id: id, password: pw },
          { nuid: id, password: pw },
          { email: id, password: pw },
        ];
        for (const body of shapes) {
          try {
            const res = await fetch('/api/auth/login', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json', 'Accept': 'application/json' },
              body: JSON.stringify(body)
            });
            const data = await res.json().catch(() => null);
            if (res.ok && data && data.token) {
              saveToken(data.token);
              await applyUserUIFromToken();
              setRoute('feedback');
              showAlert(`Welcome, ${data.user?.name || 'user'}!`);
              return;
            }
          } catch { }
        }
        showAlert('Invalid credentials', true);
      });

      // Stars UI
      const stars = $$('#fb-stars .star'); const rating = $('#fb-rating');
      stars.forEach(s => {
        s.addEventListener('click', () => {
          const v = Number(s.dataset.val);
          rating.value = String(v);
          stars.forEach(x => x.classList.toggle('active', Number(x.dataset.val) <= v));
        });
      });

      // Hours filter chips -> event that /routes/office-hours.js listens for
      $$('#hours-filters .chip').forEach(chip => {
        chip.addEventListener('click', () => {
          $$('#hours-filters .chip').forEach(c => c.classList.toggle('active', c === chip));
          const course = chip.dataset.course || '';
          document.dispatchEvent(new CustomEvent('lap:filter-hours', { detail: { course } }));
        });
      });
    })();
  </script>
</body>

</html>