<!doctype html>
<html lang="en">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Learning Assistant Feedback • UNL</title>

  <!-- Formal theme -->
  <style>
    :root {
      --unl-red: #c8102e;
      --unl-red-dark: #a00d25;
      --ink: #111827;
      /* text color */
      --muted: #6b7280;
      --bg: #f5f6fa;
      --card: #ffffff;
      --ring: #e5e7eb;
      --shadow: 0 8px 24px rgba(17, 24, 39, .06);
      --star: #f59e0b;
    }

    * {
      box-sizing: border-box
    }

    html,
    body {
      margin: 0;
      padding: 0
    }

    body {
      font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial;
      color: var(--ink);
      background: var(--bg);
    }

    /* Header */
    .topbar {
      background: linear-gradient(135deg, var(--unl-red), var(--unl-red-dark));
      color: #fff;
      padding: 22px 0;
      border-bottom: 1px solid rgba(255, 255, 255, .15);
    }

    .shell {
      max-width: 1100px;
      margin: 0 auto;
      padding: 0 16px
    }

    .brand {
      font-weight: 800;
      font-size: 1.25rem;
      letter-spacing: .2px
    }

    .sub {
      opacity: .9
    }

    /* Nav buttons */
    .nav {
      display: flex;
      gap: 12px;
      align-items: center;
      justify-content: flex-end;
      margin-top: 12px
    }

    .chip {
      background: rgba(255, 255, 255, .14);
      padding: 6px 10px;
      border-radius: 999px
    }

    .btn {
      background: transparent;
      color: #fff;
      border: 1px solid rgba(255, 255, 255, .7);
      padding: 8px 16px;
      border-radius: 999px;
      cursor: pointer;
      font-weight: 600
    }

    .btn.active,
    .btn:hover {
      background: #fff;
      color: var(--unl-red)
    }

    .btn-ghost {
      background: #fff;
      color: var(--unl-red);
      border-color: #fff
    }

    .btn-muted {
      background: #fff;
      color: var(--ink);
      border: 1px solid var(--ring)
    }

    /* Cards/sections */
    main {
      padding: 24px 0 40px
    }

    .card {
      background: var(--card);
      border: 1px solid var(--ring);
      border-radius: 16px;
      box-shadow: var(--shadow);
      padding: 20px;
      margin-top: 18px;
    }

    h1,
    h2 {
      margin: 8px 0 12px
    }

    p.lead {
      color: var(--muted);
      margin-top: 0
    }

    /* Form controls (fixes white-on-white) */
    label {
      font-weight: 600
    }

    .row {
      display: grid;
      gap: 10px;
      margin-bottom: 12px
    }

    input,
    select,
    textarea {
      width: 100%;
      border: 1px solid var(--ring);
      border-radius: 10px;
      padding: 10px 12px;
      background: #fff;
      color: var(--ink);
      min-height: 44px;
    }

    input::placeholder,
    textarea::placeholder {
      color: #9ca3af
    }

    textarea {
      min-height: 120px
    }

    .actions {
      display: flex;
      gap: 10px;
      align-items: center
    }

    .btn-primary {
      background: var(--unl-red);
      color: #fff;
      border: 1px solid var(--unl-red);
      padding: 10px 16px;
      border-radius: 10px;
      font-weight: 700;
      cursor: pointer
    }

    .btn-primary:hover {
      background: var(--unl-red-dark)
    }

    .hidden {
      display: none !important
    }

    /* grid */
    .grid {
      display: grid;
      gap: 14px
    }

    @media (min-width:860px) {
      .g-2 {
        grid-template-columns: repeat(2, minmax(0, 1fr));
      }
    }

    /* tabs */
    .tabs {
      display: flex;
      gap: 8px;
      margin: 6px 0 2px
    }

    .tab {
      background: #fff;
      border: 1px solid var(--ring);
      color: var(--ink);
      padding: 8px 14px;
      border-radius: 999px;
      cursor: pointer;
      font-weight: 600
    }

    .tab.active {
      background: var(--unl-red);
      color: #fff;
      border-color: var(--unl-red)
    }

    /* stars */
    .stars {
      display: flex;
      gap: 6px;
      align-items: center
    }

    .star {
      font-size: 28px;
      cursor: pointer;
      color: #d3d6de;
      line-height: 1
    }

    .star.active {
      color: var(--star)
    }

    /* alerts */
    .alert {
      padding: 12px 14px;
      border-radius: 10px;
      font-weight: 600;
      margin: 8px 0
    }

    .alert-error {
      background: #fff1f2;
      color: #9f1239;
      border: 1px solid #fecdd3
    }

    .alert-success {
      background: #ecfdf5;
      color: #065f46;
      border: 1px solid #a7f3d0
    }
  </style>
</head>

<body>
  <!-- ===== HEADER ===== -->
  <header class="topbar">
    <div class="shell">
      <div class="grid g-2" style="align-items:center">
        <div>
          <div class="brand">Learning Assistant Feedback</div>
          <div class="sub">Computer Science &amp; Engineering — University of Nebraska–Lincoln</div>
        </div>
        <nav class="nav">
          <button class="btn" data-nav="feedback">Feedback</button>
          <button class="btn" data-nav="office">Office Hours</button>
          <button id="login-tab" class="btn" data-nav="login">Login</button>
          <span id="user-chip" class="chip hidden"></span>
          <button id="logout-btn" class="btn hidden">Log out</button>
        </nav>
      </div>
    </div>
  </header>

  <main class="shell">
    <!-- ===== TABS VISUAL (optional, we also wire header buttons) ===== -->
    <div class="tabs">
      <button class="tab active" data-nav="feedback">Feedback</button>
      <button class="tab" data-nav="office">Office Hours</button>
      <button class="tab" data-nav="login">Login</button>
    </div>

    <!-- ===== FEEDBACK (default) ===== -->
    <section id="section-feedback" class="card">
      <h2>Submit Feedback</h2>
      <p class="lead">Share course or LA feedback. Submissions are stored in Supabase.</p>

      <form id="feedback-form" class="grid">
        <div class="g-2">
          <div class="row">
            <label for="course">Course</label>
            <select id="course" name="course" required>
              <option value="">Select a course…</option>
              <option>CSCE 101</option>
              <option>CSCE 155A</option>
              <option>CSCE 155E</option>
              <option>CSCE 155H</option>
              <option>CSCE 156</option>
            </select>
          </div>
          <div class="row">
            <label for="type">Type</label>
            <select id="type" name="type" required>
              <option value="">Select type…</option>
              <option>Website</option>
              <option>Staff</option>
              <option>Class</option>
              <option>Office Hours</option>
              <option>Random</option>
              <option>Other</option>
            </select>
          </div>
        </div>

        <div class="row">
          <label>Rating</label>
          <div id="stars" class="stars">
            <span class="star" data-v="1">★</span>
            <span class="star" data-v="2">★</span>
            <span class="star" data-v="3">★</span>
            <span class="star" data-v="4">★</span>
            <span class="star" data-v="5">★</span>
          </div>
          <input type="hidden" id="rating" name="rating" value="0" />
        </div>

        <div class="row">
          <label for="text">Your feedback</label>
          <textarea id="text" name="text" placeholder="Share details…"></textarea>
        </div>

        <div class="g-2">
          <div class="row">
            <label for="submitter">Your name (optional)</label>
            <input id="submitter" name="submitter" placeholder="First Last" />
          </div>
          <div class="row">
            <label for="year">Year (optional)</label>
            <select id="year" name="year">
              <option value="">Prefer not to say</option>
              <option>Freshman</option>
              <option>Sophomore</option>
              <option>Junior</option>
              <option>Senior</option>
              <option>Graduate</option>
            </select>
          </div>
        </div>

        <div id="fb-alert" class="alert hidden"></div>

        <div class="actions">
          <button id="fb-submit" type="submit" class="btn-primary">Submit feedback</button>
        </div>
      </form>
    </section>

    <!-- ===== OFFICE HOURS ===== -->
    <section id="section-office" class="card hidden">
      <h2>Office Hours</h2>
      <p class="lead">Browse office hours by course. Data comes from staff schedules.</p>

      <div class="tabs" id="course-filter">
        <button class="tab active" data-course="ALL">All</button>
        <button class="tab" data-course="CSCE 101">CSCE 101</button>
        <button class="tab" data-course="CSCE 155A">CSCE 155A</button>
        <button class="tab" data-course="CSCE 155E">CSCE 155E</button>
        <button class="tab" data-course="CSCE 155H">CSCE 155H</button>
        <button class="tab" data-course="CSCE 156">CSCE 156</button>
      </div>

      <div id="office-alert" class="alert hidden"></div>
      <div id="office-list" class="grid"></div>
    </section>

    <!-- ===== LOGIN ===== -->
    <section id="section-login" class="card hidden">
      <h2>Sign in</h2>
      <p class="lead">Staff and students sign in with NUID (or @huskers.unl.edu) and password.</p>

      <div id="login-alert" class="alert hidden"></div>
      <form id="login-form" class="grid g-2" novalidate>
        <div class="row">
          <label for="login-input">NUID or Email</label>
          <input id="login-input" name="login" type="text" placeholder="12345678 or user@huskers.unl.edu"
            autocomplete="username" required />
        </div>
        <div class="row">
          <label for="password-input">Password</label>
          <input id="password-input" name="password" type="password" autocomplete="current-password" required />
        </div>
        <div class="actions">
          <button id="login-btn" type="submit" class="btn-primary">Sign in</button>
          <button id="change-pass-btn" type="button" class="btn-muted">Change password</button>
        </div>
      </form>
    </section>
  </main>

  <!-- ===== PAGE SCRIPTS ===== -->
  <script>
    /* ---------- helpers ---------- */
    const $ = (s, r = document) => r.querySelector(s);
    const $$ = (s, r = document) => Array.from(r.querySelectorAll(s));
    const show = id => { ['feedback', 'office', 'login'].forEach(k => $('#section-' + k).classList.toggle('hidden', k !== id)); setActives(id); };
    const setActives = id => {
      $$('[data-nav]').forEach(b => b.classList.toggle('active', b.dataset.nav === id));
      $$('.tab[data-nav]').forEach(b => b.classList.toggle('active', b.dataset.nav === id));
      history.replaceState(null, '', '#' + id);
    };

    /* ---------- tab/nav wiring ---------- */
    $$('.btn[data-nav], .tab[data-nav]').forEach(b => b.addEventListener('click', () => show(b.dataset.nav)));
    show((location.hash || '#feedback').slice(1));

    /* ---------- stars ---------- */
    (function () {
      const stars = $$('#stars .star');
      const hidden = $('#rating');
      const paint = n => stars.forEach(s => s.classList.toggle('active', Number(s.dataset.v) <= n));
      stars.forEach(s => {
        s.addEventListener('mouseenter', () => paint(Number(s.dataset.v)));
        s.addEventListener('mouseleave', () => paint(Number(hidden.value || 0)));
        s.addEventListener('click', () => { hidden.value = s.dataset.v; paint(Number(hidden.value)); });
      });
    })();

    /* ---------- Feedback submit -> POST /api/feedback ---------- */
    (function () {
      const form = $('#feedback-form'); if (!form) return;
      const btn = $('#fb-submit');
      const alert = $('#fb-alert');
      const ok = (m) => { alert.className = 'alert alert-success'; alert.textContent = m; alert.classList.remove('hidden'); };
      const bad = (m) => { alert.className = 'alert alert-error'; alert.textContent = m; alert.classList.remove('hidden'); };

      form.addEventListener('submit', async (e) => {
        e.preventDefault();
        alert.classList.add('hidden'); alert.textContent = '';
        const fd = new FormData(form);
        const payload = {
          course: fd.get('course') || '',
          type: fd.get('type') || '',
          rating: Number($('#rating').value || 0) || null,
          text: fd.get('text') || '',
          submitter: fd.get('submitter') || '',
          year: fd.get('year') || ''
        };
        if (!payload.course || !payload.type) { bad('Please select a course and type.'); return; }
        btn.disabled = true; btn.textContent = 'Submitting…';
        try {
          const res = await fetch('/api/feedback', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
          });
          let data = {}; try { data = await res.json(); } catch { }
          if (!res.ok) throw new Error(data?.message || 'Submit failed');
          ok('Thanks! Your feedback was submitted.');
          form.reset(); $('#rating').value = 0; $$('#stars .star').forEach(s => s.classList.remove('active'));
        } catch (err) { bad(err.message || 'Could not submit feedback.'); }
        finally { btn.disabled = false; btn.textContent = 'Submit feedback'; }
      });
    })();

    /* ---------- Office hours list -> GET /api/office-hours ---------- */
    (function () {
      const list = $('#office-list'); if (!list) return;
      const alert = $('#office-alert');
      const render = (rows) => {
        list.innerHTML = '';
        if (!rows.length) { alert.className = 'alert alert-error'; alert.textContent = 'No office hours to show.'; alert.classList.remove('hidden'); return; }
        alert.classList.add('hidden'); alert.textContent = '';
        rows.forEach(r => {
          const div = document.createElement('div');
          div.className = 'card';
          div.innerHTML = `
            <div class="grid g-2" style="align-items:center">
              <div>
                <div style="font-weight:700">${r.course} • ${r.day} ${r.start}–${r.end}</div>
                <div class="sub">Location: ${r.location || 'TBA'}</div>
              </div>
              <div style="text-align:right"><span class="chip">${r.staff_name || r.nuid}</span></div>
            </div>`;
          list.appendChild(div);
        });
      };
      let ALL = [];
      const load = async () => {
        try { const res = await fetch('/api/office-hours'); ALL = await res.json(); if (!Array.isArray(ALL)) ALL = []; }
        catch { ALL = []; }
        render(ALL);
      };
      load();
      $$('#course-filter .tab').forEach(tab => {
        tab.addEventListener('click', () => {
          $$('#course-filter .tab').forEach(t => t.classList.toggle('active', t === tab));
          const c = tab.dataset.course;
          render(c === 'ALL' ? ALL : ALL.filter(x => x.course === c));
        });
      });
    })();

    /* ---------- Login -> POST /api/auth/login (Enter or click) ---------- */
    (function () {
      const form = $('#login-form'); if (!form) return;
      const alert = $('#login-alert');
      const userChip = $('#user-chip');
      const logoutBtn = $('#logout-btn');
      const loginTab = $('#login-tab');

      const ok = (m) => { alert.className = 'alert alert-success'; alert.textContent = m; alert.classList.remove('hidden'); };
      const bad = (m) => { alert.className = 'alert alert-error'; alert.textContent = m; alert.classList.remove('hidden'); };

      const LOGIN_URL = '/api/auth/login'; // <-- change if your backend uses a different path

      form.addEventListener('submit', async (e) => {
        e.preventDefault();
        alert.classList.add('hidden'); alert.textContent = '';
        const login = $('#login-input').value.trim();
        const password = $('#password-input').value;
        if (!login || !password) { bad('Missing login or password'); return; }

        try {
          const res = await fetch(LOGIN_URL, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            credentials: 'include',
            body: JSON.stringify({ login, password })
          });
          let data = {}; try { data = await res.json(); } catch { }
          if (res.status === 404) { bad('Login route not found (404). Ensure your server exposes POST ' + LOGIN_URL); return; }
          if (!res.ok) throw new Error(data?.message || 'Invalid credentials');

          // success – show user + hide Login button; default to feedback
          const who = data?.name || data?.email || login;
          userChip.textContent = who + (data?.role ? ` (${data.role})` : '');
          userChip.classList.remove('hidden');
          logoutBtn.classList.remove('hidden');
          loginTab.classList.add('hidden');
          ok('Signed in.');
          show('feedback');
        } catch (err) {
          bad(err.message || 'Login failed');
        }
      });

      // log out (optional API)
      logoutBtn.addEventListener('click', async () => {
        try { await fetch('/api/auth/logout', { method: 'POST', credentials: 'include' }); } catch { }
        userChip.classList.add('hidden'); userChip.textContent = '';
        logoutBtn.classList.add('hidden'); $('#login-tab').classList.remove('hidden');
        show('feedback');
      });
    })();
  </script>
</body>

</html>