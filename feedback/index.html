<!doctype html>
<html lang="en">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Learning Assistant Feedback • UNL</title>
  <style>
    :root {
      --unl: #c8102e;
      --unl2: #a00d25;
      --ink: #111827;
      --muted: #6b7280;
      --bg: #f5f6fa;
      --card: #fff;
      --ring: #e5e7eb;
      --shadow: 0 8px 24px rgba(17, 24, 39, .06);
      --star: #f59e0b
    }

    * {
      box-sizing: border-box
    }

    html,
    body {
      margin: 0;
      padding: 0
    }

    body {
      font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
      background: var(--bg);
      color: var(--ink)
    }

    .topbar {
      background: linear-gradient(135deg, var(--unl), var(--unl2));
      color: #fff;
      padding: 18px 0;
      border-bottom: 1px solid rgba(255, 255, 255, .15)
    }

    .shell {
      max-width: 1100px;
      margin: 0 auto;
      padding: 0 16px
    }

    .brand {
      font-weight: 800;
      font-size: 1.25rem
    }

    .sub {
      opacity: .9
    }

    .navrow {
      display: flex;
      gap: 10px;
      align-items: center;
      justify-content: space-between;
      margin-top: 10px
    }

    .nav {
      display: flex;
      gap: 10px;
      align-items: center;
      flex-wrap: wrap
    }

    .btn {
      background: transparent;
      color: #fff;
      border: 1px solid rgba(255, 255, 255, .75);
      padding: 8px 14px;
      border-radius: 999px;
      font-weight: 600;
      cursor: pointer
    }

    .btn:hover,
    .btn.active {
      background: #fff;
      color: var(--unl)
    }

    main {
      padding: 22px 0 40px
    }

    .card {
      background: var(--card);
      border: 1px solid var(--ring);
      border-radius: 16px;
      box-shadow: var(--shadow);
      padding: 20px;
      margin-top: 18px
    }

    h1,
    h2 {
      margin: 8px 0 12px
    }

    .lead {
      color: var(--muted)
    }

    .hidden {
      display: none !important
    }

    label {
      font-weight: 600
    }

    .grid {
      display: grid;
      gap: 14px
    }

    .g-2 {
      grid-template-columns: repeat(2, minmax(0, 1fr))
    }

    .g-3 {
      grid-template-columns: repeat(3, minmax(0, 1fr))
    }

    @media(max-width:980px) {
      .g-3 {
        grid-template-columns: 1fr
      }
    }

    @media(max-width:860px) {
      .g-2 {
        grid-template-columns: 1fr
      }
    }

    input,
    select,
    textarea {
      width: 100%;
      min-height: 44px;
      border: 1px solid var(--ring);
      border-radius: 10px;
      padding: 10px 12px;
      background: #fff;
      color: #111
    }

    textarea {
      min-height: 120px
    }

    .actions {
      display: flex;
      gap: 10px;
      flex-wrap: wrap
    }

    .btn-primary {
      background: var(--unl);
      border: 1px solid var(--unl);
      color: #fff;
      padding: 10px 16px;
      border-radius: 10px;
      font-weight: 700;
      cursor: pointer
    }

    .btn-primary:hover {
      background: var(--unl2)
    }

    .btn-muted {
      background: #fff;
      border: 1px solid var(--ring);
      color: #000;
      padding: 10px 16px;
      border-radius: 10px;
      font-weight: 600
    }

    .pills {
      display: flex;
      gap: 8px;
      flex-wrap: wrap
    }

    .pill {
      background: #fff;
      border: 1px solid var(--ring);
      border-radius: 999px;
      padding: 8px 14px;
      font-weight: 600;
      cursor: pointer
    }

    .pill.active {
      background: var(--unl);
      border-color: var(--unl);
      color: #fff
    }

    .stars {
      display: flex;
      gap: 6px
    }

    .star {
      font-size: 28px;
      cursor: pointer;
      color: #d3d6de
    }

    .star.active {
      color: var(--star)
    }

    .alert {
      padding: 12px 14px;
      border-radius: 10px;
      font-weight: 600;
      margin: 8px 0
    }

    .alert-error {
      background: #fff1f2;
      color: #9f1239;
      border: 1px solid #fecdd3
    }

    .alert-success {
      background: #ecfdf5;
      color: #065f46;
      border: 1px solid #a7f3d0
    }

    .table {
      width: 100%;
      border-collapse: collapse
    }

    .table th,
    .table td {
      border-bottom: 1px solid var(--ring);
      padding: 10px 8px;
      text-align: left
    }

    .table th {
      color: var(--muted);
      font-weight: 700
    }

    .tag {
      background: #eef2ff;
      color: #3730a3;
      padding: 2px 8px;
      border-radius: 999px;
      font-size: .825rem
    }

    .chip {
      background: rgba(255, 255, 255, .14);
      padding: 6px 10px;
      border-radius: 999px
    }

    .link {
      color: var(--unl);
      font-weight: 700;
      cursor: pointer
    }

    .row-actions {
      display: flex;
      gap: 10px
    }

    .badge {
      background: #f3f4f6;
      border: 1px solid #e5e7eb;
      border-radius: 999px;
      padding: 3px 8px;
      font-size: .78rem;
      color: #374151
    }
  </style>

  <script>
    /* session + nav */
    (function () {
      const PAGES = ['feedback', 'office', 'login', 'dashboard'];
      const $ = (s, r = document) => r.querySelector(s), $$ = (s, r = document) => Array.from(r.querySelectorAll(s));
      const readSession = () => { for (const k of ['lap_auth_v1', 'lap_auth']) { try { const v = localStorage.getItem(k); if (v) return JSON.parse(v) } catch { } } return {} };
      const getUser = () => readSession().user || null;
      const hasToken = () => !!readSession().token;
      const roleStr = () => String(getUser()?.role || '').toUpperCase();
      const isSLorAdmin = () => ['SL', 'ADMIN'].some(r => roleStr().includes(r));

      function show(id) {
        if (!PAGES.includes(id)) id = 'feedback';
        PAGES.forEach(k => $('#section-' + k)?.classList.toggle('hidden', k !== id));
        $$('[data-nav]').forEach(b => b.classList.toggle('active', b?.dataset?.nav === id));
        if (location.hash !== '#' + id) history.replaceState(null, '', '#' + id);
        if (id === 'dashboard' && hasToken()) {
          try { window.loadSchedule?.() } catch { }
          try { window.loadMyFeedback?.() } catch { }
          if (isSLorAdmin()) try { window.loadAdmin?.() } catch { }
        }
      }
      window.__lap_show = show;

      function paintNav() {
        const authed = hasToken();
        const name = (getUser()?.name || getUser()?.full_name || getUser()?.email) || '';
        const greet = $('#lap-user-greeting'); if (greet) { greet.textContent = authed ? `Signed in as ${name}` : ''; greet.classList.toggle('hidden', !authed); }
        $('#login-tab')?.classList.toggle('hidden', authed);
        $('#logout-btn')?.classList.toggle('hidden', !authed);
        $('#dashboard-tab')?.classList.toggle('hidden', !authed);
        $('#my-feedback')?.classList.toggle('hidden', !authed);
        $('#admin-block')?.classList.toggle('hidden', !(authed && isSLorAdmin()));
      }
      window.__lap_paintNav = paintNav;

      function bindNav() { $$('[data-nav]').forEach(b => { if (b.__bound) return; b.__bound = true; b.addEventListener('click', () => show(b.dataset.nav), { passive: true }); }); }

      function refreshAll() {
        __lap_paintNav?.();
        if (hasToken()) {
          try { window.loadSchedule?.(); } catch { }
          try { window.loadMyFeedback?.(); } catch { }
          if (isSLorAdmin()) try { window.loadAdmin?.() } catch { }
        }
      }
      window.__lap_refreshAll = refreshAll;

      window.addEventListener('DOMContentLoaded', () => {
        bindNav(); paintNav();
        const initial = hasToken() ? 'dashboard' : 'feedback';
        show((location.hash || '').replace('#', '') || initial);
        refreshAll();
        $('#logout-btn')?.addEventListener('click', async () => {
          try { await fetch('/api/auth/logout', { method: 'POST', credentials: 'include' }) } catch { }
          localStorage.removeItem('lap_auth'); localStorage.removeItem('lap_auth_v1');
          location.hash = '#feedback'; location.reload();
        });
      });
      window.addEventListener('hashchange', () => { show((location.hash || '').replace('#', '')); refreshAll(); });
      window.addEventListener('focus', refreshAll);
      document.addEventListener('visibilitychange', () => { if (document.visibilityState === 'visible') refreshAll(); });
    })();
  </script>
</head>

<body>
  <header class="topbar">
    <div class="shell">
      <div class="brand">Learning Assistant Feedback</div>
      <div class="sub">Computer Science &amp; Engineering — University of Nebraska–Lincoln</div>
      <div style="margin-top:8px"><span id="lap-user-greeting" class="chip hidden" aria-live="polite"></span></div>
      <div class="navrow">
        <nav class="nav">
          <button class="btn" type="button" data-nav="feedback" onclick="__lap_show('feedback')">Feedback</button>
          <button class="btn" type="button" data-nav="office" onclick="__lap_show('office')">Office Hours</button>
          <button id="dashboard-tab" class="btn hidden" type="button" data-nav="dashboard"
            onclick="__lap_show('dashboard')">Dashboard</button>
          <button id="login-tab" class="btn" type="button" data-nav="login" onclick="__lap_show('login')">Login</button>
        </nav>
        <button id="logout-btn" class="btn hidden" type="button"
          onclick="try{fetch('/api/auth/logout',{method:'POST',credentials:'include'})}catch(e){};localStorage.removeItem('lap_auth');localStorage.removeItem('lap_auth_v1');location.hash='#feedback';location.reload();">
          Log out
        </button>
      </div>
    </div>
  </header>

  <main class="shell">
    <!-- FEEDBACK SUBMIT -->
    <section id="section-feedback" class="card">
      <h2>Submit Feedback</h2>
      <p class="lead">Share course / LA feedback. Stored in Supabase.</p>
      <form id="feedback-form" class="grid" novalidate>
        <div class="grid g-2">
          <div><label>Course</label>
            <select id="course" required>
              <option value="">Select a course…</option>
              <option>CSCE 101</option>
              <option>CSCE 155A</option>
              <option>CSCE 155E</option>
              <option>CSCE 155H</option>
              <option>CSCE 156</option>
            </select>
          </div>
          <div><label>Type</label>
            <select id="type" required>
              <option value="">Select type…</option>
              <option>Website</option>
              <option>Staff</option>
              <option>Class</option>
              <option>Office Hours</option>
              <option>Random</option>
              <option>Other</option>
            </select>
          </div>
        </div>
        <div>
          <label>Rating</label>
          <div id="stars" class="stars"><span class="star" data-v="1">★</span><span class="star"
              data-v="2">★</span><span class="star" data-v="3">★</span><span class="star" data-v="4">★</span><span
              class="star" data-v="5">★</span></div>
          <input type="hidden" id="rating" value="0" />
        </div>
        <div><label>Your feedback</label><textarea id="text" placeholder="Share details…"></textarea></div>
        <div class="grid g-2">
          <div><label>Your name (optional)</label><input id="submitter" placeholder="First Last" /></div>
          <div><label>Year (optional)</label>
            <select id="year">
              <option value="">Prefer not to say</option>
              <option>Freshman</option>
              <option>Sophomore</option>
              <option>Junior</option>
              <option>Senior</option>
              <option>Graduate</option>
            </select>
          </div>
        </div>
        <div id="fb-alert" class="alert hidden"></div>
        <div class="actions"><button id="fb-submit" class="btn-primary" type="submit">Submit feedback</button></div>
      </form>
    </section>

    <!-- OFFICE HOURS (READ) -->
    <section id="section-office" class="card hidden">
      <h2>Office Hours</h2>
      <p class="lead">Browse office hours by course.</p>
      <div class="pills" id="course-filter">
        <button class="pill active" type="button" data-course="ALL">All</button>
        <button class="pill" type="button" data-course="CSCE 101">CSCE 101</button>
        <button class="pill" type="button" data-course="CSCE 155A">CSCE 155A</button>
        <button class="pill" type="button" data-course="CSCE 155E">CSCE 155E</button>
        <button class="pill" type="button" data-course="CSCE 155H">CSCE 155H</button>
        <button class="pill" type="button" data-course="CSCE 156">CSCE 156</button>
      </div>
      <div id="office-alert" class="alert hidden"></div>
      <div id="office-list" class="grid"></div>
    </section>

    <!-- LOGIN -->
    <section id="section-login" class="card hidden">
      <h2>Sign in</h2>
      <p class="lead">Use NUID or @huskers.unl.edu + password.</p>
      <div id="login-alert" class="alert hidden"></div>
      <form id="login-form" class="grid g-2" novalidate>
        <div><label>NUID or Email</label><input id="login-input" autocomplete="username" required></div>
        <div><label>Password</label><input id="password-input" type="password" autocomplete="current-password" required>
        </div>
        <div class="actions"><button id="login-btn" class="btn-primary" type="submit">Sign in</button></div>
      </form>
    </section>

    <!-- DASHBOARD -->
    <section id="section-dashboard" class="hidden">
      <div class="card">
        <h2>My Schedule</h2>
        <p class="lead">Add, edit, or remove your office hours.</p>
        <div id="sched-alert" class="alert hidden"></div>

        <form id="sched-form" class="grid g-3" novalidate>
          <div><label>Course</label>
            <select id="sched-course" required>
              <option value="">Select…</option>
              <option>CSCE 101</option>
              <option>CSCE 155A</option>
              <option>CSCE 155E</option>
              <option>CSCE 155H</option>
              <option>CSCE 156</option>
            </select>
          </div>
          <div><label>Day</label>
            <select id="sched-day" required>
              <option value="">Select…</option>
              <option>Mon</option>
              <option>Tue</option>
              <option>Wed</option>
              <option>Thu</option>
              <option>Fri</option>
            </select>
          </div>
          <div><label>Location</label><input id="sched-location" placeholder="Avery 12 / Zoom…" /></div>
          <div><label>Start</label><input id="sched-start" type="time" required /></div>
          <div><label>End</label><input id="sched-end" type="time" required /></div>
          <div><label>Type</label>
            <select id="sched-type" required>
              <option value="office_hour" selected>Office Hour</option>
              <option value="lab_time">Lab Time</option>
            </select>
          </div>
          <div class="actions"><button id="sched-save" class="btn-primary" type="submit">Add to schedule</button><button
              id="sched-cancel" class="btn-muted" type="button" style="display:none">Cancel edit</button></div>
        </form>

        <table class="table" id="sched-table" style="margin-top:10px">
          <thead>
            <tr>
              <th>Course</th>
              <th>Day</th>
              <th>Start</th>
              <th>End</th>
              <th>Location</th>
              <th></th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>

      <div id="my-feedback" class="card hidden">
        <h2>My Feedback</h2>
        <p class="lead">Feedback items for your course(s).</p>
        <div id="myfb-alert" class="alert hidden"></div>
        <ul id="myfb-list"></ul>
      </div>

      <div id="admin-block" class="card hidden">
        <h2>SL Admin</h2>
        <p class="lead">Manage staff and pending students.</p>

        <h3>Add / Edit staff</h3>
        <div id="staff-alert" class="alert hidden"></div>
        <form id="staff-form" class="grid g-3" novalidate>
          <input type="hidden" id="staff-edit-id" value="" />
          <div><label>NUID</label><input id="staff-nuid" required /></div>
          <div><label>Name</label><input id="staff-name" required /></div>
          <div><label>Email</label><input id="staff-email" placeholder="user@huskers.unl.edu" /></div>
          <div><label>Role</label><select id="staff-role" required>
              <option value="">Select…</option>
              <option>SL</option>
              <option>CL</option>
              <option>LA</option>
            </select></div>
          <div>
            <label>Courses</label>
            <select id="staff-courses" multiple size="6">
              <option value="CSCE 101">CSCE 101</option>
              <option value="CSCE 155A">CSCE 155A</option>
              <option value="CSCE 155E">CSCE 155E</option>
              <option value="CSCE 155H">CSCE 155H</option>
              <option value="CSCE 156">CSCE 156</option>
            </select>
            <div class="sub" style="color:var(--muted);margin-top:6px">Hold Ctrl/⌘ to select multiple</div>
          </div>
          <div class="actions"><button id="staff-add" class="btn-primary" type="submit">Save staff</button><button
              id="staff-cancel" class="btn-muted" type="button">Cancel</button></div>
        </form>

        <h3 style="margin-top:16px">Staff list</h3>
        <div id="staff-empty" class="alert hidden"></div>
        <table class="table" id="staff-table">
          <thead>
            <tr>
              <th>NUID</th>
              <th>Name</th>
              <th>Email</th>
              <th>Role</th>
              <th>Course(s)</th>
              <th></th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>

        <h3 style="margin-top:16px">Pending students</h3>
        <div id="pending-alert" class="alert hidden"></div>
        <table class="table" id="pending-table">
          <thead>
            <tr>
              <th>Name</th>
              <th>NUID</th>
              <th>Email</th>
              <th>Course</th>
              <th></th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </section>
  </main>

  <!-- Supabase config -->
  <script>
    window.SUPABASE_URL = window.SUPABASE_URL || 'https://wmeijbsvlnjvnhptudfh.supabase.co';
    window.SUPABASE_ANON_KEY = window.SUPABASE_ANON_KEY || 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6IndtZWlqYnN2bG5qdm5ocHR1ZGZoIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTU4MDQ5NzksImV4cCI6MjA3MTM4MDk3OX0.YT_435s_FFsqNJs6M_yW9iIGzxeCu1BHpPVH1cwJlX8';
  </script>

  <!-- App logic -->
  <script>
    (function () {
      const $ = (s, r = document) => r.querySelector(s), $$ = (s, r = document) => Array.from(r.querySelectorAll(s));
      const SB = () => ({ URL: (window.SUPABASE_URL || '').replace(/\/+$/, ''), KEY: window.SUPABASE_ANON_KEY || '' });
      const H = k => ({ apikey: k, Authorization: `Bearer ${k}`, Accept: 'application/json', 'Content-Type': 'application/json', Prefer: 'return=representation' });
      const readSession = () => { for (const k of ['lap_auth_v1', 'lap_auth']) { try { const v = localStorage.getItem(k); if (v) return JSON.parse(v) } catch { } } return {} };
      const getUser = () => readSession().user || null;
      const roleStr = () => String(getUser()?.role || '').toUpperCase();
      const isSLorAdmin = () => ['SL', 'ADMIN'].some(r => roleStr().includes(r));
      const toHHMMSS = t => t ? (/^\d{1,2}:\d{2}$/.test(t) ? t + ':00' : t) : '';

      /* Feedback submit (unchanged) */
      (function () {
        const wrap = $('#stars'); if (!wrap) return; const rating = $('#rating');
        wrap.querySelectorAll('.star').forEach(s => s.addEventListener('click', () => { rating.value = s.dataset.v; wrap.querySelectorAll('.star').forEach(x => x.classList.toggle('active', Number(x.dataset.v) <= Number(rating.value))); }));
        $('#feedback-form')?.addEventListener('submit', async e => {
          e.preventDefault(); const alert = $('#fb-alert'); alert.classList.add('hidden');
          const body = { course: $('#course').value.trim(), type: $('#type').value.trim(), rating: Number($('#rating').value) || null, text: $('#text').value.trim(), submitter: $('#submitter').value.trim(), year: $('#year').value || null };
          try {
            const { URL, KEY } = SB(); if (!URL || !KEY) throw new Error('Supabase not configured');
            const r = await fetch(`${URL}/rest/v1/feedback`, { method: 'POST', headers: H(KEY), body: JSON.stringify(body) });
            if (!r.ok) { let j = null; try { j = await r.clone().json() } catch { } throw new Error(j?.message || j?.hint || j?.details || `${r.status}`); }
            alert.className = 'alert alert-success'; alert.textContent = 'Thanks! Your feedback was submitted.'; alert.classList.remove('hidden'); e.target.reset(); wrap.querySelectorAll('.star').forEach(x => x.classList.remove('active')); $('#rating').value = '0';
          } catch (err) { alert.className = 'alert alert-error'; alert.textContent = String(err?.message || err); alert.classList.remove('hidden'); }
        });
      })();

      /* Office hours list (READ) */
      (async function () {
        const list = $('#office-list'); if (!list) return; const alert = $('#office-alert');
        const map = r => ({ id: r.id || null, course: (r.course ?? r.course_code ?? '').toString(), day: r.day ?? r.weekday ?? r.day_of_week ?? '', start: r.start ?? r.start_time ?? '', end: r.end ?? r.end_time ?? '', location: r.location ?? r.room ?? '', staff_name: r.staff_name ?? r.name ?? '' });
        const dedupe = a => { const s = new Set(); return a.filter(x => { const k = [x.course, x.day, x.start, x.end, x.location, x.staff_name].join('|'); if (s.has(k)) return false; s.add(k); return true; }); };
        let rows = [];
        try {
          const { URL, KEY } = SB(); if (URL && KEY) {
            const r1 = await fetch(`${URL}/rest/v1/office_hours_public?select=*`, { headers: H(KEY) });
            if (r1.ok) { rows = rows.concat((await r1.json().catch(() => [])).map(map)); }
            const r2 = await fetch(`${URL}/rest/v1/staff_schedules?select=*&type=eq.office_hour`, { headers: H(KEY) });
            if (r2.ok) { rows = rows.concat((await r2.json().catch(() => [])).map(map)); }
          }
        } catch { }
        if (!rows.length) { alert.className = 'alert alert-error'; alert.textContent = 'No office hours to show.'; alert.classList.remove('hidden'); return; }
        alert.classList.add('hidden');
        dedupe(rows).forEach(r => { const div = document.createElement('div'); div.className = 'card'; div.innerHTML = `<div style="font-weight:700">${r.course} • ${r.day} ${r.start}–${r.end}</div><div class="sub">Location: ${r.location || 'TBA'} &nbsp; <span class="tag">${r.staff_name || 'Staff'}</span></div>`; list.appendChild(div); });
        $$('#course-filter .pill').forEach(p => p.addEventListener('click', () => { $$('#course-filter .pill').forEach(x => x.classList.toggle('active', x === p)); const c = p.dataset.course; Array.from(list.children).forEach(card => { const on = (c === 'ALL') || (card.textContent || '').includes(c); card.style.display = on ? '' : 'none'; }); }));
      })();

      /* LOGIN via server */
      (function () {
        const form = $('#login-form'); if (!form) return;
        const alert = $('#login-alert'), btn = $('#login-btn');
        const bad = m => { alert.className = 'alert alert-error'; alert.textContent = m; alert.classList.remove('hidden'); };
        const ok = () => { alert.classList.add('hidden'); alert.textContent = ''; };

        form.addEventListener('submit', async e => {
          e.preventDefault(); ok(); btn.disabled = true; btn.textContent = 'Signing in…';
          const login = $('#login-input').value.trim(), password = $('#password-input').value;
          if (!login || !password) { bad('Missing login or password'); btn.disabled = false; btn.textContent = 'Sign in'; return; }
          let session = null, err = '';
          try {
            let r = await fetch('/api/auth/login', { method: 'POST', credentials: 'include', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ login, password }) });
            let j = null; try { j = await r.clone().json() } catch { }
            if (!r.ok) throw new Error(j?.message || `${r.status}`);
            session = j;
          } catch (e) { err = String(e?.message || e); }
          if (!session) { bad(err || 'Login failed'); btn.disabled = false; btn.textContent = 'Sign in'; return; }
          try { localStorage.setItem('lap_auth_v1', JSON.stringify(session)); localStorage.setItem('lap_auth', JSON.stringify(session)); } catch { }
          document.getElementById('dashboard-tab')?.classList.remove('hidden');
          window.__lap_refreshAll?.();
          window.__lap_show?.('dashboard');
          btn.disabled = false; btn.textContent = 'Sign in';
        });
      })();

      /* ====== SCHEDULE (CRUD) ====== */

      // 🔧 prefer id-based targeting for edit/delete; fallback to composite if no id
      function idQuery(id) { return `id=eq.${encodeURIComponent(id)}`; }
      function compositeQuery(r) {
        const enc = v => encodeURIComponent(v ?? '');
        const parts = [];
        if (r.nuid) parts.push(`nuid=eq.${enc(r.nuid)}`);
        parts.push(`type=eq.${enc(r.type || 'office_hour')}`);
        parts.push(`course_code=eq.${enc(r.course_code || r.course || '')}`);
        parts.push(`day=eq.${enc(r.day || r.day_of_week || '')}`);
        parts.push(`start_time=eq.${enc(r.start_time || r.start || '')}`);
        parts.push(`end_time=eq.${enc(r.end_time || r.end || '')}`);
        parts.push(`location=eq.${enc(r.location || r.room || '')}`);
        return parts.join('&');
      }

      // READ
      window.loadSchedule = function () {
        (async () => {
          const tbody = $('#sched-table tbody'), alert = $('#sched-alert'); if (!tbody) return; tbody.innerHTML = '';
          const map = r => ({ id: r.id ?? null, nuid: r.nuid || null, course_code: (r.course_code || r.course || '').toString(), day: r.day || r.day_of_week || '', start_time: r.start_time || r.start || '', end_time: r.end_time || r.end || '', location: r.location || r.room || '', type: r.type || 'office_hour' });
          let data = [];
          try {
            const { URL, KEY } = SB(); if (URL && KEY) {
              const r = await fetch(`${URL}/rest/v1/staff_schedules?select=*&type=eq.office_hour&order=start_time.asc`, { headers: H(KEY) });
              if (r.ok) data = await r.json().catch(() => []);
            }
          } catch { }
          data = data.map(map);
          if (!data.length) { alert.className = 'alert alert-success'; alert.textContent = 'You have no office hours yet. Use the form above to add your first block.'; alert.classList.remove('hidden'); return; }
          alert.classList.add('hidden');

          data.forEach(r => {
            const tr = document.createElement('tr');
            tr.innerHTML = `<td>${r.course_code}</td><td>${r.day}</td><td>${r.start_time}</td><td>${r.end_time}</td><td>${r.location}</td>
      <td class="row-actions">
        <span class="badge">office_hour</span>
        <span class="link" data-edit>Edit</span>
        <span class="link" data-del>Delete</span>
      </td>`;
            tr.__row = r;
            tbody.appendChild(tr);
          });

          // edit
          $$('#sched-table [data-edit]').forEach(a => a.addEventListener('click', () => {
            const r = a.closest('tr').__row;
            $('#sched-course').value = r.course_code;
            $('#sched-day').value = r.day;
            $('#sched-location').value = r.location;
            $('#sched-start').value = (r.start_time || '').slice(0, 5);
            $('#sched-end').value = (r.end_time || '').slice(0, 5);
            $('#sched-type').value = r.type || 'office_hour';
            $('#sched-form').dataset.editingId = r.id ?? '';
            $('#sched-form').dataset.editingJson = JSON.stringify(r);
            $('#sched-save').textContent = 'Save changes';
            $('#sched-cancel').style.display = '';
            window.scrollTo({ top: document.getElementById('sched-form').offsetTop - 60, behavior: 'smooth' });
          }));

          // delete
          $$('#sched-table [data-del]').forEach(a => a.addEventListener('click', async () => {
            const row = a.closest('tr').__row;
            a.textContent = 'Deleting…'; a.style.pointerEvents = 'none';
            let ok = false, err = '';
            try {
              const { URL, KEY } = SB();
              let r;
              if (row.id != null) {
                r = await fetch(`${URL}/rest/v1/staff_schedules?${idQuery(row.id)}`, { method: 'DELETE', headers: H(KEY) });
              } else {
                r = await fetch(`${URL}/rest/v1/staff_schedules?${compositeQuery(row)}`, { method: 'DELETE', headers: H(KEY) });
              }
              ok = r.ok; if (!ok) { let j = null; try { j = await r.clone().json() } catch { } err = j?.message || j?.hint || j?.details || `${r.status}`; }
            } catch (e) { err = String(e?.message || e); }
            if (!ok) { a.textContent = 'Delete'; a.style.pointerEvents = 'auto'; alert.className = 'alert alert-error'; alert.textContent = `Could not delete. ${err}`; alert.classList.remove('hidden'); return; }
            loadSchedule();
          }));
        })()
      };

      // CREATE/UPDATE
      (function () {
        const form = $('#sched-form'); if (!form) return;
        const alert = $('#sched-alert'), btn = $('#sched-save'), cancel = $('#sched-cancel');

        cancel.addEventListener('click', () => { form.reset(); $('#sched-type').value = 'office_hour'; delete form.dataset.editingId; delete form.dataset.editingJson; btn.textContent = 'Add to schedule'; cancel.style.display = 'none'; });

        form.addEventListener('submit', async e => {
          e.preventDefault(); alert.classList.add('hidden'); btn.disabled = true;

          const payload = {
            course_code: $('#sched-course').value.trim(),
            day: $('#sched-day').value.trim(),
            start_time: toHHMMSS($('#sched-start').value.trim()),
            end_time: toHHMMSS($('#sched-end').value.trim()),
            location: $('#sched-location').value.trim(),
            type: $('#sched-type').value || 'office_hour'
          };
          if (!payload.course_code || !payload.day || !payload.start_time || !payload.end_time) {
            alert.className = 'alert alert-error'; alert.textContent = 'Course, day, start and end are required.';
            alert.classList.remove('hidden'); btn.disabled = false; return;
          }
          const u = getUser() || {}; if (u?.nuid) payload.nuid = String(u.nuid);

          const { URL, KEY } = SB(); if (!URL || !KEY) { alert.className = 'alert alert-error'; alert.textContent = 'Supabase not configured'; alert.classList.remove('hidden'); btn.disabled = false; return; }

          const editingId = form.dataset.editingId || '';
          const editingRow = form.dataset.editingJson ? JSON.parse(form.dataset.editingJson) : null;

          let ok = false, err = '';
          try {
            if (editingId) {
              const r = await fetch(`${URL}/rest/v1/staff_schedules?${idQuery(editingId)}`, { method: 'PATCH', headers: H(KEY), body: JSON.stringify(payload) });
              if (r.ok) { ok = true; }
              else {
                // fallback: insert new then delete old (by id if we have it; else composite)
                const i = await fetch(`${URL}/rest/v1/staff_schedules`, { method: 'POST', headers: H(KEY), body: JSON.stringify(payload) });
                if (i.ok) {
                  const del = await fetch(`${URL}/rest/v1/staff_schedules?${editingId ? idQuery(editingId) : compositeQuery(editingRow)}`, { method: 'DELETE', headers: H(KEY) });
                  ok = del.ok;
                } else {
                  let j = null; try { j = await i.clone().json() } catch { } err = j?.message || j?.hint || j?.details || `${i.status}`;
                }
              }
            } else {
              const r = await fetch(`${URL}/rest/v1/staff_schedules`, { method: 'POST', headers: H(KEY), body: JSON.stringify(payload) });
              ok = r.ok; if (!ok) { let j = null; try { j = await r.clone().json() } catch { } err = j?.message || j?.hint || j?.details || `${r.status} ${r.statusText}`; }
            }
          } catch (e) { err = String(e?.message || e); }

          if (!ok) { alert.className = 'alert alert-error'; alert.textContent = `Could not save office hour. ${err}`; alert.classList.remove('hidden'); btn.disabled = false; return; }

          form.reset(); $('#sched-type').value = 'office_hour'; btn.disabled = false; delete form.dataset.editingId; delete form.dataset.editingJson; btn.textContent = 'Add to schedule'; cancel.style.display = 'none';
          try { window.loadSchedule?.(); } catch { }
        });
      })();

      /* ====== FEEDBACK LIST (robust + fallback) ====== */
      window.loadMyFeedback = function () {
        (async () => {
          const list = $('#myfb-list'), alert = $('#myfb-alert'); if (!list) return; list.innerHTML = '';
          const u = (readSession().user) || {}; const { URL, KEY } = SB(); if (!URL || !KEY) { return; }
          const headers = H(KEY);

          async function coursesForUser() {
            // staff_public.courses (array)
            try {
              if (u.email) {
                const r = await fetch(`${URL}/rest/v1/staff_public?select=courses&email=eq.${encodeURIComponent(u.email)}`, { headers });
                if (r.ok) { const j = await r.json().catch(() => []); if (Array.isArray(j) && Array.isArray(j[0]?.courses)) return j[0].courses; }
              }
            } catch { }
            // staff_courses
            try {
              const tryCol = async c => (await fetch(`${URL}/rest/v1/staff_courses?select=${c}&limit=0`, { headers })).ok;
              let col = 'course'; if (await tryCol('course_code')) col = 'course_code';
              const by = u.nuid ? `staff_nuid=eq.${encodeURIComponent(u.nuid)}` : (u.email ? `staff_email=eq.${encodeURIComponent(u.email)}` : '');
              if (by) {
                const r = await fetch(`${URL}/rest/v1/staff_courses?select=${col}&${by}`, { headers });
                if (r.ok) { const j = await r.json().catch(() => []); return j.map(x => x[col]).filter(Boolean); }
              }
            } catch { }
            return [];
          }

          function buildOrForCourses(cs) {
            // or=(course.eq.A,course_code.eq.A,course.eq.B,course_code.eq.B)
            const parts = []; cs.forEach(c => { const ec = encodeURIComponent(String(c)); parts.push(`course.eq.${ec}`, `course_code.eq.${ec}`); });
            return parts.length ? `or=(${parts.join(',')})` : '';
          }

          let rows = [];
          try {
            if (isSLorAdmin()) {
              const r = await fetch(`${URL}/rest/v1/feedback?select=id,course,course_code,text,message,rating,created_at&order=created_at.desc.nullslast&limit=200`, { headers });
              if (r.ok) rows = await r.json().catch(() => []);
            } else {
              const cs = (await coursesForUser()).map(x => String(x).trim()).filter(Boolean);
              if (cs.length) {
                const r = await fetch(`${URL}/rest/v1/feedback?select=id,course,course_code,text,message,rating,created_at&${buildOrForCourses(cs)}&order=created_at.desc.nullslast&limit=200`, { headers });
                if (r.ok) rows = await r.json().catch(() => []);
                // fallback: if nothing came back (e.g. course lookup blocked), show recent 50 so UI isn't empty
                if (!rows.length) {
                  const f = await fetch(`${URL}/rest/v1/feedback?select=id,course,course_code,text,message,rating,created_at&order=created_at.desc.nullslast&limit=50`, { headers });
                  if (f.ok) rows = await f.json().catch(() => []);
                }
              } else {
                const r = await fetch(`${URL}/rest/v1/feedback?select=id,course,course_code,text,message,rating,created_at&order=created_at.desc.nullslast&limit=50`, { headers });
                if (r.ok) rows = await r.json().catch(() => []);
              }
            }
          } catch { }

          const uniq = new Map();
          rows.forEach(f => { const when = f.created_at ? new Date(f.created_at).toISOString().slice(0, 19) : ''; const course = String(f.course || f.course_code || '').trim().toUpperCase(); const text = String(f.text || f.message || '').trim(); const rating = f.rating ?? ''; const key = `${when}|${course}|${text}|${rating}`; if (!uniq.has(key)) uniq.set(key, f); });
          const items = Array.from(uniq.values()).sort((a, b) => new Date(b.created_at || 0) - new Date(a.created_at || 0));

          if (!items.length) { alert.className = 'alert alert-success'; alert.textContent = 'No feedback yet.'; alert.classList.remove('hidden'); return; }
          alert.classList.add('hidden');
          items.slice(0, 200).forEach(f => {
            const li = document.createElement('li');
            const when = f.created_at ? new Date(f.created_at).toLocaleString([], { dateStyle: 'medium', timeStyle: 'short' }) : '';
            const rating = f.rating ? ` • ★${f.rating}` : ''; const course = (f.course || f.course_code) ? ` • ${(f.course || f.course_code)}` : '';
            li.textContent = `${when}${course}${rating} — ${(f.text || f.message || '').trim()}`;
            list.appendChild(li);
          });
        })()
      };

      /* ====== SL ADMIN (unchanged from last working) ====== */
      window.loadAdmin = function () {
        (async () => {
          const body = $('#staff-table tbody'), empty = $('#staff-empty'); if (!body) return; body.innerHTML = '';
          const headersSup = k => ({ apikey: k, Authorization: `Bearer ${k}`, Accept: 'application/json', 'Content-Type': 'application/json' });
          const getCoursesFromUI = () => Array.from($('#staff-courses').selectedOptions || []).map(o => o.value);
          const setCoursesUI = (arr = []) => { const sel = $('#staff-courses'); if (!sel) return; Array.from(sel.options).forEach(o => o.selected = (arr || []).includes(o.value)); };

          async function detectCourseCol() {
            const { URL, KEY } = SB(); const headers = headersSup(KEY);
            const tryCol = async c => { const r = await fetch(`${URL}/rest/v1/staff_courses?select=${c}&limit=0`, { headers }); return r.ok; };
            if (await tryCol('course_code')) return 'course_code';
            if (await tryCol('course')) return 'course';
            if (await tryCol('course_name')) return 'course_name';
            if (await tryCol('course_id')) return 'course_id';
            return 'course';
          }

          async function replaceStaffCourses(nuid, courses) {
            const { URL, KEY } = SB(); const headers = headersSup(KEY);
            const col = await detectCourseCol();
            await fetch(`${URL}/rest/v1/staff_courses?staff_nuid=eq.${encodeURIComponent(nuid)}`, { method: 'DELETE', headers });
            if (Array.isArray(courses) && courses.length) {
              const rows = courses.map(c => ({ staff_nuid: nuid, [col]: String(c) }));
              const ins = await fetch(`${URL}/rest/v1/staff_courses`, { method: 'POST', headers, body: JSON.stringify(rows) });
              if (!ins.ok) { let j = null; try { j = await ins.clone().json() } catch { } throw new Error(j?.message || j?.hint || j?.details || `${ins.status}`); }
            }
          }

          function paint(rows) {
            body.innerHTML = '';
            if (!rows.length) { empty.className = 'alert alert-success'; empty.textContent = 'No staff found yet.'; empty.classList.remove('hidden'); return; }
            empty.classList.add('hidden');
            rows.forEach(s => {
              const tr = document.createElement('tr');
              tr.innerHTML = `<td>${s.nuid || ''}</td>
                      <td>${s.name || ''}</td>
                      <td>${s.email || ''}</td>
                      <td>${s.role || ''}</td>
                      <td>${Array.isArray(s.courses) ? s.courses.join(', ') : (s.course || '')}</td>
                      <td class="row-actions">
                        <span class="link" data-edit="${s.nuid || s.id || ''}" data-courses='${JSON.stringify(s.courses || [])}'>Edit</span>
                        <span class="link" data-rm="${s.nuid || s.id || ''}">Remove</span>
                      </td>`;
              body.appendChild(tr);
            });

            $$('#staff-table [data-edit]').forEach(a => a.addEventListener('click', () => {
              const tr = a.closest('tr');
              $('#staff-edit-id').value = a.getAttribute('data-edit');
              $('#staff-nuid').value = tr.children[0].textContent.trim();
              $('#staff-name').value = tr.children[1].textContent.trim();
              $('#staff-email').value = tr.children[2].textContent.trim();
              $('#staff-role').value = tr.children[3].textContent.trim();
              try { setCoursesUI(JSON.parse(a.getAttribute('data-courses') || '[]')); } catch { setCoursesUI([]); }
              window.scrollTo({ top: document.getElementById('staff-form').offsetTop - 60, behavior: 'smooth' });
            }));

            $$('#staff-table [data-rm]').forEach(a => a.addEventListener('click', async () => {
              const id = a.getAttribute('data-rm'); a.textContent = 'Removing…'; a.style.pointerEvents = 'none';
              let ok = false;
              try { const r = await fetch(`/api/admin/staff/${encodeURIComponent(id)}`, { method: 'DELETE', credentials: 'include' }); ok = r.ok; } catch { }
              if (!ok) {
                try {
                  const { URL, KEY } = SB(); const headers = headersSup(KEY);
                  await fetch(`${URL}/rest/v1/staff_courses?staff_nuid=eq.${encodeURIComponent(id)}`, { method: 'DELETE', headers });
                  const rr = await fetch(`${URL}/rest/v1/staff?nuid=eq.${encodeURIComponent(id)}`, { method: 'DELETE', headers });
                  ok = rr.ok;
                } catch { }
              }
              if (ok) loadAdmin(); else { a.textContent = 'Remove'; a.style.pointerEvents = 'auto'; }
            }));
          }

          let rows = [];
          try {
            const { URL, KEY } = SB(); const headers = headersSup(KEY);
            const [sp, sc] = await Promise.all([
              fetch(`${URL}/rest/v1/staff_public?select=nuid,name,email,role,courses,is_active&order=name.asc`, { headers }),
              fetch(`${URL}/rest/v1/staff_courses?select=staff_nuid,course,course_code,course_name`, { headers })
            ]);
            const staff = sp.ok ? await sp.json().catch(() => []) : [];
            const courses = sc.ok ? await sc.json().catch(() => []) : [];
            const map = {};
            courses.forEach(r => {
              const code = r.course_code ?? r.course ?? r.course_name ?? '';
              if (!code) return;
              if (!map[r.staff_nuid]) map[r.staff_nuid] = [];
              if (!map[r.staff_nuid].includes(code)) map[r.staff_nuid].push(String(code));
            });
            rows = staff.map(s => ({ ...s, courses: (map[s.nuid]?.slice().sort()) || s.courses || [] }));
          } catch { }
          paint(rows);

          (function () {
            const form = $('#staff-form'), alert = $('#staff-alert');
            const ok = m => { alert.className = 'alert alert-success'; alert.textContent = m; alert.classList.remove('hidden'); };
            const bad = m => { alert.className = 'alert alert-error'; alert.textContent = m; alert.classList.remove('hidden'); };
            $('#staff-cancel').addEventListener('click', () => { form.reset(); $('#staff-edit-id').value = ''; setCoursesUI([]); });

            form.addEventListener('submit', async e => {
              e.preventDefault(); alert.classList.add('hidden');
              const id = $('#staff-edit-id').value.trim();
              const payload = { nuid: $('#staff-nuid').value.trim(), name: $('#staff-name').value.trim(), email: $('#staff-email').value.trim(), role: $('#staff-role').value, is_active: true, courses: getCoursesFromUI() };
              if (!payload.nuid || !payload.name || !payload.role) return bad('NUID, name, and role are required.');

              let good = false, err = '';
              try {
                const r = await fetch(id ? `/api/admin/staff/${encodeURIComponent(id)}` : '/api/admin/staff', {
                  method: id ? 'PUT' : 'POST', credentials: 'include', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload)
                });
                good = r.ok; if (!good) { let j = null; try { j = await r.clone().json() } catch { } err = j?.message || ''; }
              } catch (e) { err = String(e?.message || e); }

              if (!good) {
                try {
                  const { URL, KEY } = SB(); const headers = headersSup(KEY);
                  if (id) {
                    const r = await fetch(`${URL}/rest/v1/staff?nuid=eq.${encodeURIComponent(id)}`, { method: 'PATCH', headers, body: JSON.stringify(payload) });
                    good = r.ok;
                  } else {
                    const r = await fetch(`${URL}/rest/v1/staff`, { method: 'POST', headers, body: JSON.stringify(payload) });
                    good = r.ok;
                  }
                  if (good) await (async () => { await replaceStaffCourses(payload.nuid, payload.courses) })();
                } catch (e) { err = String(e?.message || e); }
              }

              if (!good) return bad('Could not save staff' + (err ? `: ${err}` : ''));
              ok('Saved.'); form.reset(); $('#staff-edit-id').value = ''; setCoursesUI([]); loadAdmin();
            });
          })();
        })()
      };
    })();
  </script>
</body>

</html>